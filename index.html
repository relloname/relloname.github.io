<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì¼€íŒ… ì„±ê³¼ ì¢…í•© ë¦¬í¬íŠ¸ (4ì£¼)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>

@keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 2px 4px rgba(0,123,255,0.3); }
    50% { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,123,255,0.5); }
    100% { transform: scale(1); box-shadow: 0 2px 4px rgba(0,123,255,0.3); }
}

/* ì´ í´ë˜ìŠ¤ê°€ ìˆì„ ë•Œë§Œ ì• ë‹ˆë©”ì´ì…˜ ì‘ë™ */
.active-pulse {
    animation: pulse 2s infinite;
}


        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 2200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #007bff; padding-bottom: 15px; }
        .header-title-group { display: flex; align-items: baseline; gap: 15px; }
        .header h1 { font-size: 32px; color: #333; font-weight: bold; }
        .header-date { font-size: 14px; color: #666; font-weight: normal; background: #f0f0f0; padding: 4px 10px; border-radius: 12px; }
        
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #ddd; flex-wrap: wrap; }
        .nav-tabs button { padding: 12px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .nav-tabs button:hover { color: #007bff; }
        .nav-tabs button.active { color: #007bff; border-bottom-color: #007bff; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Dropdown styles */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-toggle { padding: 12px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s; display: flex; align-items: center; gap: 5px; }
        .dropdown-toggle:hover { color: #007bff; }
        .dropdown-toggle.active { color: #007bff; border-bottom-color: #007bff; font-weight: bold; }
        .dropdown-toggle::after { content: 'â–¼'; font-size: 10px; margin-left: 5px; }
        .dropdown-content { display: none; position: absolute; background-color: #fff; min-width: 180px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); z-index: 1000; border-radius: 4px; margin-top: 3px; }
        .dropdown-content a { color: #333; padding: 12px 16px; text-decoration: none; display: block; cursor: pointer; transition: background 0.2s; }
        .dropdown-content a:hover { background-color: #f1f1f1; }
        .dropdown:hover .dropdown-content { display: block; }
        
        .section { margin-bottom: 50px; }
        .section-title { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #007bff; display:flex; justify-content: space-between; align-items: center; gap:12px; }
        .controls { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .controls input, .controls select, .controls button { padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; height: 36px; }
        .controls select { max-width: 160px; }
        .controls button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; transition: background-color 0.3s; white-space: nowrap; }
        .controls button:hover { background-color: #0056b3; }
        .controls button.danger { background-color: #dc3545; }
        .controls button.danger:hover { background-color: #c82333; }
        .controls button.secondary { background: #6c757d; color: #fff; }
        .controls button.secondary:hover { background: #5a6268; }
        .controls button.btn-compact { padding: 8px 8px; font-size: 11px; letter-spacing: -0.5px; }
        
        .info-box { background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin-bottom: 20px; border-radius: 4px; font-size: 13px; }
        .status { padding: 15px; border-radius: 4px; margin-top: 15px; display: none; font-weight: bold; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        /* ê°€ì´ë“œ ë””ìì¸ ìŠ¤íƒ€ì¼ */
        .guide-wrapper { margin: 20px 0; display: flex; flex-direction: column; gap: 12px; }
        .guide-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; }
        .guide-header { font-size: 13px; font-weight: bold; color: #475569; margin-bottom: 10px; display: block; text-align: left; }
        .tag-container-row { display: flex; align-items: flex-start; gap: 15px; flex-wrap: wrap; }
        .tag-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .tag-item { 
            display: flex; align-items: center; border: 1px solid #d1d5db; border-radius: 3px; 
            background: white; padding: 0 6px; min-width: 115px; height: 28px;
            position: relative; overflow: hidden;
        }
        .tag-bar-blue { position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: #3b82f6; }
        .tag-bar-green { position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: #22c55e; }
        .tag-text { color: #333; font-size: 11px; flex-grow: 1; white-space: nowrap; margin-left: 4px; }
        .guide-v-line { width: 1px; background-color: #f1f5f9; align-self: stretch; }
        
        .table-wrapper { overflow-x: auto; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; max-height: 700px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: auto; font-variant-numeric: tabular-nums; }
        th { padding: 10px 6px; text-align: left; font-weight: bold; color: white; background: #007bff; border-bottom: 2px solid #0056b3; white-space: nowrap; position: sticky; top: 0; cursor: pointer; user-select: none; z-index: 10; }
        td { padding: 8px 6px; border-bottom: 1px solid #eee; text-align: left; }
        th:hover { background: #0056b3; }
        th.sort-asc::after { content: ' â–²'; }
        th.sort-desc::after { content: ' â–¼'; }
        td.number, th.number { white-space: nowrap; text-align: left; }
        td.number .value-wrapper { display: inline-block; text-align: left; }
        td.number .badge-mini { display: inline-block; margin-left: 4px; text-align: left; }
        .text-col { max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        tr:hover { background: #f9f9f9; }
        tr.filtered-out { display: none !important; }
        tr.low-roas { background-color: #ffecec !important; }
        tr.total-row, tr.prev-total-row { background-color: #e3f2fd !important; font-weight: bold; border-bottom: 2px solid #bbdefb; }
        tr.total-row td, tr.prev-total-row td { color: #0d47a1; }
        tr.total-row:hover, tr.prev-total-row:hover { background-color: #bbdefb !important; }
        .no-data { text-align: center; padding: 40px 20px; color: #999; font-size: 16px; }
        .rank-badge { display: inline-block; width: 24px; height: 24px; line-height: 24px; border-radius: 50%; background: #007bff; color: white; font-weight: bold; font-size: 11px; text-align: center; }
        
        .detail-row { background: #f7fbff; }
        .detail-row td div { display: flex; flex-wrap: nowrap; gap: 12px; align-items: center; width: 100%; padding: 6px 4px; font-size: 11px; color: #444; white-space: nowrap; }
        .detail-row strong { margin-right: 8px; color: #333; font-size: 12px; min-width: 80px; }
        .badge-mini { font-size: 11px; color: #666; margin-left: 4px; white-space: nowrap; }
        .hide-changes .badge-mini { display: none !important; }
        .pagination { display: flex; gap: 8px; align-items: center; font-size: 12px; margin: 10px 0; }
        .pagination button { padding: 6px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .chart-container { background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 30px; border: 1px solid #ddd; }
        .chart-wrapper { position: relative; height: 220px; width: 100%; }
        /* 4ê°œì”© 3ì¤„ */
        .chart-grid { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 20px; row-gap: 32px; }
        .chart-caption { font-size: 12px; color: #444; margin-bottom: 4px; }
        .two-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(520px, 1fr)); gap: 16px; }

        /* ì¹´ë“œ 6ê°œì”© 2ì¤„ */
        .stat-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 40px; }
        .stat-card { background: #f9fafb; border: 1px solid #e3e6ea; border-radius: 8px; padding: 16px; min-height: 140px; display: flex; flex-direction: column; gap: 12px; }
        .stat-title { font-size: 13px; font-weight: 700; color: #444; }
        .stat-value-main { font-size: 28px; font-weight: 800; color: #111; }
        .delta-box { background: #fff; border: 1px solid #e3e6ea; border-radius: 6px; padding: 10px 12px; display: flex; flex-direction: column; gap: 8px; }
        .delta-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #444; }
        .delta-label { color: #444; }
        .delta-val { font-weight: 700; }
        .delta-up { color: #2e8b57; }
        .delta-down { color: #c0392b; }
        .delta-icon { margin-right: 6px; font-weight: 900; }

        /* Simulator cards */
        .sim-card { background: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 15px; transition: all 0.2s ease; }
        .sim-card:hover { background: #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transform: translateY(-2px); }

        /* ìˆœìœ„ ë¶„ì„ ìŠ¤íƒ€ì¼ */
        .rank-heatmap-table th, .rank-heatmap-table td { text-align: center; border: 1px solid #eee; padding: 8px; font-size: 11px; }
        .rank-heatmap-table th { background: #f8f9fa; font-weight: bold; }


/* ì‡¼í•‘ ê°€ì´ë“œ ì „ìš© ìŠ¤íƒ€ì¼ */
.shop-guide-wrapper { margin-top: 15px; margin-bottom: 25px; }
.shop-guide-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
.shop-guide-header { font-size: 14px; font-weight: bold; color: #334155; margin-bottom: 12px; display: block; }
.shop-path-box { background: #f1f5f9; border: 1px dashed #94a3b8; padding: 12px; border-radius: 6px; font-size: 13px; color: #1e293b; margin-bottom: 15px; line-height: 1.5; }
.tag-container-row { display: flex; align-items: flex-start; gap: 25px; flex-wrap: wrap; }
.tag-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
.tag-item { 
    display: flex; align-items: center; border: 1px solid #cbd5e1; border-radius: 4px; 
    background: white; padding: 0 8px; min-width: 120px; height: 32px;
    position: relative; overflow: hidden;
}
.tag-bar-blue { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #3b82f6; }
.tag-bar-green { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #22c55e; }
.tag-text { color: #334155; font-size: 12px; flex-grow: 1; margin-left: 6px; font-weight: 500; }
.guide-v-line { width: 1px; background-color: #e2e8f0; align-self: stretch; }

    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-title-group">
            <h1>ğŸ“Š ë§ˆì¼€íŒ… ì„±ê³¼ ì¢…í•© ë¦¬í¬íŠ¸ (ìµœê·¼ 4ì£¼)</h1>
            <span id="mainDateRange" class="header-date"></span>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <button id="captureBtn" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(220,53,69,0.3); transition: all 0.2s;" onclick="captureReport()">
                <span style="font-size: 16px;">ğŸ“¸</span>
                <span>ìº¡ì²˜</span>
            </button>
<button id="uploadBtn" 
        style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,123,255,0.3); transition: all 0.2s; 
               animation: pulse 2s 10;" 
        onclick="showUploadPage()">
    <span style="font-size: 16px;">ğŸ“¤</span>
    <span>ë°ì´í„° ì—…ë¡œë“œ</span>
</button>
        </div>
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab(event, 'overview')">ğŸ“ˆ ì„±ê³¼ ìš”ì•½</button>
        <div class="dropdown">
            <button class="dropdown-toggle tab-btn" id="dayweekDropdown">ğŸ“… ì¼ë³„/ì£¼ë³„ ë¶„ì„</button>
            <div class="dropdown-content">
                <a onclick="switchTab(event, 'dayweek-day')">ğŸ“† ì¼ë³„ ë¶„ì„</a>
                <a onclick="switchTab(event, 'dayweek-week')">ğŸ“… ì£¼ë³„ ë¶„ì„</a>
            </div>
        </div>
        <button class="tab-btn" onclick="switchTab(event, 'rank')">ğŸ† ìˆœìœ„ ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'campaign')">ğŸ¯ ìº í˜ì¸ ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'adgroup')">ğŸ§© ê´‘ê³ ê·¸ë£¹ ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'keyword')">ğŸ” í‚¤ì›Œë“œ ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'media')">ğŸ“° ë§¤ì²´ë³„ ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'timeanalysis')">â° ì‹œê°„ëŒ€ ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'efficiency')">âš¡ íš¨ìœ¨ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'cpc')">ğŸ’² CPC ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'device')">ğŸ“± ë””ë°”ì´ìŠ¤ ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'shopping')">ğŸ›ï¸ ì‡¼í•‘ ëŒ€ì‹œë³´ë“œ</button>
        <button class="tab-btn" onclick="switchTab(event, 'simulator')">ğŸ¯ ê´‘ê³  ì‹œë®¬ë ˆì´í„°</button>
    </div>

    <!-- TAB 1: Overview (now first and active) -->
    <div id="overview" class="tab-content active">
        <div class="section" id="section-overview">
            <div class="section-title">
                <span>ğŸ“ˆ ì„±ê³¼ ìš”ì•½</span>
            </div>
            <div id="statsContainer" class="stat-grid"></div>
            
            <!-- ì£¼ê°„ ì¶”ì´ ì°¨íŠ¸ -->
            <div class="chart-container">
                <h3 id="weekCompareTitle" style="margin-bottom: 16px;">ì£¼ê°„ ì„±ê³¼ ì¶”ì´ (ìµœê·¼ 4ì£¼)</h3>
                <div class="chart-grid" id="overviewCharts"></div>
            </div>

            <!-- ì„±ê³¼ ë¹„ì¤‘ ë¶„ì„ -->
            <div class="chart-container" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸ“Š í•­ëª©ë³„ ì„±ê³¼ ë¹„ì¤‘ ë¶„ì„ (100%)</h3>
                    <div class="controls" style="margin: 0;">
                        <select id="stackChartType" onchange="updateStackedChart()">
                            <option value="campaignType">ìº í˜ì¸ ìœ í˜•ë³„</option>
                            <option value="campaign" selected>ìº í˜ì¸ë³„</option>
                            <option value="adgroup">ê´‘ê³ ê·¸ë£¹ë³„</option>
                            <option value="device">ë””ë°”ì´ìŠ¤ë³„</option>
                        </select>
                        <select id="stackLimit" onchange="updateStackedChart()">
                            <option value="0" selected>ì „ì²´ ë³´ê¸°</option>
                            <option value="5">ìƒìœ„ 5ê°œ</option>
                            <option value="10">ìƒìœ„ 10ê°œ</option>
                            <option value="20">ìƒìœ„ 20ê°œ</option>
                        </select>
                    </div>
                </div>
                <div class="chart-wrapper" style="height: 400px;">
                    <canvas id="stackedBarChart"></canvas>
                </div>
                <p style="font-size:12px; color:#666; text-align:right; margin-top:5px;">* ì°¨íŠ¸ì˜ ë§‰ëŒ€ë‚˜ ë²”ë¡€ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ í•­ëª©ì´ ê°•ì¡°ë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <!-- TAB 2: Upload (hidden by default, shown when button clicked) -->
    <div id="upload" class="tab-content">
        <div class="section" id="section-upload">
            <div class="section-title">
                <span>ğŸ“¤ ë°ì´í„° ì—…ë¡œë“œ</span>
            </div>
            <div class="info-box">
                ğŸ’¡ ë„¤ì´ë²„ê´‘ê³  ë‹¤ì°¨ì›ë³´ê³ ì„œ 4ì£¼ê°„ CSV íŒŒì¼ 2ê°œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.<br>
            </div>
            
            <!-- ê°€ì´ë“œ ì„¹ì…˜ -->
<div class="guide-wrapper">
    <div class="guide-card">
        <span class="guide-header">ğŸ“Œ RAW1 ì—…ë¡œë“œ ê°€ì´ë“œ - ì§€ë‚œ 4ì£¼ (ê°€ì´ë“œ í™”ë©´ê³¼ í•­ëª©-ìˆœì„œ ì¼ì¹˜ í•„ìˆ˜)</span>
        <div class="tag-container-row">
            <div class="tag-grid">
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ì¼ë³„</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ì£¼ë³„</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ìº í˜ì¸ ìœ í˜•</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ìº í˜ì¸</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ê´‘ê³ ê·¸ë£¹</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ì‹œê°„ëŒ€ë³„</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ìš”ì¼ë³„</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ë§¤ì²´ì´ë¦„</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">PC-ëª¨ë°”ì¼</span></div>
            </div>
            <div class="guide-v-line"></div>
            <div class="tag-grid">
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">ì´ë¹„ìš©</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">ë…¸ì¶œìˆ˜</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">í´ë¦­ìˆ˜</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">ì „í™˜ìˆ˜</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">ì „í™˜ë§¤ì¶œì•¡</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">í‰ê· ë…¸ì¶œìˆœìœ„</span></div>
            </div>
        </div>
    </div>

    <div class="guide-card">
        <span class="guide-header">ğŸ“Œ RAW2 ì—…ë¡œë“œ ê°€ì´ë“œ(ê²€ìƒ‰ì–´ í¬í•¨)  - ì§€ë‚œ 4ì£¼ (ê°€ì´ë“œ í™”ë©´ê³¼ í•­ëª©-ìˆœì„œ ì¼ì¹˜ í•„ìˆ˜)</span>
        <div class="tag-container-row">
            <div class="tag-grid">
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ì¼ë³„</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ì£¼ë³„</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ìº í˜ì¸ ìœ í˜•</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ìº í˜ì¸</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ê´‘ê³ ê·¸ë£¹</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ê²€ìƒ‰ì–´</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ë§¤ì²´ì´ë¦„</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">PC-ëª¨ë°”ì¼</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ê²€ìƒ‰-ì½˜í…ì¸ </span></div>
            </div>
            <div class="guide-v-line"></div>
            <div class="tag-grid">
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">ì´ë¹„ìš©</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">ë…¸ì¶œìˆ˜</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">í´ë¦­ìˆ˜</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">ì „í™˜ìˆ˜</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">ì „í™˜ë§¤ì¶œì•¡</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">í‰ê· ë…¸ì¶œìˆœìœ„</span></div>
            </div>
        </div>
    </div>
</div>            
            <div class="controls" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div id="dropZone1" class="drop-zone" style="border: 2px dashed #007bff; border-radius: 8px; padding: 30px; text-align: center; background: #f8f9fa; cursor: pointer; transition: all 0.3s;">
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">ğŸ“ RAW1 (ì¼ë°˜)</div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 15px;">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                    <input type="file" id="fileInputRaw" accept=".csv,.xlsx,.xls" onchange="handleUpload(event, 'raw')" style="display: none;">
                    <button onclick="event.stopPropagation(); document.getElementById('fileInputRaw').click()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">íŒŒì¼ ì„ íƒ</button>
                    <div id="fileName1" style="margin-top: 10px; font-size: 12px; color: #28a745; font-weight: bold;"></div>
                </div>
                <div id="dropZone2" class="drop-zone" style="border: 2px dashed #007bff; border-radius: 8px; padding: 30px; text-align: center; background: #f8f9fa; cursor: pointer; transition: all 0.3s;">
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">ğŸ“ RAW2 (ê²€ìƒ‰ì–´)</div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 15px;">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                    <input type="file" id="fileInputRaw2" accept=".csv,.xlsx,.xls" onchange="handleUpload(event, 'raw2')" style="display: none;">
                    <button onclick="event.stopPropagation(); document.getElementById('fileInputRaw2').click()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">íŒŒì¼ ì„ íƒ</button>
                    <div id="fileName2" style="margin-top: 10px; font-size: 12px; color: #28a745; font-weight: bold;"></div>
                </div>
            </div>
            <div id="uploadStatus" class="status"></div>
            <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <div style="margin-top: 10px; font-weight: bold; color: #007bff;">íŒŒì¼ ë¶„ì„ ì¤‘...</div>
            </div>
            <style>
                @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                .drop-zone.dragover { background: #e3f2fd; border-color: #0056b3; transform: scale(1.02); }
            </style>
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 4px;">
                <strong>ğŸ“Š ì—…ë¡œë“œëœ ë°ì´í„° í†µê³„ (ìš”ì•½):</strong>
                <div id="uploadStats" style="margin-top: 15px; color: #666; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px;">
                    <div>ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB New: Rank Analysis -->
    <div id="rank" class="tab-content">
        <div class="section">
            <div class="section-title">
                <span>ğŸ† ìˆœìœ„ ë¶„ì„</span>
            </div>
            <div class="rank-panel" style="margin-bottom:20px; background:#fff; border:1px solid #ddd; padding:20px; border-radius:8px;">
                <h3>ğŸ“‰ ê²€ìƒ‰ì–´ë³„ ìˆœìœ„ ì¶”ì´ (ìµœê·¼ 14ì¼)</h3>
                <p style="font-size:12px; color:#666; margin:10px 0;">â€» ê²€ìƒ‰ì–´ ì…ë ¥ê³¼ í•„í„°ë¥¼ ì„ íƒí•˜ì—¬ ì¡°íšŒ ì‹œ ë…¸ì¶œ ìˆœìœ„ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="controls" style="margin-top:10px;">
                    <select id="trendCT" onchange="updateRankTrend()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                    <select id="trendCamp" onchange="updateRankTrend()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                    <select id="trendAdg" onchange="updateRankTrend()"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                    <select id="trendMedia" onchange="updateRankTrend()"><option value="">ë§¤ì²´ ì „ì²´</option></select>
                    <input type="text" id="trendKw" placeholder="ê²€ìƒ‰ì–´ (ì‰¼í‘œë¡œ êµ¬ë¶„: í‚¤ì›Œë“œ1, í‚¤ì›Œë“œ2)" style="width:300px;" onchange="updateRankTrend()">
                    <button onclick="updateRankTrend()">ì¡°íšŒ</button>
                    <button class="danger" onclick="resetRankTrend()">ì´ˆê¸°í™”</button>
                </div>
                <div id="rankSummary" style="display:none; margin:15px 0; padding:12px; background:#f8f9fa; border-radius:6px; display:flex; gap:20px; justify-content:center; font-size:13px;">
                    <div><strong>ìµœì € ìˆœìœ„:</strong> <span id="minRank" style="color:#dc3545;">-</span></div>
                    <div><strong>ìµœê³  ìˆœìœ„:</strong> <span id="maxRank" style="color:#28a745;">-</span></div>
                    <div><strong>í‰ê·  ìˆœìœ„:</strong> <span id="avgRank" style="color:#007bff;">-</span></div>
                </div>
                <div style="height:350px;">
                    <canvas id="rankTrendChart"></canvas>
                </div>
            </div>

            <div class="rank-panel" style="background:#fff; border:1px solid #ddd; padding:20px; border-radius:8px;">
                <h3>â° ì‹œê°„ëŒ€/ìš”ì¼ë³„ í‰ê·  ìˆœìœ„ (Heatmap)
                <p style="font-size:12px; color:#666; margin:10px 0;">â€» ì‹œê°„ëŒ€/ìš”ì¼ë³„ í‰ê·  ìˆœìœ„ì˜ ê²½ìš° í•„í„°ë¥¼ ì„ íƒí•˜ì—¬ ë¶„ì„ ì‹œ íˆíŠ¸ë§µì„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="controls" style="margin-top:10px;">
                    <select id="heatCT" onchange="updateRankHeatmap()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                    <select id="heatCamp" onchange="updateRankHeatmap()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                    <select id="heatAdg" onchange="updateRankHeatmap()"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                    <select id="heatMedia" onchange="updateRankHeatmap()"><option value="">ë§¤ì²´ ì „ì²´</option></select>
                    <span style="margin-left:10px; font-weight:bold;">ê¸°ê°„:</span>
                    <button id="heatWeek0" class="secondary" style="background:#007bff;" onclick="setHeatmapWeek(0)">ì§€ë‚œì£¼</button>
                    <button id="heatWeek1" class="secondary" onclick="setHeatmapWeek(1)">2ì£¼ì „</button>
                    <button id="heatWeek2" class="secondary" onclick="setHeatmapWeek(2)">3ì£¼ì „</button>
                    <button id="heatWeek3" class="secondary" onclick="setHeatmapWeek(3)">4ì£¼ì „</button>
                    <button onclick="updateRankHeatmap()">ë¶„ì„</button>
                </div>
                <div id="rankHeatmapContainer" style="overflow-x:auto; margin-top:15px;">
                    <p style="padding:20px; text-align:center; color:#999;">ë°ì´í„°ë¥¼ í•„í„°ë§í•˜ê³  'ë¶„ì„' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìˆœìœ„í‘œê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 3: Campaign -->
    <div id="campaign" class="tab-content">
        <div class="section" id="section-campaign">
            <div class="section-title">
                <span>ğŸ¯ ìº í˜ì¸ ì„±ê³¼ ë¶„ì„</span>
            </div>
            <div class="controls">
                <input class="text-col" type="text" id="campaignFilter" placeholder="ìº í˜ì¸ ê²€ìƒ‰" onkeyup="updateCampaignTable()">
                <select id="campaignTypeFilter" onchange="updateCampaignTable()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                <select id="campaignDeviceFilter" onchange="updateCampaignTable()"><option value="">ì „ì²´ ë””ë°”ì´ìŠ¤</option><option value="PC">PC</option><option value="ëª¨ë°”ì¼">ëª¨ë°”ì¼</option></select>
                <select id="campaignCampaignFilter" onchange="updateCampaignTable()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                <select id="campaignAdgroupFilter" onchange="updateCampaignTable()"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                <input type="number" id="standardROAS" placeholder="ROAS ê¸°ì¤€ %" min="0" step="10">
                <button onclick="highlightLowROAS('campaignBody', 'standardROAS')">ROAS ì ìš©</button>
                <button class="filter-red" onclick="filterRedRows('campaignBody')">í•„í„°ë§</button>
                <button class="roas-up" onclick="applyROASFilter('campaignBody', 'up', 'standardROAS')">â†‘</button>
                <button class="roas-down" onclick="applyROASFilter('campaignBody', 'down', 'standardROAS')">â†“</button>
                <button class="danger" onclick="resetCampaign()">ì´ˆê¸°í™”</button>
                <button class="secondary" onclick="toggleChangeBadge('campaignTable')">ì¦ê°ìœ¨ On/Off</button>
            </div>
            <div class="table-wrapper">
                <table id="campaignTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('campaignTable', 0)">ìˆœìœ„</th>
                        <th onclick="sortTable('campaignTable', 1)">ìº í˜ì¸</th>
                        <th onclick="sortTable('campaignTable', 2)">ìº í˜ì¸ìœ í˜•</th>
                        <th onclick="sortTable('campaignTable', 3)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('campaignTable', 4)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('campaignTable', 5)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('campaignTable', 6)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('campaignTable', 7)" class="number">CPC</th>
                        <th onclick="sortTable('campaignTable', 8)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('campaignTable', 9)" class="number">ì „í™˜ìœ¨</th>
                        <th onclick="sortTable('campaignTable', 10)" class="number">ë§¤ì¶œì•¡</th>
                        <th onclick="sortTable('campaignTable', 11)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                        <th onclick="sortTable('campaignTable', 12)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="campaignBody">
                    <tr><td colspan="13" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB 4: Adgroup -->
    <div id="adgroup" class="tab-content">
        <div class="section" id="section-adgroup">
            <div class="section-title">
                <span>ğŸ§© ê´‘ê³ ê·¸ë£¹ ì„±ê³¼ ë¶„ì„</span>
            </div>
            <div class="controls">
                <input class="text-col" type="text" id="adgroupFilter" placeholder="ê´‘ê³ ê·¸ë£¹ ê²€ìƒ‰" onkeyup="updateAdgroupTable()">
                <select id="adgroupCampaignFilter" onchange="updateAdgroupTable()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                <select id="adgroupCampaignTypeFilter" onchange="updateAdgroupTable()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                <select id="adgroupDeviceFilter" onchange="updateAdgroupTable()"><option value="">ì „ì²´ ë””ë°”ì´ìŠ¤</option><option value="PC">PC</option><option value="ëª¨ë°”ì¼">ëª¨ë°”ì¼</option></select>
                <input type="number" id="standardROAS_AG" placeholder="ROAS ê¸°ì¤€ %" min="0" step="10">
                <button onclick="highlightLowROAS('adgroupBody', 'standardROAS_AG')">ROAS ì ìš©</button>
                <button class="filter-red" onclick="filterRedRows('adgroupBody')">í•„í„°ë§</button>
                <button class="roas-up" onclick="applyROASFilter('adgroupBody', 'up', 'standardROAS_AG')">â†‘</button>
                <button class="roas-down" onclick="applyROASFilter('adgroupBody', 'down', 'standardROAS_AG')">â†“</button>
                <button class="danger" onclick="resetAdgroup()">ì´ˆê¸°í™”</button>
                <button class="secondary" onclick="toggleChangeBadge('adgroupTable')">ì¦ê°ìœ¨ On/Off</button>
            </div>
            <div class="table-wrapper">
                <table id="adgroupTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('adgroupTable', 0)">ìˆœìœ„</th>
                        <th onclick="sortTable('adgroupTable', 1)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('adgroupTable', 2)">ìº í˜ì¸</th>
                        <th onclick="sortTable('adgroupTable', 3)">ìº í˜ì¸ìœ í˜•</th>
                        <th onclick="sortTable('adgroupTable', 4)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('adgroupTable', 5)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('adgroupTable', 6)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('adgroupTable', 7)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('adgroupTable', 8)" class="number">CPC</th>
                        <th onclick="sortTable('adgroupTable', 9)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('adgroupTable', 10)" class="number">ì „í™˜ìœ¨</th>
                        <th onclick="sortTable('adgroupTable', 11)" class="number">ë§¤ì¶œì•¡</th>
                        <th onclick="sortTable('adgroupTable', 12)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                        <th onclick="sortTable('adgroupTable', 13)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="adgroupBody">
                    <tr><td colspan="14" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB 5: Keyword -->
    <div id="keyword" class="tab-content">
        <div class="section" id="section-keyword">
            <div class="section-title">
                <span>ğŸ” í‚¤ì›Œë“œ ì„±ê³¼ ë¶„ì„</span>
            </div>
            <div class="controls">
                <input class="text-col" type="text" id="keywordSearch" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰" onkeyup="updateKeywordTable(true)">
                <select id="keywordCampaignTypeFilter" onchange="updateKeywordTable(true)"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                <select id="keywordCampaignFilter" onchange="updateKeywordTable(true)"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                <select id="keywordAdgroupFilter" onchange="updateKeywordTable(true)"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                <select id="deviceFilter" onchange="updateKeywordTable(true)"><option value="">ì „ì²´ ë””ë°”ì´ìŠ¤</option><option value="PC">PC</option><option value="ëª¨ë°”ì¼">ëª¨ë°”ì¼</option></select>
                <input type="number" id="standardROAS2" placeholder="ROAS ê¸°ì¤€ %" min="0" step="10">
                <button onclick="highlightLowROAS('keywordBody', 'standardROAS2')">ROAS ì ìš©</button>
                <button class="filter-red" onclick="filterRedRows('keywordBody')">í•„í„°ë§</button>
                <button class="roas-up" onclick="applyROASFilter('keywordBody', 'up', 'standardROAS2')">â†‘</button>
                <button class="roas-down" onclick="applyROASFilter('keywordBody', 'down', 'standardROAS2')">â†“</button>
                <button class="danger" onclick="resetKeyword()">ì´ˆê¸°í™”</button>
                <button class="secondary" onclick="toggleChangeBadge('keywordTable')">ì¦ê°ìœ¨ On/Off</button>
            </div>
            <div class="pagination">
                <button id="kwPrev" onclick="changeKeywordPage(-1)">ì´ì „</button>
                <span id="kwPageInfo">0 / 0</span>
                <button id="kwNext" onclick="changeKeywordPage(1)">ë‹¤ìŒ</button>
            </div>
            <div class="table-wrapper">
                <table id="keywordTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('keywordTable', 0)">ìˆœìœ„</th>
                        <th onclick="sortTable('keywordTable', 1)">ê²€ìƒ‰ì–´</th>
                        <th onclick="sortTable('keywordTable', 2)">ìº í˜ì¸</th>
                        <th onclick="sortTable('keywordTable', 3)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('keywordTable', 4)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('keywordTable', 5)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('keywordTable', 6)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('keywordTable', 7)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('keywordTable', 8)" class="number">CPC</th>
                        <th onclick="sortTable('keywordTable', 9)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('keywordTable', 10)" class="number">ì „í™˜ìœ¨</th>
                        <th onclick="sortTable('keywordTable', 11)" class="number">ë§¤ì¶œì•¡</th>
                        <th onclick="sortTable('keywordTable', 12)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                        <th onclick="sortTable('keywordTable', 13)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="keywordBody">
                    <tr><td colspan="14" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB 6: Media -->
    <div id="media" class="tab-content">
        <div class="section" id="section-media">
            <div class="section-title">
                <span>ğŸ“° ë§¤ì²´ë³„ ë¶„ì„</span>
            </div>
            <div class="controls">
                <input class="text-col" type="text" id="mediaFilter" placeholder="ë§¤ì²´ ê²€ìƒ‰" onkeyup="updateMediaTable()">
                <select id="mediaCampaignTypeFilter" onchange="updateMediaTable()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                <select id="mediaCampaignFilter" onchange="updateMediaTable()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                <select id="mediaAdgroupFilter" onchange="updateMediaTable()"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                <select id="mediaDeviceFilter" onchange="updateMediaTable()"><option value="">ì „ì²´ ë””ë°”ì´ìŠ¤</option><option value="PC">PC</option><option value="ëª¨ë°”ì¼">ëª¨ë°”ì¼</option></select>
                <input type="number" id="standardROAS_MEDIA" placeholder="ROAS ê¸°ì¤€ %" min="0" step="10">
                <button onclick="highlightLowROAS('mediaBody', 'standardROAS_MEDIA')">ROAS ì ìš©</button>
                <button class="filter-red" onclick="filterRedRows('mediaBody')">í•„í„°ë§</button>
                <button class="roas-up" onclick="applyROASFilter('mediaBody', 'up', 'standardROAS_MEDIA')">â†‘</button>
                <button class="roas-down" onclick="applyROASFilter('mediaBody', 'down', 'standardROAS_MEDIA')">â†“</button>
                <button class="danger" onclick="resetMedia()">ì´ˆê¸°í™”</button>
                <button class="secondary" onclick="toggleChangeBadge('mediaTable')">ì¦ê°ìœ¨ On/Off</button>
            </div>
            <div class="table-wrapper">
                <table id="mediaTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('mediaTable', 0)">ìˆœìœ„</th>
                        <th onclick="sortTable('mediaTable', 1)">ë§¤ì²´</th>
                        <th onclick="sortTable('mediaTable', 2)">ìº í˜ì¸</th>
                        <th onclick="sortTable('mediaTable', 3)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('mediaTable', 4)">ë””ë°”ì´ìŠ¤</th>
                        <th onclick="sortTable('mediaTable', 5)">ìº í˜ì¸ìœ í˜•</th>
                        <th onclick="sortTable('mediaTable', 6)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('mediaTable', 7)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('mediaTable', 8)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('mediaTable', 9)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('mediaTable', 10)" class="number">CPC</th>
                        <th onclick="sortTable('mediaTable', 11)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('mediaTable', 12)" class="number">ì „í™˜ìœ¨</th>
                        <th onclick="sortTable('mediaTable', 13)" class="number">ë§¤ì¶œì•¡</th>
                        <th onclick="sortTable('mediaTable', 14)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                        <th onclick="sortTable('mediaTable', 15)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="mediaBody">
                    <tr><td colspan="16" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB: Time Analysis (ì‹œê°„ëŒ€ ë¶„ì„) -->
    <div id="timeanalysis" class="tab-content">
        <div class="section" id="section-timeanalysis">
            <div class="section-title">
                <span>â° ì‹œê°„ëŒ€ ë¶„ì„</span>
            </div>
            <div class="rank-panel" style="background:#fff; border:1px solid #ddd; padding:20px; border-radius:8px;">
                <h3>â° ì‹œê°„ëŒ€/ìš”ì¼ë³„ ë¶„ì„ (Heatmap)<span id="timeAnalysisPeriodLabel"></span></h3>
                <p style="font-size:12px; color:#666; margin:10px 0;">â€» ì§€ë‚œ 4ì£¼ê°„ì˜ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹œê°„ëŒ€/ìš”ì¼ë³„ íˆíŠ¸ë§µì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="controls" style="margin-top:10px;">
                    <select id="timeMetricSelect" onchange="updateTimeAnalysisHeatmap()">
                        <option value="cost">ê´‘ê³ ë¹„</option>
                        <option value="impressions">ë…¸ì¶œìˆ˜</option>
                        <option value="clicks">í´ë¦­ìˆ˜</option>
                        <option value="conversions">ì „í™˜ìˆ˜</option>
                        <option value="revenue">ë§¤ì¶œì•¡</option>
                    </select>
                    <select id="timeAnalysisCT" onchange="updateTimeAnalysisHeatmap()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                    <select id="timeAnalysisCamp" onchange="updateTimeAnalysisHeatmap()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                    <select id="timeAnalysisAdg" onchange="updateTimeAnalysisHeatmap()"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                    <select id="timeAnalysisMedia" onchange="updateTimeAnalysisHeatmap()"><option value="">ë§¤ì²´ ì „ì²´</option></select>
                    <span style="margin-left:10px; font-weight:bold;">ê¸°ê°„:</span>
                    <button id="timeWeek0" class="secondary" style="background:#007bff;" onclick="setTimeAnalysisWeek(0)">ì§€ë‚œì£¼</button>
                    <button id="timeWeek1" class="secondary" onclick="setTimeAnalysisWeek(1)">2ì£¼ì „</button>
                    <button id="timeWeek2" class="secondary" onclick="setTimeAnalysisWeek(2)">3ì£¼ì „</button>
                    <button id="timeWeek3" class="secondary" onclick="setTimeAnalysisWeek(3)">4ì£¼ì „</button>
                    <button id="timeWeekTotal" class="secondary" onclick="setTimeAnalysisWeek('total')">TOTAL</button>
                    <button onclick="updateTimeAnalysisHeatmap()" style="background-color: #dc3545; color: white;">ë¶„ì„</button>
                </div>
                <div id="timeAnalysisHeatmapContainer" style="overflow-x:auto; margin-top:15px;">
                    <p style="padding:20px; text-align:center; color:#999;">ê¸°ê°„ ë° í•„í„°ë¥¼ ì„ íƒí•˜ê³  'ë¶„ì„' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ íˆíŠ¸ë§µì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 7: Efficiency -->
    <div id="efficiency" class="tab-content">
        <div class="section" id="section-efficiency">
            <div class="section-title">
                <span>âš¡ íš¨ìœ¨ë¶„ì„</span>
            </div>
            <div class="info-box">ğŸ’¡ í•„í„°ë§ ì¡°ê±´(ìµœì†Œ ê´‘ê³ ë¹„, ìµœì†Œ ì „í™˜ìˆ˜ ë“±)ì„ ëª¨ë‘ ë§Œì¡±í•˜ë©´ íš¨ìœ¨ GOOD, ì•„ë‹ˆë©´ BAD.</div>
            <div class="controls">
                <input class="text-col" type="text" id="brandExclude" placeholder="ì œì™¸ í‚¤ì›Œë“œ(ì½¤ë§ˆ)">
                <select id="efficiencyCampaignTypeFilter"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                <select id="efficiencyCampaignFilter"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                <select id="efficiencyAdgroupFilter"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                <input type="number" id="filterCostMin" placeholder="ìµœì†Œ ê´‘ê³ ë¹„">
                <input type="number" id="filterConvMin" placeholder="ìµœì†Œ ì „í™˜ìˆ˜">
                <input type="number" id="filterROASMin" placeholder="ìµœì†Œ ROAS">
                <input type="number" id="filterCPAMin" placeholder="ìµœì†Œ ì „í™˜ë‹¹ë¹„ìš©">
                <button onclick="updateEfficiencyAnalysis()">ğŸ” ì ìš©</button>
                <button class="danger" onclick="resetEfficiency()">ì´ˆê¸°í™”</button>
                <button class="secondary btn-compact" onclick="toggleChangeBadge('goodEfficiencyTable'); toggleChangeBadge('badEfficiencyTable');">ì¦ê°ìœ¨ On/Off</button>
            </div>
            <h3 style="margin: 20px 0 10px; color: #333;">âœ… íš¨ìœ¨ GOOD (í•„í„° ì¶©ì¡±)</h3>
            <div class="table-wrapper">
                <table id="goodEfficiencyTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('goodEfficiencyTable',0)">ìˆœìœ„</th>
                        <th onclick="sortTable('goodEfficiencyTable',1)">ìº í˜ì¸ìœ í˜•</th>
                        <th onclick="sortTable('goodEfficiencyTable',2)">ê²€ìƒ‰ì–´</th>
                        <th onclick="sortTable('goodEfficiencyTable',3)">ìº í˜ì¸</th>
                        <th onclick="sortTable('goodEfficiencyTable',4)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('goodEfficiencyTable',5)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('goodEfficiencyTable',6)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('goodEfficiencyTable',7)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('goodEfficiencyTable',8)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('goodEfficiencyTable',9)" class="number">CPC</th>
                        <th onclick="sortTable('goodEfficiencyTable',10)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('goodEfficiencyTable',11)" class="number">ì „í™˜ìœ¨</th>
                        <th onclick="sortTable('goodEfficiencyTable',12)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                        <th onclick="sortTable('goodEfficiencyTable',13)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="goodEfficiencyBody">
                    <tr><td colspan="14" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
            <h3 style="margin: 20px 0 10px; color: #333;">âŒ íš¨ìœ¨ BAD (í•„í„° ë¯¸ì¶©ì¡±)</h3>
            <div class="table-wrapper">
                <table id="badEfficiencyTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('badEfficiencyTable',0)">ìˆœìœ„</th>
                        <th onclick="sortTable('badEfficiencyTable',1)">ìº í˜ì¸ìœ í˜•</th>
                        <th onclick="sortTable('badEfficiencyTable',2)">ê²€ìƒ‰ì–´</th>
                        <th onclick="sortTable('badEfficiencyTable',3)">ìº í˜ì¸</th>
                        <th onclick="sortTable('badEfficiencyTable',4)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('badEfficiencyTable',5)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('badEfficiencyTable',6)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('badEfficiencyTable',7)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('badEfficiencyTable',8)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('badEfficiencyTable',9)" class="number">CPC</th>
                        <th onclick="sortTable('badEfficiencyTable',10)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('badEfficiencyTable',11)" class="number">ì „í™˜ìœ¨</th>
                        <th onclick="sortTable('badEfficiencyTable',12)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                        <th onclick="sortTable('badEfficiencyTable',13)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="badEfficiencyBody">
                    <tr><td colspan="14" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB 8: CPC -->
    <div id="cpc" class="tab-content">
        <div class="section" id="section-cpc">
            <div class="section-title">
                <span>ğŸ’² CPC ë¶„ì„</span>
            </div>
            <div class="info-box">ğŸ’¡ í•„í„° ì¡°ê±´ ì¶©ì¡± ì‹œ, CPC ì¦ê°ìœ¨ì— ë”°ë¼ ë¶„ë¥˜ë©ë‹ˆë‹¤.</div>
            <div class="controls">
                <input class="text-col compact-input" type="text" id="cpcBrandExclude" placeholder="ì œì™¸í‚¤ì›Œë“œ">
                <select id="cpcCampaignTypeFilter" class="compact-input"><option value="">ìœ í˜• ì „ì²´</option></select>
                <select id="cpcCampaignFilter" class="compact-input"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                <select id="cpcAdgroupFilter" class="compact-input"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                <input type="number" id="cpcCostMin" class="compact-input" placeholder="ê´‘ê³ ë¹„â‰¥">
                <input type="number" id="cpcConvMin" class="compact-input" placeholder="ì „í™˜â‰¥">
                <input type="number" id="cpcROASMin" class="compact-input" placeholder="ROASâ‰¥">

                <input type="number" id="cpcChangeThreshold" class="compact-input" placeholder="CPC%">
                <button onclick="updateCPCAnalysis()">ğŸ” ì ìš©</button>
                <button class="danger" onclick="resetCPC()">ì´ˆê¸°í™”</button>
                <button class="secondary" onclick="toggleCPCChanges()">ì¦ê°ìœ¨ On/Off</button>
            </div>
            <h3 style="margin: 20px 0 10px; color: #333;">ğŸ”º CPC ìƒìŠ¹</h3>
            <div class="table-wrapper">
                <table id="cpcUpTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('cpcUpTable',0)">ìˆœìœ„</th>
                        <th onclick="sortTable('cpcUpTable',1)">ìº í˜ì¸ìœ í˜•</th>
                        <th onclick="sortTable('cpcUpTable',2)">ê²€ìƒ‰ì–´</th>
                        <th onclick="sortTable('cpcUpTable',3)">ìº í˜ì¸</th>
                        <th onclick="sortTable('cpcUpTable',4)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('cpcUpTable',5)" class="number">CPC</th>
                        <th onclick="sortTable('cpcUpTable',6)" class="number">ì§€ë‚œì£¼ CPC</th>
                        <th onclick="sortTable('cpcUpTable',7)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('cpcUpTable',8)" class="number">ê´‘ê³ ë¹„(%)</th>
                        <th onclick="sortTable('cpcUpTable',9)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('cpcUpTable',10)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('cpcUpTable',11)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('cpcUpTable',12)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('cpcUpTable',13)" class="number">ë§¤ì¶œì•¡</th>
                        <th onclick="sortTable('cpcUpTable',14)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="cpcUpBody">
                    <tr><td colspan="15" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
            <h3 style="margin: 20px 0 10px; color: #333;">ğŸ”» CPC ê°ì†Œ</h3>
            <div class="table-wrapper">
                <table id="cpcDownTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('cpcDownTable',0)">ìˆœìœ„</th>
                        <th onclick="sortTable('cpcDownTable',1)">ìº í˜ì¸ìœ í˜•</th>
                        <th onclick="sortTable('cpcDownTable',2)">ê²€ìƒ‰ì–´</th>
                        <th onclick="sortTable('cpcDownTable',3)">ìº í˜ì¸</th>
                        <th onclick="sortTable('cpcDownTable',4)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('cpcDownTable',5)" class="number">CPC</th>
                        <th onclick="sortTable('cpcDownTable',6)" class="number">ì§€ë‚œì£¼ CPC</th>
                        <th onclick="sortTable('cpcDownTable',7)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('cpcDownTable',8)" class="number">ê´‘ê³ ë¹„(%)</th>
                        <th onclick="sortTable('cpcDownTable',9)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('cpcDownTable',10)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('cpcDownTable',11)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('cpcDownTable',12)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('cpcDownTable',13)" class="number">ë§¤ì¶œì•¡</th>
                        <th onclick="sortTable('cpcDownTable',14)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="cpcDownBody">
                    <tr><td colspan="15" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB 9: Device -->
    <div id="device" class="tab-content">
        <div class="section" id="section-device">
            <div class="section-title">
                <span>ğŸ“± ë””ë°”ì´ìŠ¤ë³„ ì„±ê³¼ ë¶„ì„</span>
            </div>
            <div class="controls">
                <select id="deviceCampaignTypeFilter" onchange="updateDeviceTables()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                <input type="number" id="standardROAS3" placeholder="ROAS ê¸°ì¤€ %" min="0" step="10">
                <button onclick="applyROASFilterDevice('low')">ROAS ì ìš©</button>
                <button class="roas-up" onclick="applyROASFilterDevice('up')">â†‘</button>
                <button class="roas-down" onclick="applyROASFilterDevice('down')">â†“</button>
                <button class="danger" onclick="resetDevice()">ì´ˆê¸°í™”</button>
            </div>
            <div class="two-col">
                <div>
                    <h4 style="margin: 10px 0 10px;">PC</h4>
                    <div class="table-wrapper">
                        <table id="devicePCTable">
                            <thead>
                            <tr>
                                <th onclick="sortTable('devicePCTable',0)">ìˆœìœ„</th>
                                <th onclick="sortTable('devicePCTable',1)">ìº í˜ì¸</th>
                                <th onclick="sortTable('devicePCTable',2)" class="number">ê´‘ê³ ë¹„</th>
                                <th onclick="sortTable('devicePCTable',3)" class="number">PCê´‘ê³ ë¹„ì¤‘%</th>
                                <th onclick="sortTable('devicePCTable',4)" class="number">ë…¸ì¶œìˆ˜</th>
                                <th onclick="sortTable('devicePCTable',5)" class="number">í´ë¦­ìˆ˜</th>
                                <th onclick="sortTable('devicePCTable',6)" class="number">ì „í™˜ìˆ˜</th>
                                <th onclick="sortTable('devicePCTable',7)" class="number">ë§¤ì¶œì•¡</th>
                                <th onclick="sortTable('devicePCTable',8)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                                <th onclick="sortTable('devicePCTable',9)" class="number">ROAS</th>
                                <th onclick="sortTable('devicePCTable',10)" class="number">ROAS ì¦ê°%</th>
                            </tr>
                            </thead>
                            <tbody id="devicePCBody">
                            <tr><td colspan="11" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h4 style="margin: 10px 0 10px;">MO</h4>
                    <div class="table-wrapper">
                        <table id="deviceMOTable">
                            <thead>
                            <tr>
                                <th onclick="sortTable('deviceMOTable',0)">ìˆœìœ„</th>
                                <th onclick="sortTable('deviceMOTable',1)">ìº í˜ì¸</th>
                                <th onclick="sortTable('deviceMOTable',2)" class="number">ê´‘ê³ ë¹„</th>
                                <th onclick="sortTable('deviceMOTable',3)" class="number">MOê´‘ê³ ë¹„ì¤‘%</th>
                                <th onclick="sortTable('deviceMOTable',4)" class="number">ë…¸ì¶œìˆ˜</th>
                                <th onclick="sortTable('deviceMOTable',5)" class="number">í´ë¦­ìˆ˜</th>
                                <th onclick="sortTable('deviceMOTable',6)" class="number">ì „í™˜ìˆ˜</th>
                                <th onclick="sortTable('deviceMOTable',7)" class="number">ë§¤ì¶œì•¡</th>
                                <th onclick="sortTable('deviceMOTable',8)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                                <th onclick="sortTable('deviceMOTable',9)" class="number">ROAS</th>
                                <th onclick="sortTable('deviceMOTable',10)" class="number">ROAS ì¦ê°%</th>
                            </tr>
                            </thead>
                            <tbody id="deviceMOBody">
                            <tr><td colspan="11" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 10: Shopping Dashboard -->
    <div id="shopping" class="tab-content">
        <div class="section" id="section-shopping">
            <div class="section-title">
                <span>ğŸ›ï¸ ì‡¼í•‘ê²€ìƒ‰ í†µí•© ëŒ€ì‹œë³´ë“œ (ì§€ë‚œì£¼ vs 2ì£¼ì „)</span>
            </div>

<div  id="shoppingGuide" class="shop-guide-wrapper">
    <div class="shop-guide-card">
        <span class="shop-guide-header">ğŸ“Œ ìƒí’ˆì •ë³´ (TSV) ì—…ë¡œë“œ ê°€ì´ë“œ</span>
        <div class="shop-path-box">
            ğŸ“‚ <b>ìƒí’ˆì •ë³´(TSV) ë‹¤ìš´ë¡œë“œ ê²½ë¡œ:</b> ë„¤ì´ë²„ê´‘ê³  â†’ ë³´ê³ ì„œ â†’ ëŒ€ìš©ëŸ‰ ë‹¤ìš´ë¡œë“œ â†’ ê´‘ê³  ì •ë³´ ì¼ê´„ ë‹¤ìš´ë¡œë“œ â†’ <b>ì‡¼í•‘ê²€ìƒ‰ ì‡¼í•‘ëª°ìƒí’ˆí˜• ìƒí’ˆ ë§ˆìŠ¤í„°</b>
        </div>
    </div>

    <div class="shop-guide-card">
        <span class="shop-guide-header">ğŸ“Œ ì†Œì¬ ì„±ê³¼ (CSV) ì—…ë¡œë“œ ê°€ì´ë“œ - ì§€ë‚œ 4ì£¼</span>
        <div class="tag-container-row">
            <div class="tag-grid">
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ìº í˜ì¸ ìœ í˜•</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ìº í˜ì¸</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ê´‘ê³ ê·¸ë£¹</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ì†Œì¬</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ë§¤ì²´ì´ë¦„</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">PC-ëª¨ë°”ì¼</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ì¼ë³„</span></div>
                <div class="tag-item"><div class="tag-bar-blue"></div><span class="tag-text">ì£¼ë³„</span></div>
            </div>
            <div class="guide-v-line"></div>
            <div class="tag-grid">
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">ê´‘ê³ ë¹„</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">ë…¸ì¶œìˆ˜</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">í´ë¦­ìˆ˜</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">ì „í™˜ìˆ˜</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">ì „í™˜ë§¤ì¶œì•¡</span></div>
                <div class="tag-item"><div class="tag-bar-green"></div><span class="tag-text">í‰ê· ë…¸ì¶œìˆœìœ„</span></div>
            </div>
        </div>
    </div>
</div>

            <div id="uploadSection_shopping" style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div id="dropZoneShop1" class="drop-zone-shop" style="border: 2px dashed #00c73c; border-radius: 8px; padding: 30px; text-align: center; background: white; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">ğŸ“¦ 1. ìƒí’ˆ ì •ë³´ (TSV)</div>
                        <div style="font-size: 13px; color: #666; margin-bottom: 15px;">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                        <input type="file" id="tsvFile" accept=".tsv" style="display: none;" onchange="handleShoppingFile('tsv')">
                        <button onclick="event.stopPropagation(); document.getElementById('tsvFile').click()" style="padding: 8px 16px; background: #00c73c; color: white; border: none; border-radius: 4px; cursor: pointer;">TSV íŒŒì¼ ì„ íƒ</button>
                        <div id="tsvFileName" style="margin-top: 10px; font-size: 12px; color: #00c73c; font-weight: bold;"></div>
                    </div>
                    <div id="dropZoneShop2" class="drop-zone-shop" style="border: 2px dashed #00c73c; border-radius: 8px; padding: 30px; text-align: center; background: white; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">ğŸ“Š 2. ì†Œì¬ ì„±ê³¼ (CSV)</div>
                        <div style="font-size: 13px; color: #666; margin-bottom: 15px;">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleShoppingFile('csv')">
                        <button onclick="event.stopPropagation(); document.getElementById('csvFile').click()" style="padding: 8px 16px; background: #00c73c; color: white; border: none; border-radius: 4px; cursor: pointer;">CSV íŒŒì¼ ì„ íƒ</button>
                        <div id="csvFileName" style="margin-top: 10px; font-size: 12px; color: #00c73c; font-weight: bold;"></div>
                    </div>
                </div>
                <div style="text-align: center;">
                    <button onclick="startAnalysis()" style="background: #00c73c; color: white; border: none; padding: 12px 40px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px;">ğŸš€ ë°ì´í„° ë¶„ì„ ì‹¤í–‰</button>
                </div>
                <div id="loadingShop" style="display: none; text-align: center; padding: 20px; margin-top: 20px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #00c73c; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <div style="margin-top: 10px; font-weight: bold; color: #00c73c;">íŒŒì¼ ë¶„ì„ ì¤‘...</div>
                </div>
                <div id="analysisComplete" style="display: none; text-align: center; padding: 15px; margin-top: 20px; background: #d4edda; border: 2px solid #00c73c; border-radius: 6px; color: #155724; font-weight: bold; font-size: 16px;">
                    âœ… ë¶„ì„ ì™„ë£Œ!
                </div>
            </div>
            <style>
                .drop-zone-shop.dragover { background: #e8f5e9; border-color: #00a030; transform: scale(1.02); }
            </style>

            <div id="resultArea_shopping" style="display:none;">
                <div id="cpCards_shopping" style="display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 15px; border-bottom: 1px solid #eee; align-items: center;"></div>
                <div id="grCards_shopping" style="display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 15px; border-bottom: 1px solid #eee; align-items: center;"></div>
                
                <div style="margin-bottom: 15px;">
                    <input type="text" id="productSearchInput_shopping" placeholder="ìƒí’ˆëª… ê²€ìƒ‰..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; width: 300px;" oninput="filterByProductName_shopping()">
                </div>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ì´ë¯¸ì§€</th>
                                <th onclick="resort_shopping('cp')" style="max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">ìº í˜ì¸</th>
                                <th onclick="resort_shopping('gr')" style="max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">ê´‘ê³ ê·¸ë£¹</th>
                                <th style="max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left;">ìƒí’ˆëª…</th>
                                <th onclick="resort_shopping('cost')">ê´‘ê³ ë¹„</th>
                                <th onclick="resort_shopping('view')">ë…¸ì¶œìˆ˜</th>
                                <th onclick="resort_shopping('click')">í´ë¦­ìˆ˜</th>
                                <th onclick="resort_shopping('ctr')">í´ë¦­ìœ¨</th>
                                <th onclick="resort_shopping('cpc')">CPC</th>
                                <th onclick="resort_shopping('cv')">ì „í™˜ìˆ˜</th>
                                <th onclick="resort_shopping('amt')">ë§¤ì¶œì•¡</th>
                                <th onclick="resort_shopping('roas')">ROAS</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody_shopping"></tbody>
                    </table>
                </div>

                <div id="detailSection_shopping" style="margin-top: 30px; padding: 25px; border: 1px solid #ddd; border-radius: 12px; display: none; background: #fff;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 id="detailTitle_shopping" style="margin:0;"></h3>
                        <button onclick="document.getElementById('detailSection_shopping').style.display='none'" style="color:red; border:none; background:none; cursor:pointer; font-weight:bold; font-size: 16px;">[âœ• ë‹«ê¸°]</button>
                    </div>
                    <div id="tabArea_shopping" style="display: flex; gap: 8px; margin-top: 25px; margin-bottom: 20px; flex-wrap: wrap;"></div>
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div style="border: 1px solid #f0f0f0; padding: 15px; border-radius: 8px; background: #fafafa; position: relative;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <h5 style="margin:0;">ğŸ“… ì¼ë³„ ì¶”ì´</h5>
                            </div>
                            <div id="dayStats_shopping" style="display: flex; gap: 15px; margin-bottom: 15px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #eee; justify-content: space-around;"></div>
                            <div style="height: 350px; margin-bottom: 15px; background: white; padding: 10px; border-radius: 6px;"><canvas id="dayChart_shopping"></canvas></div>
                        </div>
                        <div style="border: 1px solid #f0f0f0; padding: 15px; border-radius: 8px; background: #fafafa; position: relative;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <h5 style="margin:0;">ğŸ“Š ì£¼ë³„ ì¶”ì´ (ìµœê·¼ 4ì£¼)</h5>
                            </div>
                            <div id="weekStats_shopping" style="display: flex; gap: 15px; margin-bottom: 15px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #eee; justify-content: space-around;"></div>
                            <div style="height: 350px; margin-bottom: 15px; background: white; padding: 10px; border-radius: 6px;"><canvas id="weekChart_shopping"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: Day Analysis -->
    <div id="dayweek-day" class="tab-content">
        <div class="section" id="section-dayweek-day">
            <div class="section-title">
                <span>ğŸ“† ì¼ë³„ ë¶„ì„</span>
            </div>
            
            <!-- Summary Cards -->
            <div class="chart-container">
                <h3>ğŸ“Š ìš”ì•½ í†µê³„</h3>
                <div id="dayweekSummary" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;"></div>
            </div>
            
            <!-- Charts -->
            <div class="chart-container" style="margin-top: 30px;">
                <h3>ğŸ“ˆ ì„±ê³¼ ì¶”ì´</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px;">
                    <div>
                        <h4 style="font-size: 13px; margin-bottom: 10px;">ê´‘ê³ ë¹„</h4>
                        <div style="height: 250px;"><canvas id="dayweekCostChart"></canvas></div>
                    </div>
                    <div>
                        <h4 style="font-size: 13px; margin-bottom: 10px;">í´ë¦­ìˆ˜</h4>
                        <div style="height: 250px;"><canvas id="dayweekClicksChart"></canvas></div>
                    </div>
                    <div>
                        <h4 style="font-size: 13px; margin-bottom: 10px;">ì „í™˜ìˆ˜</h4>
                        <div style="height: 250px;"><canvas id="dayweekConvChart"></canvas></div>
                    </div>
                    <div>
                        <h4 style="font-size: 13px; margin-bottom: 10px;">ë§¤ì¶œì•¡</h4>
                        <div style="height: 250px;"><canvas id="dayweekRevenueChart"></canvas></div>
                    </div>
                    <div>
                        <h4 style="font-size: 13px; margin-bottom: 10px;">CPC</h4>
                        <div style="height: 250px;"><canvas id="dayweekCPCChart"></canvas></div>
                    </div>
                    <div>
                        <h4 style="font-size: 13px; margin-bottom: 10px;">ROAS (%)</h4>
                        <div style="height: 250px;"><canvas id="dayweekROASChart"></canvas></div>
                    </div>
                </div>
            </div>
            
            <!-- Data Table -->
            <div class="chart-container" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>ğŸ“‹ ìƒì„¸ ë°ì´í„°</h3>
                    <button class="secondary" onclick="toggleDayWeekGrowthRate()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">ğŸ“Š ì¦ê°ìœ¨ On/Off</button>
                </div>
                <div id="dayweekTable" style="overflow-x: auto; margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <!-- TAB: Week Analysis -->
    <div id="dayweek-week" class="tab-content">
        <div class="section" id="section-dayweek-week">
            <div class="section-title">
                <span>ğŸ“… ì£¼ë³„ ë¶„ì„</span>
            </div>
            
            <!-- Summary Cards -->
            <div class="chart-container">
                <h3>ğŸ“Š ìš”ì•½ í†µê³„</h3>
                <div id="weekSummary" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;"></div>
            </div>
            
            <!-- Charts -->
            <div class="chart-container" style="margin-top: 30px;">
                <h3>ğŸ“ˆ ì„±ê³¼ ì¶”ì´</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px;">
                    <div>
                        <h4 style="font-size: 13px; margin-bottom: 10px;">ê´‘ê³ ë¹„</h4>
                        <div style="height: 250px;"><canvas id="weekCostChart"></canvas></div>
                    </div>
                    <div>
                        <h4 style="font-size: 13px; margin-bottom: 10px;">í´ë¦­ìˆ˜</h4>
                        <div style="height: 250px;"><canvas id="weekClicksChart"></canvas></div>
                    </div>
                    <div>
                        <h4 style="font-size: 13px; margin-bottom: 10px;">ì „í™˜ìˆ˜</h4>
                        <div style="height: 250px;"><canvas id="weekConvChart"></canvas></div>
                    </div>
                    <div>
                        <h4 style="font-size: 13px; margin-bottom: 10px;">ë§¤ì¶œì•¡</h4>
                        <div style="height: 250px;"><canvas id="weekRevenueChart"></canvas></div>
                    </div>
                    <div>
                        <h4 style="font-size: 13px; margin-bottom: 10px;">CPC</h4>
                        <div style="height: 250px;"><canvas id="weekCPCChart"></canvas></div>
                    </div>
                    <div>
                        <h4 style="font-size: 13px; margin-bottom: 10px;">ROAS (%)</h4>
                        <div style="height: 250px;"><canvas id="weekROASChart"></canvas></div>
                    </div>
                </div>
            </div>
            
            <!-- Data Table -->
            <div class="chart-container" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>ğŸ“‹ ìƒì„¸ ë°ì´í„°</h3>
                    <button class="secondary" onclick="toggleWeekGrowthRate()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">ğŸ“Š ì¦ê°ìœ¨ On/Off</button>
                </div>
                <div id="weekTable" style="overflow-x: auto; margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <!-- TAB: Simulator -->
    <div id="simulator" class="tab-content">
        <div class="section" id="section-simulator">
            <div class="section-title">
                <span>ğŸ¯ ê´‘ê³  ì‹œë®¬ë ˆì´í„°</span>
            </div>
            
            <!-- Budget Simulator -->
            <div class="chart-container">
                <h3 style="margin-bottom: 15px;">ğŸ’° ì˜ˆì‚° ì‹œë®¬ë ˆì´í„°</h3>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">ì§€ë‚œ 4ì£¼ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì„¤ì •í•œ ì˜ˆì‚°ì—ì„œ ì˜ˆìƒë˜ëŠ” ì„±ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                
                <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                    <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 0 0 auto;">
                            <label style="font-weight: bold; font-size: 13px; display: block; margin-bottom: 6px; color: #333;">ì£¼ê°„ ê´‘ê³  ì˜ˆì‚° ì…ë ¥:</label>
                            <input type="number" id="budgetInput" value="0" style="padding: 10px 15px; border: 2px solid #007bff; border-radius: 8px; width: 180px; text-align: left; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.05);" oninput="updateBudgetFromInput()">
                        </div>
                        <div style="flex: 0 0 auto; min-width: 250px;">
                            <label style="font-weight: bold; font-size: 13px; display: block; margin-bottom: 6px; color: #333;">
                                ì˜ˆì‚° ì¡°ì • ìŠ¬ë¼ì´ë”: <span id="budgetPercentLabel" style="color: #007bff;">0%</span>
                            </label>
                            <input type="range" id="budgetSlider" min="-100" max="500" value="0" step="10" style="width: 100%; height: 8px; border-radius: 5px; background: #d3d3d3; outline: none; -webkit-appearance: none;" oninput="updateBudgetFromSlider()">
                        </div>
                        <div style="flex: 1; display: flex; gap: 10px; flex-wrap: wrap;">
                            <select id="budgetSimCampaignTypeFilter" onchange="updateBudgetSimulation()" style="flex: 1; min-width: 120px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 13px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer;"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                            <select id="budgetSimCampaignFilter" onchange="updateBudgetSimulation()" style="flex: 1; min-width: 120px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 13px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer;"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                            <select id="budgetSimAdgroupFilter" onchange="updateBudgetSimulation()" style="flex: 1; min-width: 120px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 13px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer;"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                            <select id="budgetSimMediaFilter" onchange="updateBudgetSimulation()" style="flex: 1; min-width: 100px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 13px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer;"><option value="">ë§¤ì²´ ì „ì²´</option></select>
                            <select id="budgetSimDeviceFilter" onchange="updateBudgetSimulation()" style="flex: 0 0 auto; min-width: 100px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 13px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer;"><option value="">ì „ì²´ ë””ë°”ì´ìŠ¤</option><option value="PC">PC</option><option value="ëª¨ë°”ì¼">ëª¨ë°”ì¼</option></select>
                        </div>
                    </div>
                </div>
                
                <div id="budgetResults" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px;"></div>
            </div>

            <!-- Forecast -->
            <div class="chart-container">
                <h3>ğŸ“ˆ ë‹¤ìŒ ì£¼ ì˜ˆì¸¡</h3>
                <p style="font-size:13px; color:#666; margin-bottom:15px;">ì§€ë‚œ 4ì£¼ ì¶”ì„¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ì£¼ ì„±ê³¼ë¥¼ ì˜ˆì¸¡í•©ë‹ˆë‹¤.</p>
                <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:20px;">
                    <!-- Row 1 -->
                    <div>
                        <h4 style="font-size:13px; margin-bottom:10px;">ê´‘ê³ ë¹„</h4>
                        <div style="height:250px;"><canvas id="forecastCost"></canvas></div>
                        <div id="forecastCostStats" style="margin-top:10px; font-size:12px;"></div>
                    </div>
                    <div>
                        <h4 style="font-size:13px; margin-bottom:10px;">ë…¸ì¶œìˆ˜</h4>
                        <div style="height:250px;"><canvas id="forecastImpressions"></canvas></div>
                        <div id="forecastImpressionsStats" style="margin-top:10px; font-size:12px;"></div>
                    </div>
                    <div>
                        <h4 style="font-size:13px; margin-bottom:10px;">í´ë¦­ìˆ˜</h4>
                        <div style="height:250px;"><canvas id="forecastClicks"></canvas></div>
                        <div id="forecastClicksStats" style="margin-top:10px; font-size:12px;"></div>
                    </div>
                    <div>
                        <h4 style="font-size:13px; margin-bottom:10px;">ì „í™˜ìˆ˜</h4>
                        <div style="height:250px;"><canvas id="forecastConversions"></canvas></div>
                        <div id="forecastConversionsStats" style="margin-top:10px; font-size:12px;"></div>
                    </div>
                    <!-- Row 2 -->
                    <div>
                        <h4 style="font-size:13px; margin-bottom:10px;">ë§¤ì¶œì•¡</h4>
                        <div style="height:250px;"><canvas id="forecastRevenue"></canvas></div>
                        <div id="forecastRevenueStats" style="margin-top:10px; font-size:12px;"></div>
                    </div>
                    <div>
                        <h4 style="font-size:13px; margin-bottom:10px;">CTR (%)</h4>
                        <div style="height:250px;"><canvas id="forecastCTR"></canvas></div>
                        <div id="forecastCTRStats" style="margin-top:10px; font-size:12px;"></div>
                    </div>
                    <div>
                        <h4 style="font-size:13px; margin-bottom:10px;">CVR (%)</h4>
                        <div style="height:250px;"><canvas id="forecastCVR"></canvas></div>
                        <div id="forecastCVRStats" style="margin-top:10px; font-size:12px;"></div>
                    </div>
                    <div>
                        <h4 style="font-size:13px; margin-bottom:10px;">CPC</h4>
                        <div style="height:250px;"><canvas id="forecastCPC"></canvas></div>
                        <div id="forecastCPCStats" style="margin-top:10px; font-size:12px;"></div>
                    </div>
                    <!-- Row 3 -->
                    <div>
                        <h4 style="font-size:13px; margin-bottom:10px;">ì „í™˜ë‹¹ë¹„ìš© (CPA)</h4>
                        <div style="height:250px;"><canvas id="forecastCPA"></canvas></div>
                        <div id="forecastCPAStats" style="margin-top:10px; font-size:12px;"></div>
                    </div>
                    <div>
                        <h4 style="font-size:13px; margin-bottom:10px;">ROAS (%)</h4>
                        <div style="height:250px;"><canvas id="forecastROAS"></canvas></div>
                        <div id="forecastROASStats" style="margin-top:10px; font-size:12px;"></div>
                    </div>
                    <div>
                        <h4 style="font-size:13px; margin-bottom:10px;">í‰ê·  ì£¼ë¬¸ ê¸ˆì•¡ (AOV)</h4>
                        <div style="height:250px;"><canvas id="forecastAOV"></canvas></div>
                        <div id="forecastAOVStats" style="margin-top:10px; font-size:12px;"></div>
                    </div>
                    <div>
                        <h4 style="font-size:13px; margin-bottom:10px;">ë§¤ì¶œì•¡ ëŒ€ë¹„ ê´‘ê³ ë¹„ (COR %)</h4>
                        <div style="height:250px;"><canvas id="forecastCOR"></canvas></div>
                        <div id="forecastCORStats" style="margin-top:10px; font-size:12px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/* ============ ë°ì´í„°/ìƒìˆ˜ ============ */
let rawRows = [];
let raw2Rows = [];
let weeks = [];
let currentWeekData = [];
let previousWeekData = [];
let sortDirection = {};
let keywordPage = 1;
const PAGE_SIZE = 100;
const chartKeepers = {};
let stackedChartInstance = null;
const colorPalette = [
    '#5D9CEC', '#4FC1E9', '#48CFAD', '#A0D468', '#FFCE54', '#FC6E51', '#ED5565', '#AC92EC', '#EC87C0',
    '#656D78', '#434A54', '#E6E9ED', '#CCD1D9', '#AAB2BD'
];

const COLS_RAW = { DAY:0, WEEK:1, CAMPAIGN_TYPE:2, CAMPAIGN:3, ADGROUP:4, TIME:5, DOW:6, MEDIA:7, DEVICE:8, COST:9, IMP:10, CLK:11, CONV:12, REV:13, POS:14 };
const COLS_RAW2 = { DAY:0, WEEK:1, CAMPAIGN_TYPE:2, CAMPAIGN:3, ADGROUP:4, KEYWORD:5, MEDIA:6, DEVICE:7, SEARCH_OR_CONTENT:8, COST:9, IMP:10, CLK:11, CONV:12, REV:13, POS:14 };

/* ============ ìœ í‹¸ ============ */
const sum = (arr, key) => arr.reduce((s,d)=>s+(d[key]||0),0);
const formatNum = v => Math.round(v).toLocaleString();
const formatPct2 = v => (v||0).toFixed(2) + '%';
const formatMoney = v => Math.round(v).toLocaleString();
function formatCardValue(key, value){
    if (!value && value!==0) return '-';
    // Remove "ì›" from cost, revenue, cpc, cpa per user request
    if (['cost','revenue','cpc','cpa','aov'].includes(key)) return formatMoney(value);
    if (['impressions','clicks','conversions'].includes(key)) return formatNum(value);
    if (['ctr','cvr'].includes(key)) return formatPct2(value);
    if (['cor','roas'].includes(key)) return Math.round(value) + '%';
    return formatNum(value);
}

function formatValue(value) {
    if (!value && value !== 0) return '-';
    if (typeof value === 'number') {
        if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
        if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
        return value.toFixed(0);
    }
    return value;
}

const getChangeRate = (cur, prev) => {
    if (prev === 0) return cur > 0 ? 100 : 0;
    return ((cur - prev) / prev) * 100;
};
const badge = r => `<span class="${r>=0?'delta-up':'delta-down'}">${r>=0?'+':''}${r.toFixed(1)}%</span>`;
function showStatus(msg, type) { const s=document.getElementById('uploadStatus'); s.textContent=msg; s.className='status '+type; s.style.display='block'; }
function parseCSVLine(line){ const res=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){ const c=line[i], n=line[i+1]; if(c==='"'){ if(inQ&&n==='"'){cur+='"'; i++;} else inQ=!inQ; } else if(c===',' && !inQ){ res.push(cur.trim()); cur=''; } else cur+=c; } res.push(cur.trim()); return res; }

function showUploadPage() {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    // Show upload tab
    document.getElementById('upload').classList.add('active');
}

function switchTab(e, tabName) {
    e.preventDefault();
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.dropdown-toggle').forEach(b => b.classList.remove('active'));
    
    // Set the dayweek mode based on the tab
    if (tabName === 'dayweek-day') {
        dayweekMode = 'day';
        updateDayWeekAnalysis();
        document.getElementById('dayweekDropdown').classList.add('active');
    } else if (tabName === 'dayweek-week') {
        dayweekMode = 'week';
        updateDayWeekAnalysis();
        document.getElementById('dayweekDropdown').classList.add('active');
    }
    
    document.getElementById(tabName).classList.add('active');
    if (e.target.classList.contains('tab-btn')) {
        e.target.classList.add('active');
    }
}

/* ============ Capture Report ============ */
function captureReport() {
    const btn = document.getElementById('captureBtn');
    btn.disabled = true;
    btn.innerHTML = '<span>ğŸ“¸</span><span>ìº¡ì²˜ ì¤‘...</span>';
    
    // Get the active tab content
    const activeTab = document.querySelector('.tab-content.active');
    if (!activeTab) {
        alert('í™œì„±í™”ëœ íƒ­ì´ ì—†ìŠµë‹ˆë‹¤.');
        btn.disabled = false;
        btn.innerHTML = '<span style="font-size: 16px;">ğŸ“¸</span><span>ì „ì²´ ìº¡ì²˜</span>';
        return;
    }
    
    // Get the container element to handle max-width
    const container = document.querySelector('.container');
    const originalContainerMaxWidth = container ? container.style.maxWidth : '';
    const originalContainerMargin = container ? container.style.margin : '';
    
    // Temporarily remove container constraints
    if (container) {
        container.style.maxWidth = 'none';
        container.style.margin = '0';
    }
    
    // Hide controls and section titles temporarily for capture
    const controlsElements = activeTab.querySelectorAll('.controls');
    const sectionTitles = activeTab.querySelectorAll('.section-title');
    const originalDisplays = [];
    const originalTitleDisplays = [];
    
    controlsElements.forEach((el, idx) => {
        originalDisplays[idx] = el.style.display;
        el.style.display = 'none';
    });
    
    sectionTitles.forEach((el, idx) => {
        originalTitleDisplays[idx] = el.style.display;
        el.style.display = 'none';
    });
    
    // Remove height constraints on tables for full capture
    const scrollableElements = activeTab.querySelectorAll('[style*="overflow"]');
    const originalOverflows = [];
    const originalWidths = [];
    scrollableElements.forEach((el, idx) => {
        originalOverflows[idx] = {
            overflow: el.style.overflow,
            overflowX: el.style.overflowX,
            overflowY: el.style.overflowY,
            maxHeight: el.style.maxHeight,
            height: el.style.height,
            width: el.style.width
        };
        el.style.overflow = 'visible';
        el.style.overflowX = 'visible';
        el.style.overflowY = 'visible';
        el.style.maxHeight = 'none';
        el.style.height = 'auto';
        el.style.width = 'auto';
    });
    
    // Also handle .table-wrapper elements (they have overflow in CSS, not inline)
    const tableWrappers = activeTab.querySelectorAll('.table-wrapper');
    const originalWrapperStyles = [];
    tableWrappers.forEach((wrapper, idx) => {
        originalWrapperStyles[idx] = {
            overflow: wrapper.style.overflow,
            overflowX: wrapper.style.overflowX,
            overflowY: wrapper.style.overflowY,
            maxHeight: wrapper.style.maxHeight,
            height: wrapper.style.height
        };
        wrapper.style.overflow = 'visible';
        wrapper.style.overflowX = 'visible';
        wrapper.style.overflowY = 'visible';
        wrapper.style.maxHeight = 'none';
        wrapper.style.height = 'auto';
    });
    
    // Make tables full width to ensure all content is visible
    const tables = activeTab.querySelectorAll('table');
    const originalTableWidths = [];
    tables.forEach((table, idx) => {
        originalTableWidths[idx] = table.style.width;
        table.style.width = 'auto';
    });
    
    // Use html2canvas to capture the active tab with full content
    // Let html2canvas determine the size naturally for best fit
    html2canvas(activeTab, {
        scale: 2,
        logging: false,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        scrollY: -window.scrollY,
        scrollX: -window.scrollX
    }).then(canvas => {
        // Restore container styles
        if (container) {
            container.style.maxWidth = originalContainerMaxWidth;
            container.style.margin = originalContainerMargin;
        }

        // Restore controls and titles visibility
        controlsElements.forEach((el, idx) => {
            el.style.display = originalDisplays[idx];
        });
        
        sectionTitles.forEach((el, idx) => {
            el.style.display = originalTitleDisplays[idx];
        });
        
        // Restore scroll properties
        scrollableElements.forEach((el, idx) => {
            el.style.overflow = originalOverflows[idx].overflow;
            el.style.overflowX = originalOverflows[idx].overflowX;
            el.style.overflowY = originalOverflows[idx].overflowY;
            el.style.maxHeight = originalOverflows[idx].maxHeight;
            el.style.height = originalOverflows[idx].height;
            el.style.width = originalOverflows[idx].width;
        });
        
        // Restore table wrapper styles
        tableWrappers.forEach((wrapper, idx) => {
            wrapper.style.overflow = originalWrapperStyles[idx].overflow;
            wrapper.style.overflowX = originalWrapperStyles[idx].overflowX;
            wrapper.style.overflowY = originalWrapperStyles[idx].overflowY;
            wrapper.style.maxHeight = originalWrapperStyles[idx].maxHeight;
            wrapper.style.height = originalWrapperStyles[idx].height;
        });
        
        // Restore table widths
        tables.forEach((table, idx) => {
            table.style.width = originalTableWidths[idx];
        });
        
        // Convert to blob and download
        canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const tabName = document.querySelector('.tab-btn.active').textContent.trim();
            const date = new Date().toISOString().split('T')[0];
            a.download = `ë§ˆì¼€íŒ…ë¦¬í¬íŠ¸_${tabName}_${date}.png`;
            a.click();
            URL.revokeObjectURL(url);
            
            btn.disabled = false;
            btn.innerHTML = '<span style="font-size: 16px;">ğŸ“¸</span><span>ì „ì²´ ìº¡ì²˜</span>';
        });
    }).catch(err => {
        // Restore container styles on error
        if (container) {
            container.style.maxWidth = originalContainerMaxWidth;
            container.style.margin = originalContainerMargin;
        }
        
        // Restore controls visibility on error
        controlsElements.forEach((el, idx) => {
            el.style.display = originalDisplays[idx];
        });
        
        sectionTitles.forEach((el, idx) => {
            el.style.display = originalTitleDisplays[idx];
        });
        
        // Restore scroll properties
        scrollableElements.forEach((el, idx) => {
            el.style.overflow = originalOverflows[idx].overflow;
            el.style.overflowX = originalOverflows[idx].overflowX;
            el.style.overflowY = originalOverflows[idx].overflowY;
            el.style.maxHeight = originalOverflows[idx].maxHeight;
            el.style.height = originalOverflows[idx].height;
            el.style.width = originalOverflows[idx].width;
        });
        
        // Restore table wrapper styles
        tableWrappers.forEach((wrapper, idx) => {
            wrapper.style.overflow = originalWrapperStyles[idx].overflow;
            wrapper.style.overflowX = originalWrapperStyles[idx].overflowX;
            wrapper.style.overflowY = originalWrapperStyles[idx].overflowY;
            wrapper.style.maxHeight = originalWrapperStyles[idx].maxHeight;
            wrapper.style.height = originalWrapperStyles[idx].height;
        });
        
        // Restore table widths
        tables.forEach((table, idx) => {
            table.style.width = originalTableWidths[idx];
        });
        
        console.error('ìº¡ì²˜ ì˜¤ë¥˜:', err);
        alert('ìº¡ì²˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        btn.disabled = false;
        btn.innerHTML = '<span style="font-size: 16px;">ğŸ“¸</span><span>ì „ì²´ ìº¡ì²˜</span>';
    });
}

function toggleChangeBadge(tableId) {
    const t = document.getElementById(tableId);
    if(t) t.classList.toggle('hide-changes');
}
function highlightLowROAS(bodyId, inputId) {
    const tbody = document.getElementById(bodyId);
    const val = parseFloat(document.getElementById(inputId).value);
    if(isNaN(val)) return;
    tbody.querySelectorAll('tr[data-roas]').forEach(tr => {
        const r = parseFloat(tr.getAttribute('data-roas'));
        if(r < val) tr.classList.add('low-roas'); else tr.classList.remove('low-roas');
    });
}
function filterRedRows(bodyId) {
    const tbody = document.getElementById(bodyId);
    const mode = tbody.getAttribute('data-filter-mode');
    if (mode === 'on') {
        tbody.querySelectorAll('tr').forEach(tr => tr.classList.remove('filtered-out'));
        tbody.setAttribute('data-filter-mode', 'off');
    } else {
        tbody.querySelectorAll('tr').forEach(tr => {
            if(!tr.classList.contains('low-roas') && !tr.classList.contains('total-row') && !tr.classList.contains('prev-total-row')) {
                 tr.classList.add('filtered-out');
            }
        });
        tbody.setAttribute('data-filter-mode', 'on');
    }
}
function applyROASFilter(bodyId, direction, inputId) {
    const tbody = document.getElementById(bodyId);
    const threshold = parseFloat(document.getElementById(inputId).value);
    if (isNaN(threshold)) {
        alert('ROAS ê¸°ì¤€ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    tbody.querySelectorAll('tr.collapsible').forEach(tr => {
        const roas = parseFloat(tr.getAttribute('data-roas')) || 0;
        let shouldShow = false;
        
        if (direction === 'up') {
            shouldShow = roas >= threshold;
        } else if (direction === 'down') {
            shouldShow = roas <= threshold && roas > 0;
        }
        
        if (shouldShow) {
            tr.classList.remove('filtered-out');
        } else {
            tr.classList.add('filtered-out');
        }
    });
    
    // Update data-filter-mode to indicate filter is active
    tbody.setAttribute('data-filter-mode', 'roas-' + direction);
}
function clearROASFilter(bodyId) {
    const tbody = document.getElementById(bodyId);
    tbody.querySelectorAll('tr').forEach(tr => {
        tr.classList.remove('low-roas');
        tr.classList.remove('filtered-out');
    });
    tbody.setAttribute('data-filter-mode', 'off');
}
function parseNumber(v){ if(v===undefined||v===null) return 0; return parseFloat(String(v).replace(/,/g,''))||0; }

/* ============ ì—…ë¡œë“œ/íŒŒì‹± ============ */
function handleUpload(ev, kind){
    const file=ev.target.files[0]; if(!file) return;
    document.getElementById('loadingIndicator').style.display = 'block';
    const fileName = kind === 'raw' ? 'fileName1' : 'fileName2';
    document.getElementById(fileName).textContent = 'âœ“ ' + (file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name);
    
    const reader=new FileReader();
    reader.onload=e=>{
        try{
            if(file.name.endsWith('.csv')) parseCSV(e.target.result,kind);
            else parseXLSX(e.target.result,kind);
            showStatus(`âœ… ${kind.toUpperCase()} ë¡œë“œ ì™„ë£Œ: ${kind==='raw'?rawRows.length:raw2Rows.length}í–‰`,'success');
            processData();
        }catch(err){ console.error(err); showStatus('âŒ ì˜¤ë¥˜: '+err.message,'error'); }
        finally {
            document.getElementById('loadingIndicator').style.display = 'none';
        }
    };
    reader.readAsArrayBuffer(file);
}

/* Drag and Drop for Data Upload */
function setupDragAndDrop() {
    const dropZones = [
        { zone: 'dropZone1', input: 'fileInputRaw', type: 'raw' },
        { zone: 'dropZone2', input: 'fileInputRaw2', type: 'raw2' }
    ];
    
    dropZones.forEach(({ zone, input, type }) => {
        const dropZone = document.getElementById(zone);
        if (!dropZone) return;
        
        dropZone.addEventListener('click', () => document.getElementById(input).click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById(input);
                fileInput.files = files;
                handleUpload({ target: fileInput }, type);
            }
        });
    });
}

/* Drag and Drop for Shopping Dashboard */
function setupShoppingDragAndDrop() {
    const shopZones = [
        { zone: 'dropZoneShop1', input: 'tsvFile', label: 'tsvFileName' },
        { zone: 'dropZoneShop2', input: 'csvFile', label: 'csvFileName' }
    ];
    
    shopZones.forEach(({ zone, input, label }) => {
        const dropZone = document.getElementById(zone);
        const fileInput = document.getElementById(input);
        const fileLabel = document.getElementById(label);
        if (!dropZone || !fileInput) return;
        
        dropZone.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileLabel.textContent = 'ğŸ“„ ' + e.target.files[0].name;
            }
        });
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                fileLabel.textContent = 'ğŸ“„ ' + files[0].name;
            }
        });
    });
}

/* CPC Toggle for ì¦ê°ìœ¨ */
function toggleCPCChanges() {
    const upTable = document.getElementById('cpcUpTable');
    const downTable = document.getElementById('cpcDownTable');
    const isHidden = upTable.classList.contains('hide-changes');
    
    if (isHidden) {
        upTable.classList.remove('hide-changes');
        downTable.classList.remove('hide-changes');
    } else {
        upTable.classList.add('hide-changes');
        downTable.classList.add('hide-changes');
    }
}

// Initialize drag-and-drop when page loads
window.addEventListener('DOMContentLoaded', () => {
    setupDragAndDrop();
    setupShoppingDragAndDrop();
});
function parseCSV(buf, kind){
    const text=new TextDecoder('utf-8').decode(buf);
    const lines=text.split('\n').map(l=>l.trim()).filter(Boolean);
    const rows=[];
    for(let i=2;i<lines.length;i++){
        const v=parseCSVLine(lines[i]);
        if(kind==='raw' && v.length>=15) rows.push(mapRaw(v));
        if(kind==='raw2' && v.length>=15) rows.push(mapRaw2(v));
    }
    if(kind==='raw') rawRows=rows; else raw2Rows=rows;
}
function parseXLSX(buf, kind){
    const wb=XLSX.read(new Uint8Array(buf), {type:'array'});
    const sheet=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(sheet,{header:1});
    const mapped=[];
    for(let i=2;i<rows.length;i++){
        const r=rows[i]; if(!r) continue;
        if(kind==='raw' && r.length>=15) mapped.push(mapRaw(r));
        if(kind==='raw2' && r.length>=15) mapped.push(mapRaw2(r));
    }
    if(kind==='raw') rawRows=mapped; else raw2Rows=mapped;
}
function mapRaw(v){
    return { day:v[COLS_RAW.DAY], week:v[COLS_RAW.WEEK], campaignType:v[COLS_RAW.CAMPAIGN_TYPE],
        campaign:v[COLS_RAW.CAMPAIGN], adgroup:v[COLS_RAW.ADGROUP], time:v[COLS_RAW.TIME], dow:v[COLS_RAW.DOW],
        media:v[COLS_RAW.MEDIA], device:v[COLS_RAW.DEVICE],
        cost:parseNumber(v[COLS_RAW.COST]), impressions:parseNumber(v[COLS_RAW.IMP]), clicks:parseNumber(v[COLS_RAW.CLK]),
        conversions:parseNumber(v[COLS_RAW.CONV]), revenue:parseNumber(v[COLS_RAW.REV]), pos:parseNumber(v[COLS_RAW.POS]) };
}
function mapRaw2(v){
    return { day:v[COLS_RAW2.DAY], week:v[COLS_RAW2.WEEK], campaignType:v[COLS_RAW2.CAMPAIGN_TYPE],
        campaign:v[COLS_RAW2.CAMPAIGN], adgroup:v[COLS_RAW2.ADGROUP], keyword:v[COLS_RAW2.KEYWORD],
        media:v[COLS_RAW2.MEDIA], device:v[COLS_RAW2.DEVICE], scType:v[COLS_RAW2.SEARCH_OR_CONTENT],
        cost:parseNumber(v[COLS_RAW2.COST]), impressions:parseNumber(v[COLS_RAW2.IMP]), clicks:parseNumber(v[COLS_RAW2.CLK]),
        conversions:parseNumber(v[COLS_RAW2.CONV]), revenue:parseNumber(v[COLS_RAW2.REV]), pos:parseNumber(v[COLS_RAW2.POS]) };
}

/* ============ ì§‘ê³„/ì§€í‘œ ============ */
function calcMetrics(arr){
    const cost=sum(arr,'cost'), imp=sum(arr,'impressions'), clk=sum(arr,'clicks'), conv=sum(arr,'conversions'), rev=sum(arr,'revenue');
    const ctr=imp>0?(clk/imp)*100:0, cpc=clk>0?cost/clk:0, cvr=clk>0?(conv/clk)*100:0, cpa=conv>0?cost/conv:0, roas=cost>0?(rev/cost)*100:0;
    const aov=conv>0?rev/conv:0, cor=rev>0?(cost/rev)*100:0;
    return {cost, impressions:imp, clicks:clk, conversions:conv, revenue:rev, ctr, cpc, cvr, cpa, roas, aov, cor};
}
function aggregate(data, keyFn){
    const map={};
    data.forEach(d=>{
        const k=keyFn(d);
        if(!map[k]) map[k]={cost:0, impressions:0, clicks:0, conversions:0, revenue:0, sample:d, campaignType:d.campaignType, campaign:d.campaign, adgroup:d.adgroup, device:d.device, media:d.media};
        map[k].cost+=d.cost; map[k].impressions+=d.impressions; map[k].clicks+=d.clicks; map[k].conversions+=d.conversions; map[k].revenue+=d.revenue;
        map[k].campaignType = d.campaignType || map[k].campaignType;
        map[k].campaign = d.campaign || map[k].campaign;
        map[k].adgroup = d.adgroup || map[k].adgroup;
        map[k].device = d.device || map[k].device;
        map[k].media = d.media || map[k].media;
    });
    return map;
}

/* ============ ë©”ì¸ ì²˜ë¦¬ ============ */
function processData(){
    if(rawRows.length===0) return;
    weeks=[...new Set(rawRows.map(d=>d.week))].sort().reverse().slice(0,4);
    const curW=weeks[0], prevW=weeks[1];
    currentWeekData=rawRows.filter(d=>d.week===curW);
    previousWeekData=rawRows.filter(d=>d.week===prevW);
    document.getElementById('mainDateRange').textContent = weeks.length ? `${weeks[weeks.length-1]} ~ ${weeks[0]}` : '';
    populateFilters();
    initRankFilters();
    updateAll();
}
function populateFilters(){
    const types=[...new Set(rawRows.map(d=>d.campaignType||'').filter(Boolean))].sort();
    const camps=[...new Set(rawRows.map(d=>d.campaign||'').filter(Boolean))].sort();
    const adgs=[...new Set(rawRows.map(d=>d.adgroup||'').filter(Boolean))].sort();
    const medias=[...new Set(raw2Rows.map(d=>d.media||'').filter(Boolean))].sort();
    const setOpts=(id,arr,label)=>{ const el=document.getElementById(id); if(!el) return; el.innerHTML=`<option value="">${label}</option>`+arr.map(v=>`<option value="${v}">${v}</option>`).join(''); };
    setOpts('campaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('adgroupCampaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('keywordCampaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('mediaCampaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('efficiencyCampaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('cpcCampaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('deviceCampaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('budgetSimCampaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('adgroupCampaignFilter', camps, 'ìº í˜ì¸ ì „ì²´');
    setOpts('keywordCampaignFilter', camps, 'ìº í˜ì¸ ì „ì²´');
    setOpts('mediaCampaignFilter', camps, 'ìº í˜ì¸ ì „ì²´');
    setOpts('efficiencyCampaignFilter', camps, 'ìº í˜ì¸ ì „ì²´');
    setOpts('cpcCampaignFilter', camps, 'ìº í˜ì¸ ì „ì²´');
    setOpts('campaignCampaignFilter', camps, 'ìº í˜ì¸ ì „ì²´');
    setOpts('budgetSimCampaignFilter', camps, 'ìº í˜ì¸ ì „ì²´');
    setOpts('campaignAdgroupFilter', adgs, 'ê´‘ê³ ê·¸ë£¹ ì „ì²´');
    setOpts('mediaAdgroupFilter', adgs, 'ê´‘ê³ ê·¸ë£¹ ì „ì²´');
    setOpts('adgroupAdgroupFilter', adgs, 'ê´‘ê³ ê·¸ë£¹ ì „ì²´');
    setOpts('keywordAdgroupFilter', adgs, 'ê´‘ê³ ê·¸ë£¹ ì „ì²´');
    setOpts('budgetSimAdgroupFilter', adgs, 'ê´‘ê³ ê·¸ë£¹ ì „ì²´');
    setOpts('budgetSimMediaFilter', medias, 'ë§¤ì²´ ì „ì²´');
}
function updateAll(){
    updateStats();
    updateCampaignTable();
    updateAdgroupTable();
    updateKeywordTable(true);
    updateMediaTable();
    updateEfficiencyAnalysis();
    updateCPCAnalysis();
    updateDeviceTables();
    createCharts();
    updateStackedChart();
    updateBudgetSimulation();
    updateForecast();
    updateDayWeekAnalysis();
}

/* ============ ì¹´ë“œ(ì„±ê³¼ ìš”ì•½) ============ */
function renderDeltaRow(label, change, baseVal){
    const up = change>=0;
    const arrow = up ? 'â–²' : 'â–¼';
    const cls = up ? 'delta-up' : 'delta-down';
    return `<div class="delta-row"><span class="delta-label">${label} (${baseVal})</span><span class="delta-val ${cls}"><span class="delta-icon">${arrow}</span>${Math.abs(change).toFixed(1)}%</span></div>`;
}
function updateStats(){
    const cur = calcMetrics(currentWeekData);
    const prev = calcMetrics(previousWeekData);
    const fourWeeks = rawRows.filter(d=>weeks.includes(d.week));
    // Aggregate 4-week totals first, then derive metrics from totals
    const fourTotals = {
        cost: sum(fourWeeks, 'cost'),
        impressions: sum(fourWeeks, 'impressions'),
        clicks: sum(fourWeeks, 'clicks'),
        conversions: sum(fourWeeks, 'conversions'),
        revenue: sum(fourWeeks, 'revenue')
    };
    const denom = weeks.length || 1;
    // Divide totals by number of weeks to get averages
    const avg4 = {
        cost: fourTotals.cost / denom,
        impressions: fourTotals.impressions / denom,
        clicks: fourTotals.clicks / denom,
        conversions: fourTotals.conversions / denom,
        revenue: fourTotals.revenue / denom,
        // Derive rates from aggregated totals, not from averaging per-week rates
        ctr: fourTotals.impressions > 0 ? (fourTotals.clicks / fourTotals.impressions) * 100 : 0,
        cpc: fourTotals.clicks > 0 ? fourTotals.cost / fourTotals.clicks : 0,
        cvr: fourTotals.clicks > 0 ? (fourTotals.conversions / fourTotals.clicks) * 100 : 0,
        cpa: fourTotals.conversions > 0 ? fourTotals.cost / fourTotals.conversions : 0,
        roas: fourTotals.cost > 0 ? (fourTotals.revenue / fourTotals.cost) * 100 : 0,
        aov: fourTotals.conversions > 0 ? fourTotals.revenue / fourTotals.conversions : 0,
        cor: fourTotals.revenue > 0 ? (fourTotals.cost / fourTotals.revenue) * 100 : 0
    };
    const fields = [
        {key:'cost', label:'ê´‘ê³ ë¹„'}, {key:'impressions', label:'ë…¸ì¶œìˆ˜'}, {key:'clicks', label:'í´ë¦­ìˆ˜'},
        {key:'conversions', label:'ì „í™˜ìˆ˜'}, {key:'revenue', label:'ë§¤ì¶œì•¡'}, {key:'ctr', label:'í´ë¦­ìœ¨'},
        {key:'cvr', label:'ì „í™˜ìœ¨'}, {key:'cpc', label:'CPC'}, {key:'cpa', label:'ì „í™˜ë‹¹ë¹„ìš©'},
        {key:'roas', label:'ROAS'}, {key:'aov', label:'í‰ê·  ì£¼ë¬¸ ê¸ˆì•¡'}, {key:'cor', label:'ë§¤ì¶œì•¡ ëŒ€ë¹„ ê´‘ê³ ë¹„'}
    ];
    const wrap = document.getElementById('statsContainer');
    wrap.innerHTML = fields.map(f=>{
        const curV=cur[f.key]||0, prevV=prev[f.key]||0, avgV=avg4[f.key]||0;
        const chPrev=getChangeRate(curV, prevV);
        const chAvg=getChangeRate(curV, avgV);
        return `<div class="stat-card">
            <div class="stat-title">${f.label}</div>
            <div class="stat-value-main">${formatCardValue(f.key, curV)}</div>
            <div class="delta-box">
                ${renderDeltaRow('vs ì§€ë‚œì£¼', chPrev, formatCardValue(f.key, prevV))}
                ${renderDeltaRow('vs 4ì£¼í‰ê· ', chAvg, formatCardValue(f.key, avgV))}
            </div>
        </div>`;
    }).join('');
    document.getElementById('uploadStats').innerHTML = fields.map(f=>`<div><strong>${f.label}:</strong> ${formatCardValue(f.key, cur[f.key])}</div>`).join('');
}

/* ============ ì°¨íŠ¸(4ì£¼ ì¶”ì´) ============ */
function createCharts(){
    const container=document.getElementById('overviewCharts');
    if(!weeks.length){ container.innerHTML=''; return; }
    // Reorder charts to match scorecard order: 4 per row
    const metricsList = [
        { key:'cost', label:'ê´‘ê³ ë¹„' }, { key:'impressions', label:'ë…¸ì¶œìˆ˜' }, { key:'clicks', label:'í´ë¦­ìˆ˜' }, { key:'conversions', label:'ì „í™˜ìˆ˜' },
        { key:'revenue', label:'ë§¤ì¶œì•¡' }, { key:'ctr', label:'í´ë¦­ìœ¨' }, { key:'cvr', label:'ì „í™˜ìœ¨' }, { key:'cpc', label:'CPC' },
        { key:'cpa', label:'ì „í™˜ë‹¹ë¹„ìš©' }, { key:'roas', label:'ROAS' }, { key:'aov', label:'í‰ê·  ì£¼ë¬¸ ê¸ˆì•¡' }, { key:'cor', label:'ë§¤ì¶œì•¡ ëŒ€ë¹„ ê´‘ê³ ë¹„' }
    ];
    const labels=weeks.slice().reverse();
    const series={};
    metricsList.forEach(m=>{
        series[m.key]=labels.map(w=>calcMetrics(rawRows.filter(d=>d.week===w))[m.key]||0);
    });
    container.innerHTML = metricsList.map(m=>{
        const id='chart_'+m.key;
        const cur=series[m.key][series[m.key].length-1]||0;
        const prev=series[m.key][series[m.key].length-2]||0;
        const avg=series[m.key].reduce((a,b)=>a+b,0)/series[m.key].length;
        return `<div>
            <div class="chart-caption"><strong>${m.label}</strong> | í˜„ì¬: ${formatCardValue(m.key, cur)} / ì§€ë‚œì£¼: ${formatCardValue(m.key, prev)} / 4ì£¼í‰ê· : ${formatCardValue(m.key, avg)}</div>
            <div class="chart-wrapper"><canvas id="${id}"></canvas></div>
        </div>`;
    }).join('');
    metricsList.forEach(m=>{
        const id='chart_'+m.key; const ctx=document.getElementById(id);
        if(chartKeepers[id]){ chartKeepers[id].destroy(); delete chartKeepers[id]; }
        chartKeepers[id]=new Chart(ctx,{
            type:'line',
            data:{ labels, datasets:[{
                label:m.label, 
                data:series[m.key], 
                borderColor:'#1a7ed5', 
                backgroundColor:'rgba(26,126,213,0.15)', 
                tension:0.25, 
                fill:true, 
                pointRadius:4
            }] },
            options:{ 
                responsive:true, 
                maintainAspectRatio:false, 
                plugins:{
                    legend:{display:false}
                }, 
                scales:{ 
                    y:{
                        beginAtZero:false,
                        grace: '20%',
                        ticks: {
                            display: false
                        },
                        grid: {
                            display: true
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                } 
            },
            plugins: [{
                id: 'pointLabels',
                afterDatasetsDraw(chart) {
                    const { ctx } = chart;
                    const meta = chart.getDatasetMeta(0);
                    meta.data.forEach((point, idx) => {
                        const val = chart.data.datasets[0].data[idx];
                        ctx.fillStyle = '#333';
                        ctx.font = 'bold 10px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        let label;
                        if (m.key === 'ctr' || m.key === 'cvr' || m.key === 'roas' || m.key === 'cor') {
                            label = val.toFixed(1) + '%';
                        } else {
                            label = Math.round(val).toLocaleString();
                        }
                        ctx.fillText(label, point.x, point.y - 5);
                    });
                }
            }]
        });
    });
    document.getElementById('weekCompareTitle').textContent = `${labels[0]} ~ ${labels[labels.length-1]} (4ì£¼ ì¶”ì´)`;
}

/* ============ ì„±ê³¼ ë¹„ì¤‘ ë¶„ì„ (ì „ì²´ ë³´ê¸° ê¸°ë³¸) ============ */
function updateStackedChart() {
    if (currentWeekData.length === 0) return;
    const groupBy = document.getElementById('stackChartType').value;
    const limit = parseInt(document.getElementById('stackLimit').value); // 0ì´ë©´ ì „ì²´ë³´ê¸°
    const grouped = {};
    let total = { cost: 0, impressions: 0, clicks: 0, conversions: 0, revenue: 0 };
    currentWeekData.forEach(d => {
        let key = d[groupBy] || 'ë¯¸ë¶„ë¥˜';
        if (groupBy === 'device') key = (d.device || '').includes('PC') ? 'PC' : 'ëª¨ë°”ì¼';
        if (!grouped[key]) grouped[key] = { cost: 0, impressions: 0, clicks: 0, conversions: 0, revenue: 0 };
        grouped[key].cost += d.cost; grouped[key].impressions += d.impressions;
        grouped[key].clicks += d.clicks; grouped[key].conversions += d.conversions;
        grouped[key].revenue += d.revenue;
        total.cost += d.cost; total.impressions += d.impressions; total.clicks += d.clicks;
        total.conversions += d.conversions; total.revenue += d.revenue;
    });
    let sortedKeys = Object.keys(grouped).sort((a, b) => grouped[b].cost - grouped[a].cost);
    let finalKeys;
    if (limit === 0) {
        finalKeys = sortedKeys;
    } else {
        finalKeys = sortedKeys.slice(0, limit);
        const otherKeys = sortedKeys.slice(limit);
        if (otherKeys.length > 0) {
            grouped['ê¸°íƒ€'] = { cost: 0, impressions: 0, clicks: 0, conversions: 0, revenue: 0 };
            otherKeys.forEach(k => {
                grouped['ê¸°íƒ€'].cost += grouped[k].cost; grouped['ê¸°íƒ€'].impressions += grouped[k].impressions;
                grouped['ê¸°íƒ€'].clicks += grouped[k].clicks; grouped['ê¸°íƒ€'].conversions += grouped[k].conversions;
                grouped['ê¸°íƒ€'].revenue += grouped[k].revenue;
            });
            finalKeys.push('ê¸°íƒ€');
        }
    }
    const yLabels = ['ê´‘ê³ ë¹„', 'ë…¸ì¶œìˆ˜', 'í´ë¦­ìˆ˜', 'ì „í™˜ìˆ˜', 'ë§¤ì¶œì•¡'];
    const metricKeys = ['cost', 'impressions', 'clicks', 'conversions', 'revenue'];
    
    const datasets = finalKeys.map((key, index) => {
        const data = metricKeys.map(m => total[m] > 0 ? (grouped[key][m] / total[m] * 100) : 0);
        const color = colorPalette[index % colorPalette.length];
        return {
            label: key, 
            data: data, 
            backgroundColor: color,
            borderColor: '#fff', 
            borderWidth: 1, 
            rawValues: metricKeys.map(m => grouped[key][m]),
            originalColor: color
        };
    });

    const ctx = document.getElementById('stackedBarChart').getContext('2d');
    if (stackedChartInstance) stackedChartInstance.destroy();
    
    let highlightedLabel = null;

    stackedChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: yLabels, datasets: datasets },
        options: {
            indexAxis: 'y', 
            responsive: true, 
            maintainAspectRatio: false,
            onClick: (e, activeElements, chart) => {
                if (activeElements.length > 0) {
                    const datasetIndex = activeElements[0].datasetIndex;
                    const clickedLabel = chart.data.datasets[datasetIndex].label;

                    if (highlightedLabel === clickedLabel) {
                        highlightedLabel = null;
                        chart.data.datasets.forEach(ds => ds.backgroundColor = ds.originalColor);
                    } else {
                        highlightedLabel = clickedLabel;
                        chart.data.datasets.forEach(ds => {
                            if (ds.label === clickedLabel) {
                                ds.backgroundColor = ds.originalColor;
                            } else {
                                ds.backgroundColor = '#e0e0e0';
                            }
                        });
                    }
                    chart.update();
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            let label = ctx.dataset.label || '';
                            let val = ctx.parsed.x;
                            let raw = ctx.dataset.rawValues[ctx.dataIndex];
                            let rawStr = Math.round(raw).toLocaleString();
                            if(ctx.label==='ê´‘ê³ ë¹„'||ctx.label==='ë§¤ì¶œì•¡') rawStr+='ì›';
                            return `${label}: ${val.toFixed(1)}% (${rawStr})`;
                        }
                    }
                },
                legend: { 
                    position: 'top', 
                    labels: { boxWidth: 12, font: { size: 11 } },
                    onClick: (e, legendItem, legend) => {
                        const clickedLabel = legendItem.text;
                        const chart = legend.chart;
                        
                        if (highlightedLabel === clickedLabel) {
                            highlightedLabel = null;
                            chart.data.datasets.forEach(ds => ds.backgroundColor = ds.originalColor);
                        } else {
                            highlightedLabel = clickedLabel;
                            chart.data.datasets.forEach(ds => {
                                if (ds.label === clickedLabel) {
                                    ds.backgroundColor = ds.originalColor;
                                } else {
                                    ds.backgroundColor = '#e0e0e0';
                                }
                            });
                        }
                        chart.update();
                    }
                }
            },
            scales: { x: { stacked: true, min: 0, max: 100, ticks: { callback: v => v + '%' } }, y: { stacked: true } }
        },
        plugins: [{
            id: 'percentLabel',
            afterDatasetsDraw(chart) {
                const { ctx } = chart;
                chart.data.datasets.forEach((ds, i) => {
                    const meta = chart.getDatasetMeta(i);
                    if (!meta.hidden) {
                        meta.data.forEach((el, idx) => {
                            const val = ds.data[idx];
                            if (val >= 2) {
                                ctx.fillStyle = (ds.backgroundColor === '#e0e0e0') ? '#999' : '#333'; 
                                ctx.font = 'bold 11px sans-serif';
                                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                                const centerX = (el.x + el.base) / 2;
                                ctx.fillText(val.toFixed(1) + '%', centerX, el.y);
                            }
                        });
                    }
                });
            }
        }]
    });
}

/* ============ ìˆœìœ„ ë¶„ì„ ë¡œì§ ============ */
function initRankFilters() {
    const populate = (id, field, source) => {
        const el = document.getElementById(id);
        if(!el) return;
        const set = new Set(source.map(r => r[field]).filter(v => v));
        el.innerHTML = '<option value="">ì „ì²´</option>';
        Array.from(set).sort().forEach(v => el.innerHTML += `<option value="${v}">${v}</option>`);
    };
    populate('trendCT', 'campaignType', raw2Rows);
    populate('trendCamp', 'campaign', raw2Rows);
    populate('trendAdg', 'adgroup', raw2Rows);
    populate('trendMedia', 'media', raw2Rows);
    populate('heatCT', 'campaignType', rawRows);
    populate('heatCamp', 'campaign', rawRows);
    populate('heatAdg', 'adgroup', rawRows);
    populate('heatMedia', 'media', rawRows);
    // Populate time analysis filters
    populate('timeAnalysisCT', 'campaignType', rawRows);
    populate('timeAnalysisCamp', 'campaign', rawRows);
    populate('timeAnalysisAdg', 'adgroup', rawRows);
    populate('timeAnalysisMedia', 'media', rawRows);
}
function updateRankTrend() {
    const ct = document.getElementById('trendCT').value;
    const cp = document.getElementById('trendCamp').value;
    const adg = document.getElementById('trendAdg').value;
    const med = document.getElementById('trendMedia').value;
    const inputVal = document.getElementById('trendKw').value;
    if(!inputVal.trim()) return; 
    const kws = inputVal.split(',').map(s=>s.trim()).filter(s=>s);

    const baseData = raw2Rows.filter(r => 
        (!ct || r.campaignType === ct) && 
        (!cp || r.campaign === cp) && 
        (!adg || r.adgroup === adg) &&
        (!med || r.media === med)
    );

    const dates = [...new Set(baseData.map(r=>r.day))].sort().slice(-14);
    
    const datasets = kws.map((k, i) => {
        const data = dates.map(d => {
            const target = baseData.filter(r => r.day === d && r.keyword === k && r.pos > 0);
            if(target.length === 0) return null;
            const avg = target.reduce((s,r)=>s+r.pos,0) / target.length;
            return avg;
        });
        const colors = ['#007bff','#28a745','#dc3545','#ffc107','#17a2b8', '#6610f2', '#e83e8c', '#fd7e14'];
        return { label: k, data, borderColor: colors[i % colors.length], backgroundColor: colors[i % colors.length], tension: 0.1, spanGaps: true, pointRadius: 4 };
    });

    const ctx = document.getElementById('rankTrendChart');
    if(window.trendChartObj) window.trendChartObj.destroy();
    
    window.trendChartObj = new Chart(ctx, {
        type: 'line',
        data: { labels: dates, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { 
                y: { 
                    reverse: true, 
                    min: 1,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return Number.isInteger(value) ? value + 'ìœ„' : '';
                        }
                    },
                    title: {display:true, text:'í‰ê·  ìˆœìœ„ (ìœ„)'} 
                } 
            },
            plugins: {
                tooltip: {
                    callbacks: { label: c => c.dataset.label + ': ' + c.parsed.y.toFixed(1) + 'ìœ„' }
                },
                datalabels: {
                    display: true,
                    align: 'top',
                    color: function(context) {
                        return context.dataset.borderColor;
                    },
                    font: { size: 9, weight: 'bold' },
                    formatter: (val) => val ? val.toFixed(1) + 'ìœ„' : ''
                }
            }
        },
        plugins: [ChartDataLabels]
    });
    
    // Calculate and display rank summary
    const allRanks = datasets.flatMap(ds => ds.data.filter(v => v !== null));
    if (allRanks.length > 0) {
        const minRank = Math.min(...allRanks);
        const maxRank = Math.max(...allRanks);
        const avgRank = allRanks.reduce((a, b) => a + b, 0) / allRanks.length;
        
        document.getElementById('minRank').textContent = minRank.toFixed(1) + 'ìœ„';
        document.getElementById('maxRank').textContent = maxRank.toFixed(1) + 'ìœ„';
        document.getElementById('avgRank').textContent = avgRank.toFixed(1) + 'ìœ„';
        document.getElementById('rankSummary').style.display = 'flex';
    } else {
        document.getElementById('rankSummary').style.display = 'none';
    }
}

let selectedHeatmapWeek = 0;

function setHeatmapWeek(weekOffset) {
    selectedHeatmapWeek = weekOffset;
    // Update button styles
    for(let i = 0; i <= 3; i++) {
        const btn = document.getElementById('heatWeek' + i);
        if(btn) {
            btn.style.background = (i === weekOffset) ? '#007bff' : '#6c757d';
        }
    }
    // Update label
    const labels = ['ì§€ë‚œì£¼', '2ì£¼ì „', '3ì£¼ì „', '4ì£¼ì „'];
    document.getElementById('heatmapPeriodLabel').textContent = labels[weekOffset] || 'ì§€ë‚œì£¼';
    // Refresh heatmap
    updateRankHeatmap();
}

function updateRankHeatmap() {
    const ct = document.getElementById('heatCT').value;
    const cp = document.getElementById('heatCamp').value;
    const adg = document.getElementById('heatAdg').value;
    const med = document.getElementById('heatMedia').value;

    // Filter by selected week
    const targetWeek = weeks[selectedHeatmapWeek] || weeks[0];
    
    const data = rawRows.filter(r => 
        r.week === targetWeek &&
        (!ct || r.campaignType===ct) && 
        (!cp || r.campaign===cp) && 
        (!adg || r.adgroup===adg) &&
        (!med || r.media===med)
    );

    const days = ['ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼','í† ìš”ì¼','ì¼ìš”ì¼'];
    const times = Array.from({length:24}, (_,i) => {
        const h = i < 10 ? '0' + i : i;
        const h2 = (i + 1) % 24;
        const h2str = h2 < 10 ? '0' + h2 : h2;
        return h + 'ì‹œ~' + h2str + 'ì‹œ';
    });
    
    const grid = {};
    const dayTotals = {}; // For TOTAL column
    const timeTotals = {}; // For TOTAL row
    let grandTotal = { sum: 0, cnt: 0 };
    
    data.forEach(r => {
        if(r.pos > 0 && r.dow && r.time) {
            // Normalize time label to handle both "23~00" and "23~24" cases
            let normalizedTime = r.time;
            if (normalizedTime === '23~00') {
                normalizedTime = '23ì‹œ~00ì‹œ';
            }
            
            const key = `${r.dow}_${normalizedTime}`;
            if(!grid[key]) grid[key] = {sum:0, cnt:0};
            grid[key].sum += r.pos;
            grid[key].cnt++;
            
            // Track day totals
            if(!dayTotals[r.dow]) dayTotals[r.dow] = {sum:0, cnt:0};
            dayTotals[r.dow].sum += r.pos;
            dayTotals[r.dow].cnt++;
            
            // Track time totals
            if(!timeTotals[normalizedTime]) timeTotals[normalizedTime] = {sum:0, cnt:0};
            timeTotals[normalizedTime].sum += r.pos;
            timeTotals[normalizedTime].cnt++;
            
            // Grand total
            grandTotal.sum += r.pos;
            grandTotal.cnt++;
        }
    });

    let html = '<table class="rank-heatmap-table" style="width:100%; border-collapse:collapse; font-size:11px;">';
    html += '<thead><tr><th style="background:#f8f9fa; padding:8px; border:1px solid #ddd; color:#333;">ì‹œê°„/ìš”ì¼</th>' + 
            days.map(d=>`<th style="background:#f8f9fa; padding:8px; border:1px solid #ddd; color:#333;">${d}</th>`).join('') + 
            '<th style="background:#e3f2fd; padding:8px; border:1px solid #ddd; color:#0d47a1; font-weight:bold;">TOTAL</th>' +
            '</tr></thead><tbody>';
    
    times.forEach(t => {
        html += `<tr><td style="background:#eee; font-weight:bold; padding:8px; border:1px solid #ddd; text-align:center; color:#333;">${t}</td>`;
        days.forEach(d => {
            const k = `${d}_${t}`;
            const cell = grid[k];
            if(cell) {
                const avg = cell.sum / cell.cnt;
                const alpha = Math.max(0.1, 1 - (avg / 15)); 
                html += `<td style="background:rgba(40,167,69,${alpha}); color:${alpha > 0.5 ? '#fff':'#333'}; padding:8px; border:1px solid #ddd; text-align:center;">${avg.toFixed(1)}ìœ„</td>`;
            } else {
                html += '<td style="padding:8px; border:1px solid #ddd; text-align:center; color:#ccc;">-</td>';
            }
        });
        // TOTAL column for this time slot
        const timeTotal = timeTotals[t];
        if (timeTotal) {
            const avg = timeTotal.sum / timeTotal.cnt;
            html += `<td style="background:#e3f2fd; padding:8px; border:1px solid #ddd; text-align:center; font-weight:bold; color:#0d47a1;">${avg.toFixed(1)}ìœ„</td>`;
        } else {
            html += '<td style="background:#e3f2fd; padding:8px; border:1px solid #ddd; text-align:center; color:#ccc;">-</td>';
        }
        html += '</tr>';
    });
    
    // TOTAL row
    html += '<tr><td style="background:#e3f2fd; font-weight:bold; padding:8px; border:1px solid #ddd; text-align:center; color:#0d47a1;">TOTAL</td>';
    days.forEach(d => {
        const dayTotal = dayTotals[d];
        if (dayTotal) {
            const avg = dayTotal.sum / dayTotal.cnt;
            html += `<td style="background:#e3f2fd; padding:8px; border:1px solid #ddd; text-align:center; font-weight:bold; color:#0d47a1;">${avg.toFixed(1)}ìœ„</td>`;
        } else {
            html += '<td style="background:#e3f2fd; padding:8px; border:1px solid #ddd; text-align:center; color:#ccc;">-</td>';
        }
    });
    // Grand total
    if (grandTotal.cnt > 0) {
        const avg = grandTotal.sum / grandTotal.cnt;
        html += `<td style="background:#bbdefb; padding:8px; border:1px solid #ddd; text-align:center; font-weight:bold; color:#0d47a1;">${avg.toFixed(1)}ìœ„</td>`;
    } else {
        html += '<td style="background:#bbdefb; padding:8px; border:1px solid #ddd; text-align:center; color:#ccc;">-</td>';
    }
    html += '</tr>';
    
    html += '</tbody></table>';
    
    document.getElementById('rankHeatmapContainer').innerHTML = html;
}

/* ============ ì‹œê°„ëŒ€ ë¶„ì„ (Time Analysis) ============ */
let selectedTimeAnalysisWeek = 0;

function setTimeAnalysisWeek(weekOffset) {
    selectedTimeAnalysisWeek = weekOffset;
    // Update button styles
    for(let i = 0; i <= 3; i++) {
        const btn = document.getElementById('timeWeek' + i);
        if(btn) {
            btn.style.background = (i === weekOffset) ? '#007bff' : '#6c757d';
        }
    }
    const totalBtn = document.getElementById('timeWeekTotal');
    if(totalBtn) {
        totalBtn.style.background = (weekOffset === 'total') ? '#007bff' : '#6c757d';
    }
    // Update label
    const labels = ['ì§€ë‚œì£¼', '2ì£¼ì „', '3ì£¼ì „', '4ì£¼ì „'];
    document.getElementById('timeAnalysisPeriodLabel').textContent = weekOffset === 'total' ? 'ì „ì²´ 4ì£¼' : (labels[weekOffset] || 'ì§€ë‚œì£¼');
    // Refresh heatmap
    updateTimeAnalysisHeatmap();
}

function updateTimeAnalysisHeatmap() {
    const metric = document.getElementById('timeMetricSelect').value;
    const ct = document.getElementById('timeAnalysisCT').value;
    const cp = document.getElementById('timeAnalysisCamp').value;
    const adg = document.getElementById('timeAnalysisAdg').value;
    const med = document.getElementById('timeAnalysisMedia').value;

    // Filter by selected week(s)
    let data;
    if (selectedTimeAnalysisWeek === 'total') {
        // Get all 4 weeks
        data = rawRows.filter(r => 
            weeks.includes(r.week) &&
            (!ct || r.campaignType===ct) && 
            (!cp || r.campaign===cp) && 
            (!adg || r.adgroup===adg) &&
            (!med || r.media===med)
        );
    } else {
        const targetWeek = weeks[selectedTimeAnalysisWeek] || weeks[0];
        data = rawRows.filter(r => 
            r.week === targetWeek &&
            (!ct || r.campaignType===ct) && 
            (!cp || r.campaign===cp) && 
            (!adg || r.adgroup===adg) &&
            (!med || r.media===med)
        );
    }

    const days = ['ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼','í† ìš”ì¼','ì¼ìš”ì¼'];
    const times = Array.from({length:24}, (_,i) => {
        const h = i < 10 ? '0' + i : i;
        const h2 = (i + 1) % 24;
        const h2Str = h2 < 10 ? '0' + h2 : h2;
        // Special case for last hour: 23ì‹œ~24ì‹œ instead of 23ì‹œ~00ì‹œ
        if (i === 23) return `${h}ì‹œ~24ì‹œ`;
        return `${h}ì‹œ~${h2Str}ì‹œ`;
    });

    const heatmap = {};
    const dayTotals = {};
    const timeTotals = {};
    let grandTotal = {sum:0, cnt:0};
    let maxVal = 0; // Track maximum value for heatmap coloring
    
    data.forEach(r => {
        if(!r.time || !r.dow) return;
        let normalizedTime = r.time;
        // Normalize 23ì‹œ~00ì‹œ to 23ì‹œ~24ì‹œ for display
        if(normalizedTime === '23ì‹œ~00ì‹œ') normalizedTime = '23ì‹œ~24ì‹œ';
        
        const val = r[metric] || 0;
        
        if(!heatmap[normalizedTime]) heatmap[normalizedTime] = {};
        if(!heatmap[normalizedTime][r.dow]) heatmap[normalizedTime][r.dow] = {sum:0, cnt:0};
        
        // Sum the values
        heatmap[normalizedTime][r.dow].sum += val;
        heatmap[normalizedTime][r.dow].cnt++;
        
        // Update max value for heatmap
        if(heatmap[normalizedTime][r.dow].sum > maxVal) {
            maxVal = heatmap[normalizedTime][r.dow].sum;
        }
        
        // Track day totals
        if(!dayTotals[r.dow]) dayTotals[r.dow] = {sum:0, cnt:0};
        dayTotals[r.dow].sum += val;
        dayTotals[r.dow].cnt++;
        
        // Track time totals
        if(!timeTotals[normalizedTime]) timeTotals[normalizedTime] = {sum:0, cnt:0};
        timeTotals[normalizedTime].sum += val;
        timeTotals[normalizedTime].cnt++;
        
        // Grand total
        grandTotal.sum += val;
        grandTotal.cnt++;
    });

    const metricLabels = {
        cost: 'ê´‘ê³ ë¹„',
        impressions: 'ë…¸ì¶œìˆ˜',
        clicks: 'í´ë¦­ìˆ˜',
        conversions: 'ì „í™˜ìˆ˜',
        revenue: 'ë§¤ì¶œì•¡'
    };

    let html = `<table class="rank-heatmap-table" style="width:100%; border-collapse:collapse; font-size:11px;">`;
    html += `<thead><tr><th style="background:#f8f9fa; padding:8px; border:1px solid #ddd; color:#333;">ì‹œê°„/ìš”ì¼</th>` + 
            days.map(d=>`<th style="background:#f8f9fa; padding:8px; border:1px solid #ddd; color:#333;">${d}</th>`).join('') + 
            `<th style="background:#e3f2fd; padding:8px; border:1px solid #ddd; color:#0d47a1; font-weight:bold;">TOTAL</th>` +
            `</tr></thead><tbody>`;
    
    times.forEach(t => {
        html += `<tr><td style="padding:8px; border:1px solid #ddd; text-align:center; background:#fafafa;">${t}</td>`;
        days.forEach(d => {
            if(heatmap[t] && heatmap[t][d] && heatmap[t][d].sum > 0) {
                const total = heatmap[t][d].sum;
                const color = getHeatColor(total, maxVal);
                html += `<td style="background:${color}; padding:8px; border:1px solid #ddd; text-align:center;">${formatMetricValue(total, metric)}</td>`;
            } else {
                html += `<td style="padding:8px; border:1px solid #ddd; text-align:center; color:#ccc;">-</td>`;
            }
        });
        // Time total
        if (timeTotals[t] && timeTotals[t].sum > 0) {
            const total = timeTotals[t].sum;
            html += `<td style="background:#e3f2fd; padding:8px; border:1px solid #ddd; text-align:center; font-weight:bold; color:#0d47a1;">${formatMetricValue(total, metric)}</td>`;
        } else {
            html += `<td style="background:#e3f2fd; padding:8px; border:1px solid #ddd; text-align:center; color:#ccc;">-</td>`;
        }
        html += `</tr>`;
    });
    
    // TOTAL row
    html += `<tr><td style="background:#e3f2fd; font-weight:bold; padding:8px; border:1px solid #ddd; text-align:center; color:#0d47a1;">TOTAL</td>`;
    days.forEach(d => {
        const dayTotal = dayTotals[d];
        if (dayTotal && dayTotal.sum > 0) {
            const total = dayTotal.sum;
            html += `<td style="background:#e3f2fd; padding:8px; border:1px solid #ddd; text-align:center; font-weight:bold; color:#0d47a1;">${formatMetricValue(total, metric)}</td>`;
        } else {
            html += `<td style="background:#e3f2fd; padding:8px; border:1px solid #ddd; text-align:center; color:#ccc;">-</td>`;
        }
    });
    // Grand total
    if (grandTotal.sum > 0) {
        const total = grandTotal.sum;
        html += `<td style="background:#bbdefb; padding:8px; border:1px solid #ddd; text-align:center; font-weight:bold; color:#0d47a1;">${formatMetricValue(total, metric)}</td>`;
    } else {
        html += `<td style="background:#bbdefb; padding:8px; border:1px solid #ddd; text-align:center; color:#ccc;">-</td>`;
    }
    html += `</tr>`;
    
    html += `</tbody></table>`;
    
    document.getElementById('timeAnalysisHeatmapContainer').innerHTML = html;
}

function formatMetricValue(val, metric) {
    if(['cost', 'revenue'].includes(metric)) {
        return Math.round(val).toLocaleString();
    }
    return Math.round(val).toLocaleString();
}

function getHeatColor(val, maxVal) {
    // Create a color gradient based on value - higher = darker
    if(val === 0 || maxVal === 0) return '#fff';
    
    // Normalize value based on actual max value from data
    const normalized = Math.min(val / maxVal, 1);
    const intensity = 0.2 + (normalized * 0.7); // Range from 0.2 to 0.9
    
    return `rgba(76, 175, 80, ${intensity})`;
}

/* ============ ê³µí†µ í…Œì´ë¸”/í† ê¸€/ì†ŒíŠ¸ ============ */
function addDetailRow(colSpan, key, cur, prev, prevLabelText, avgM){
    const change=(c,p)=>badge(getChangeRate(c,p));
    const fv=(k,v)=>formatCardValue(k,v).replace('ì›','');
    const avgVal = (k) => fv(k, avgM[k]||0);
    // Shorten the week label: extract just the week part if it's a full label
    let shortLabel = prevLabelText;
    if (prevLabelText.includes('ì§€ë‚œ ë°ì´í„°')) {
        shortLabel = weeks[1] || 'ì§€ë‚œì£¼';
    }
    return `<tr class="detail-row" data-parent="${key}" style="display:none">
        <td colspan="${colSpan}">
            <div style="display:flex; gap:20px; align-items:flex-start;">
                <div style="flex:1;">
                    <strong>${shortLabel}</strong>
                    <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:5px;">
                        <span>ê´‘ê³ ë¹„ ${fv('cost', prev.cost||0)} (${change(cur.cost||0, prev.cost||0)})</span>
                        <span>ë…¸ì¶œ ${fv('impressions', prev.impressions||0)} (${change(cur.impressions||0, prev.impressions||0)})</span>
                        <span>í´ë¦­ ${fv('clicks', prev.clicks||0)} (${change(cur.clicks||0, prev.clicks||0)})</span>
                        <span>ì „í™˜ ${fv('conversions', prev.conversions||0)} (${change(cur.conversions||0, prev.conversions||0)})</span>
                        <span>ë§¤ì¶œ ${fv('revenue', prev.revenue||0)} (${change(cur.revenue||0, prev.revenue||0)})</span>
                        <span>ROAS ${fv('roas', prev.roas||0)} (${change(cur.roas||0, prev.roas||0)})</span>
                    </div>
                </div>
                <div style="flex:1; border-left:1px solid #ddd; padding-left:20px;">
                    <strong>4ì£¼ í‰ê· </strong>
                    <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:5px;">
                        <span>ê´‘ê³ ë¹„ ${avgVal('cost')}</span>
                        <span>ë…¸ì¶œ ${avgVal('impressions')}</span>
                        <span>í´ë¦­ ${avgVal('clicks')}</span>
                        <span>ì „í™˜ ${avgVal('conversions')}</span>
                        <span>ë§¤ì¶œ ${avgVal('revenue')}</span>
                        <span>ROAS ${avgVal('roas')}</span>
                    </div>
                </div>
            </div>
        </td>
    </tr>`;
}
function bindRowToggle(bodyId){
    const tbody=document.getElementById(bodyId);
    tbody.querySelectorAll('.collapsible').forEach(r=>{
        r.onclick=()=>{
            const key=r.getAttribute('data-key');
            const detail=tbody.querySelector(`tr.detail-row[data-parent="${key}"]`);
            if(detail) detail.style.display = (detail.style.display==='none'||!detail.style.display)?'table-row':'none';
        };
    });
}
function sortTable(tableId, colIdx){
    const table=document.getElementById(tableId);
    const tbody=table.querySelector('tbody');
    const totalRows=Array.from(tbody.querySelectorAll('tr.total-row, tr.prev-total-row'));
    const pairs=[]; let cur=null;
    Array.from(tbody.querySelectorAll('tr')).forEach(r=>{
        if(r.classList.contains('total-row')||r.classList.contains('prev-total-row')) return;
        if(r.classList.contains('collapsible')){ cur={row:r, detail:null}; pairs.push(cur); }
        else if(r.classList.contains('detail-row') && cur) cur.detail=r;
    });
    const asc=sortDirection[tableId+'-'+colIdx]!=='asc';
    sortDirection[tableId+'-'+colIdx]=asc?'asc':'desc';
    pairs.sort((a,b)=>{
        const getVal=row=>{
            const cell=row.cells[colIdx]; if(!cell) return '';
            const clone=cell.cloneNode(true); clone.querySelectorAll('.badge-mini').forEach(el=>el.remove());
            const t=clone.textContent.trim();
            const num=parseFloat(t.replace(/[^0-9.-]/g,'')); if(!isNaN(num)&&t.replace(/[^0-9.-]/g,'').length>0) return num;
            return t;
        };
        const av=getVal(a.row), bv=getVal(b.row);
        if(typeof av==='number' && typeof bv==='number') return asc?av-bv:bv-av;
        return asc?(''+av).localeCompare(''+bv):(''+bv).localeCompare(''+av);
    });
    tbody.innerHTML=''; totalRows.forEach(r=>tbody.appendChild(r));
    pairs.forEach(p=>{ tbody.appendChild(p.row); if(p.detail) tbody.appendChild(p.detail); });
    table.querySelectorAll('th').forEach((th,i)=>{ th.classList.remove('sort-asc','sort-desc'); if(i===colIdx) th.classList.add(asc?'sort-asc':'sort-desc'); });
    bindRowToggle(tbody.id);
}

/* ============ TOTAL í–‰ (4ì£¼ í‰ê·  ì¦ê°ë¥  ì œê±°) ============ */
function generateTotalRowHTML(list, colSpan, typeKey){
    if(!list || list.length===0) return '';
    
    // Use raw2Rows for keyword analysis, rawRows for others
    const sourceData = (typeKey === 'keyword') ? raw2Rows : rawRows;
    
    // Current week (weeks[0]) - calculate from list
    const total=list.reduce((a,it)=>({ cost:a.cost+it.m.cost, impressions:a.impressions+it.m.impressions, clicks:a.clicks+it.m.clicks, conversions:a.conversions+it.m.conversions, revenue:a.revenue+it.m.revenue }), {cost:0, impressions:0, clicks:0, conversions:0, revenue:0});
    const cur=calcMetrics([total]);
    
    // Previous week (weeks[1]) - calculate directly from raw data for accurate week total
    const prevWeek = weeks[1];
    const prevWeekData = sourceData.filter(d => d.week === prevWeek);
    const prevTotal = {
        cost: sum(prevWeekData, 'cost'),
        impressions: sum(prevWeekData, 'impressions'),
        clicks: sum(prevWeekData, 'clicks'),
        conversions: sum(prevWeekData, 'conversions'),
        revenue: sum(prevWeekData, 'revenue')
    };
    const prev=calcMetrics([prevTotal]);
    
    // 4ì£¼ í‰ê·  - calculate from all 4 weeks
    const fourWeeks=sourceData.filter(d=>weeks.includes(d.week));
    // Calculate 4ì£¼ í‰ê·  using aggregated totals then derive rates
    const fourTotals = {
        cost: sum(fourWeeks, 'cost'),
        impressions: sum(fourWeeks, 'impressions'),
        clicks: sum(fourWeeks, 'clicks'),
        conversions: sum(fourWeeks, 'conversions'),
        revenue: sum(fourWeeks, 'revenue')
    };
    const denom = weeks.length || 1;
    const avg4 = {
        cost: fourTotals.cost / denom,
        impressions: fourTotals.impressions / denom,
        clicks: fourTotals.clicks / denom,
        conversions: fourTotals.conversions / denom,
        revenue: fourTotals.revenue / denom,
        ctr: fourTotals.impressions > 0 ? (fourTotals.clicks / fourTotals.impressions) * 100 : 0,
        cpc: fourTotals.clicks > 0 ? fourTotals.cost / fourTotals.clicks : 0,
        cvr: fourTotals.clicks > 0 ? (fourTotals.conversions / fourTotals.clicks) * 100 : 0,
        cpa: fourTotals.conversions > 0 ? fourTotals.cost / fourTotals.conversions : 0,
        roas: fourTotals.cost > 0 ? (fourTotals.revenue / fourTotals.cost) * 100 : 0
    };

    const keys=['cost','impressions','clicks','ctr','cpc','conversions','cvr','revenue','cpa','roas'];
    const val=(k,m,p)=>`<td class="number"><span class="value-wrapper">${formatCardValue(k,m[k])}</span> <span class="badge-mini">${badge(getChangeRate(m[k], p[k]||0))}</span></td>`;
    const valNoBadge=(k,m)=>`<td class="number"><span class="value-wrapper">${formatCardValue(k,m[k])}</span></td>`;
    const prevCells=keys.map(k=>`<td class="number"><span class="value-wrapper">${formatCardValue(k, prev[k]||0)}</span></td>`).join('');
    const curCells =keys.map(k=>val(k, cur, prev)).join('');
    const avgCells =keys.map(k=>valNoBadge(k, avg4)).join('');
    const labelColSpan=(typeKey==='adgroup')?4:(typeKey==='keyword'?4:3);
    const prevLabel=weeks[1]?`TOTAL (${weeks[1]})`:'TOTAL (ì§€ë‚œì£¼)';
    const curLabel =weeks[0]?`TOTAL (${weeks[0]})`:'TOTAL (ìµœê·¼ì£¼)';
    const avgLabel ='TOTAL (4ì£¼ í‰ê· )';
    // Reorder: 4ì£¼ í‰ê· , ì§€ë‚œì£¼, ìµœê·¼ì£¼
    return `
        <tr class="total-row" style="background:#dff1ff;"><td colspan="${labelColSpan}" style="text-align:center;">${avgLabel}</td>${avgCells}</tr>
        <tr class="prev-total-row"><td colspan="${labelColSpan}" style="text-align:center;">${prevLabel}</td>${prevCells}</tr>
        <tr class="total-row"><td colspan="${labelColSpan}" style="text-align:center;">${curLabel}</td>${curCells}</tr>
    `;
}

/* ============ ìº í˜ì¸/ê´‘ê³ ê·¸ë£¹/í‚¤ì›Œë“œ/ë§¤ì²´ ============ */
function campaignRowCells(it){
    const m=it.m,p=it.pm;
    return [
        ['cost'],['impressions'],['clicks'],['ctr'],['cpc'],['conversions'],['cvr'],['revenue'],['cpa'],['roas']
    ].map(([k])=>`<td class="number"><span class="value-wrapper">${formatCardValue(k,m[k])}</span> <span class="badge-mini">${badge(getChangeRate(m[k], p[k]||0))}</span></td>`).join('');
}
function updateCampaignTable(){
    const tbody=document.getElementById('campaignBody');
    if(!currentWeekData.length){ tbody.innerHTML='<tr><td colspan="13" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>'; return; }
    const filter=(document.getElementById('campaignFilter').value||'').toLowerCase();
    const typeFilter=document.getElementById('campaignTypeFilter').value;
    const deviceFilter=document.getElementById('campaignDeviceFilter').value;
    const campFilter=document.getElementById('campaignCampaignFilter').value;
    const agFilter=document.getElementById('campaignAdgroupFilter').value;
    
    const dataFiltered = currentWeekData.filter(d=>{
        return (!typeFilter||d.campaignType===typeFilter) &&
               (!deviceFilter|| (d.device||'').includes(deviceFilter)) &&
               (!campFilter||d.campaign===campFilter) &&
               (!agFilter||d.adgroup===agFilter);
    });
    const prevFiltered = previousWeekData.filter(d=>{
        return (!typeFilter||d.campaignType===typeFilter) &&
               (!deviceFilter|| (d.device||'').includes(deviceFilter)) &&
               (!campFilter||d.campaign===campFilter) &&
               (!agFilter||d.adgroup===agFilter);
    });

    const curMap=aggregate(dataFiltered, d=>d.campaign||'ë¯¸ë¶„ë¥˜');
    const prevMap=aggregate(prevFiltered, d=>d.campaign||'ë¯¸ë¶„ë¥˜');
    const fourWeeks = rawRows.filter(d=>weeks.includes(d.week) &&
        (!typeFilter||d.campaignType===typeFilter) &&
        (!deviceFilter|| (d.device||'').includes(deviceFilter)) &&
        (!campFilter||d.campaign===campFilter) &&
        (!agFilter||d.adgroup===agFilter)
    );
    const avgMap = aggregate(fourWeeks, d=>d.campaign||'ë¯¸ë¶„ë¥˜');
    const denom = weeks.length || 1;

    const list=Object.keys(curMap).map(k=>{
        const m=calcMetrics([curMap[k]]); 
        const pm=prevMap[k]?calcMetrics([prevMap[k]]):calcMetrics([]);
        let avgM = {cost:0,impressions:0,clicks:0,conversions:0,revenue:0,roas:0};
        if(avgMap[k]) {
            ['cost','impressions','clicks','conversions','revenue'].forEach(key => avgM[key] = avgMap[k][key]/denom);
            avgM.roas = avgM.cost>0 ? (avgM.revenue/avgM.cost)*100 : 0;
        }
        const type=curMap[k].campaignType||'-';
        if(k.toLowerCase().indexOf(filter)===-1) return null;
        return {name:k,type,m,pm,avgM};
    }).filter(Boolean).sort((a,b)=>b.m.conversions-a.m.conversions);

    let html=generateTotalRowHTML(list,13,'campaign');
    const prevLabel=weeks[1]?`${weeks[1]} ì§€ë‚œ ë°ì´í„°`:'ì§€ë‚œ ë°ì´í„°';
    list.forEach((it,idx)=>{
        html+=`<tr class="collapsible" data-key="${it.name}" data-roas="${it.m.roas}">
            <td><span class="rank-badge">${idx+1}</span></td>
            <td class="text-col" title="${it.name}">${it.name}</td>
            <td class="text-col" title="${it.type}">${it.type}</td>
            ${campaignRowCells(it)}
        </tr>`;
        html+=addDetailRow(13,it.name,it.m,it.pm,prevLabel,it.avgM);
    });
    tbody.innerHTML = html || '<tr><td colspan="13" class="no-data">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    bindRowToggle('campaignBody'); clearROASFilter('campaignBody');
}

function adgroupRowCells(it){
    const m=it.m,p=it.pm;
    return [
        ['cost'],['impressions'],['clicks'],['ctr'],['cpc'],['conversions'],['cvr'],['revenue'],['cpa'],['roas']
    ].map(([k])=>`<td class="number"><span class="value-wrapper">${formatCardValue(k,m[k])}</span> <span class="badge-mini">${badge(getChangeRate(m[k], p[k]||0))}</span></td>`).join('');
}
function updateAdgroupTable(){
    const tbody=document.getElementById('adgroupBody');
    if(!currentWeekData.length){ tbody.innerHTML='<tr><td colspan="14" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>'; return; }
    const f=(document.getElementById('adgroupFilter').value||'').toLowerCase();
    const campF=document.getElementById('adgroupCampaignFilter').value;
    const typeF=document.getElementById('adgroupCampaignTypeFilter').value;
    const devF=document.getElementById('adgroupDeviceFilter').value;
    const keyFn=d=>`${d.campaign||'ë¯¸ë¶„ë¥˜'}||${d.adgroup||'ë¯¸ë¶„ë¥˜'}`;
    const cur=aggregate(currentWeekData.filter(d=>
        (!campF||d.campaign===campF)&&(!typeF||d.campaignType===typeF)&&(!devF||(d.device||'').includes(devF))
    ), keyFn);
    const prev=aggregate(previousWeekData.filter(d=>
        (!campF||d.campaign===campF)&&(!typeF||d.campaignType===typeF)&&(!devF||(d.device||'').includes(devF))
    ), keyFn);
    const fourWeeks = rawRows.filter(d=>weeks.includes(d.week) &&
        (!campF||d.campaign===campF)&&(!typeF||d.campaignType===typeF)&&(!devF||(d.device||'').includes(devF))
    );
    const avgMap = aggregate(fourWeeks, keyFn);
    const denom = weeks.length || 1;

    const list=Object.keys(cur).map(k=>{
        const [camp,ag]=k.split('||'); const type=cur[k].campaignType||'-';
        if(f && ag.toLowerCase().indexOf(f)===-1) return null;
        const m=calcMetrics([cur[k]]); 
        const pm=prev[k]?calcMetrics([prev[k]]):calcMetrics([]);
        let avgM = {cost:0,impressions:0,clicks:0,conversions:0,revenue:0,roas:0};
        if(avgMap[k]) {
            ['cost','impressions','clicks','conversions','revenue'].forEach(key => avgM[key] = avgMap[k][key]/denom);
            avgM.roas = avgM.cost>0 ? (avgM.revenue/avgM.cost)*100 : 0;
        }
        return {camp,ag,type,m,pm,avgM};
    }).filter(Boolean).sort((a,b)=>b.m.conversions-a.m.conversions);
    let html=generateTotalRowHTML(list,14,'adgroup');
    const prevLabel=weeks[1]?`${weeks[1]} ì§€ë‚œ ë°ì´í„°`:'ì§€ë‚œ ë°ì´í„°';
    list.forEach((it,idx)=>{
        html+=`<tr class="collapsible" data-key="${it.camp}||${it.ag}" data-roas="${it.m.roas}">
            <td><span class="rank-badge">${idx+1}</span></td>
            <td class="text-col" title="${it.ag}">${it.ag}</td>
            <td class="text-col" title="${it.camp}">${it.camp}</td>
            <td class="text-col" title="${it.type}">${it.type}</td>
            ${adgroupRowCells(it)}
        </tr>`;
        html+=addDetailRow(14,`${it.camp}||${it.ag}`,it.m,it.pm,prevLabel,it.avgM);
    });
    tbody.innerHTML = html || '<tr><td colspan="14" class="no-data">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    bindRowToggle('adgroupBody'); clearROASFilter('adgroupBody');
}

function updateKeywordTable(reset){
    if(reset) keywordPage=1;
    const tbody=document.getElementById('keywordBody');
    if(!raw2Rows.length){ tbody.innerHTML='<tr><td colspan="14" class="no-data">RAW2(ê²€ìƒ‰ì–´) íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>'; return; }
    const search=(document.getElementById('keywordSearch').value||'').toLowerCase();
    const device=document.getElementById('deviceFilter').value;
    const campF=document.getElementById('keywordCampaignFilter').value;
    const typeF=document.getElementById('keywordCampaignTypeFilter').value;
    const agF=document.getElementById('keywordAdgroupFilter').value;
    const filterFn = d => (!device || (d.device||'').includes(device))
            && (!campF || d.campaign===campF)
            && (!typeF || d.campaignType===typeF)
            && (!agF || d.adgroup===agF);

    const curData = raw2Rows.filter(d => d.week===weeks[0] && filterFn(d));
    const prevData = raw2Rows.filter(d => d.week===weeks[1] && filterFn(d));
    const curMap=aggregate(curData, d=>d.keyword||'ë¯¸ë¶„ë¥˜');
    const prevMap=aggregate(prevData, d=>d.keyword||'ë¯¸ë¶„ë¥˜');

    const fourWeeks = raw2Rows.filter(d=>weeks.includes(d.week) && filterFn(d));
    const avgMap = aggregate(fourWeeks, d=>d.keyword||'ë¯¸ë¶„ë¥˜');
    const denom = weeks.length || 1;

    const rows=Object.keys(curMap).map(k=>{
        if(k.toLowerCase().indexOf(search)===-1) return null;
        const m=calcMetrics([{...curMap[k]}]);
        const pm=prevMap[k]?calcMetrics([{...prevMap[k]}]):calcMetrics([]);
        let avgM = {cost:0,impressions:0,clicks:0,conversions:0,revenue:0,ctr:0,cvr:0,cpa:0,roas:0,cpc:0};
        if(avgMap[k]) {
            avgM.cost = avgMap[k].cost/denom;
            avgM.impressions = avgMap[k].impressions/denom;
            avgM.clicks = avgMap[k].clicks/denom;
            avgM.conversions = avgMap[k].conversions/denom;
            avgM.revenue = avgMap[k].revenue/denom;
            avgM.ctr = avgM.impressions>0 ? (avgM.clicks/avgM.impressions)*100 : 0;
            avgM.cpc = avgM.clicks>0 ? avgM.cost/avgM.clicks : 0;
            avgM.cvr = avgM.clicks>0 ? (avgM.conversions/avgM.clicks)*100 : 0;
            avgM.cpa = avgM.conversions>0 ? avgM.cost/avgM.conversions : 0;
            avgM.roas = avgM.cost>0 ? (avgM.revenue/avgM.cost)*100 : 0;
        }
        return {keyword:k, data:curMap[k].sample, m, pm, avgM};
    }).filter(Boolean).sort((a,b)=>b.m.conversions-a.m.conversions);

    const totalPages=Math.max(1, Math.ceil(rows.length/PAGE_SIZE));
    keywordPage=Math.min(keywordPage,totalPages);
    const start=(keywordPage-1)*PAGE_SIZE;
    const pageRows=rows.slice(start,start+PAGE_SIZE);
    let html=generateTotalRowHTML(rows,14,'keyword');
    const prevLabel=weeks[1]?`${weeks[1]} ì§€ë‚œ ë°ì´í„°`:'ì§€ë‚œ ë°ì´í„°';
    pageRows.forEach((it,idx)=>{
        html+=`<tr class="collapsible" data-key="${it.keyword}" data-roas="${it.m.roas}">
            <td><span class="rank-badge">${start+idx+1}</span></td>
            <td class="text-col" title="${it.keyword}"><strong>${it.keyword}</strong></td>
            <td class="text-col" title="${it.data.campaign}">${it.data.campaign}</td>
            <td class="text-col" title="${it.data.adgroup}">${it.data.adgroup}</td>
            <td class="number"><span class="value-wrapper">${formatCardValue('cost', it.m.cost)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.cost, it.pm.cost||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('impressions', it.m.impressions)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.impressions, it.pm.impressions||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('clicks', it.m.clicks)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.clicks, it.pm.clicks||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('ctr', it.m.ctr)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.ctr, it.pm.ctr||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('cpc', it.m.cpc)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.cpc, it.pm.cpc||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('conversions', it.m.conversions)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.conversions, it.pm.conversions||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('cvr', it.m.cvr)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.cvr, it.pm.cvr||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('revenue', it.m.revenue)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.revenue, it.pm.revenue||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('cpa', it.m.cpa)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.cpa, it.pm.cpa||0))}</span></td>
            <td class="number" style="color:#111;"><span class="value-wrapper">${formatCardValue('roas', it.m.roas)}</span></td>
        </tr>`;
        html+=addDetailRow(14,it.keyword,it.m,it.pm,prevLabel,it.avgM);
    });
    tbody.innerHTML = html || '<tr><td colspan="14" class="no-data">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    document.getElementById('kwPageInfo').textContent = `${rows.length===0?0:keywordPage} / ${rows.length===0?0:totalPages}`;
    document.getElementById('kwPrev').disabled = keywordPage<=1;
    document.getElementById('kwNext').disabled = keywordPage>=totalPages;
    bindRowToggle('keywordBody'); clearROASFilter('keywordBody');
}
function changeKeywordPage(d){ keywordPage+=d; if(keywordPage<1) keywordPage=1; updateKeywordTable(false); }

function updateMediaTable(){
    const tbody=document.getElementById('mediaBody');
    if(!currentWeekData.length){ tbody.innerHTML='<tr><td colspan="16" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>'; return; }
    const search=(document.getElementById('mediaFilter').value||'').toLowerCase();
    const campF=document.getElementById('mediaCampaignFilter').value;
    const typeF=document.getElementById('mediaCampaignTypeFilter').value;
    const agF=document.getElementById('mediaAdgroupFilter').value;
    const devF=document.getElementById('mediaDeviceFilter').value;
    const keyFn=d=>`${d.media||'ë¯¸ë¶„ë¥˜'}||${d.campaign||'ë¯¸ë¶„ë¥˜'}||${d.adgroup||'ë¯¸ë¶„ë¥˜'}||${d.campaignType||'ë¯¸ë¶„ë¥˜'}||${d.device||''}`;
    const cur=aggregate(currentWeekData.filter(d=>
        (!campF||d.campaign===campF)&&(!typeF||d.campaignType===typeF)&&(!agF||d.adgroup===agF)&&(!devF||(d.device||'').includes(devF))
    ), keyFn);
    const prev=aggregate(previousWeekData.filter(d=>
        (!campF||d.campaign===campF)&&(!typeF||d.campaignType===typeF)&&(!agF||d.adgroup===agF)&&(!devF||(d.device||'').includes(devF))
    ), keyFn);
    const list=Object.keys(cur).map(k=>{
        const [media,camp,ag,type,device]=k.split('||');
        if(media.toLowerCase().indexOf(search)===-1) return null;
        const m=calcMetrics([cur[k]]); const pm=prev[k]?calcMetrics([prev[k]]):calcMetrics([]);
        return {media,camp,ag,type,device,m,pm};
    }).filter(Boolean).sort((a,b)=>b.m.conversions-a.m.conversions);
    const prevLabel=weeks[1]?`${weeks[1]} ì§€ë‚œ ë°ì´í„°`:'ì§€ë‚œ ë°ì´í„°';
    let html='';
    list.forEach((it,idx)=>{
        html+=`<tr class="collapsible" data-key="${it.media}||${it.camp}||${it.device}" data-roas="${it.m.roas}">
            <td><span class="rank-badge">${idx+1}</span></td>
            <td class="text-col" title="${it.media}">${it.media}</td>
            <td class="text-col" title="${it.camp}">${it.camp}</td>
            <td class="text-col" title="${it.ag}">${it.ag}</td>
            <td class="text-col" title="${it.device}">${it.device}</td>
            <td class="text-col" title="${it.type}">${it.type}</td>
            <td class="number"><span class="value-wrapper">${formatCardValue('cost', it.m.cost)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.cost, it.pm.cost||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('impressions', it.m.impressions)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.impressions, it.pm.impressions||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('clicks', it.m.clicks)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.clicks, it.pm.clicks||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('ctr', it.m.ctr)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.ctr, it.pm.ctr||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('cpc', it.m.cpc)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.cpc, it.pm.cpc||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('conversions', it.m.conversions)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.conversions, it.pm.conversions||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('cvr', it.m.cvr)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.cvr, it.pm.cvr||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('revenue', it.m.revenue)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.revenue, it.pm.revenue||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('cpa', it.m.cpa)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.cpa, it.pm.cpa||0))}</span></td>
            <td class="number" style="color:#111;"><span class="value-wrapper">${formatCardValue('roas', it.m.roas)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.roas, it.pm.roas||0))}</span></td>
        </tr>`;
        html+=addDetailRow(16,`${it.media}||${it.camp}||${it.device}`,it.m,it.pm,prevLabel,it.m); // avg not used here
    });
    tbody.innerHTML = html || '<tr><td colspan="16" class="no-data">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    bindRowToggle('mediaBody'); clearROASFilter('mediaBody');
}

/* ============ íš¨ìœ¨ ============ */
function updateEfficiencyAnalysis(){
    const brandEx=(document.getElementById('brandExclude').value||'').toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
    const typeF=document.getElementById('efficiencyCampaignTypeFilter').value;
    const campF=document.getElementById('efficiencyCampaignFilter').value;
    const agF=document.getElementById('efficiencyAdgroupFilter').value;
    const costMin=+document.getElementById('filterCostMin').value;
    const convMin=+document.getElementById('filterConvMin').value;
    const roasMin=+document.getElementById('filterROASMin').value;
    const curData=raw2Rows.filter(d=>weeks.includes(d.week) && (!typeF||d.campaignType===typeF) && (!campF||d.campaign===campF) && (!agF||d.adgroup===agF));
    const curMap=aggregate(curData, d=>d.keyword||'ë¯¸ë¶„ë¥˜');
    const prevMap=aggregate(raw2Rows.filter(d=>d.week===weeks[1]), d=>d.keyword||'ë¯¸ë¶„ë¥˜');
    const good=[], bad=[];
    Object.keys(curMap).forEach(k=>{
        if(brandEx.some(ex=>ex && k.toLowerCase().includes(ex))) return;
        const m=calcMetrics([{...curMap[k]}]);
        const pm=prevMap[k]?calcMetrics([{...prevMap[k]}]):calcMetrics([]);
        let ok=true;
        if(!isNaN(costMin)&&m.cost<costMin) ok=false;
        if(!isNaN(convMin)&&m.conversions<convMin) ok=false;
        if(!isNaN(roasMin)&&m.roas<roasMin) ok=false;
        const row={keyword:k, data:curMap[k].sample, m, pm};
        if(ok) good.push(row); else bad.push(row);
    });
    const render=(arr, bodyId)=>{
        const prevLabel=weeks[1]?`${weeks[1]} ì§€ë‚œ ë°ì´í„°`:'ì§€ë‚œ ë°ì´í„°';
        const allZero=arr.length>0 && arr.every(x=>x.m.conversions===0);
        const sorted=arr.sort((a,b)=> allZero ? b.m.cost-a.m.cost : b.m.conversions-a.m.conversions);
        const html=sorted.map((it,idx)=>`
            <tr class="collapsible" data-key="${bodyId}_${it.keyword}">
                <td><span class="rank-badge">${idx+1}</span></td>
                <td class="text-col" title="${it.data.campaignType}">${it.data.campaignType||'-'}</td>
                <td class="text-col" title="${it.keyword}"><strong>${it.keyword}</strong></td>
                <td class="text-col" title="${it.data.campaign}">${it.data.campaign}</td>
                <td class="text-col" title="${it.data.adgroup}">${it.data.adgroup}</td>
                <td class="number"><span class="value-wrapper">${formatCardValue('cost', it.m.cost)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.cost, it.pm.cost||0))}</span></td>
                <td class="number"><span class="value-wrapper">${formatCardValue('impressions', it.m.impressions)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.impressions, it.pm.impressions||0))}</span></td>
                <td class="number"><span class="value-wrapper">${formatCardValue('clicks', it.m.clicks)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.clicks, it.pm.clicks||0))}</span></td>
                <td class="number"><span class="value-wrapper">${formatCardValue('ctr', it.m.ctr)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.ctr, it.pm.ctr||0))}</span></td>
                <td class="number"><span class="value-wrapper">${formatCardValue('cpc', it.m.cpc)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.cpc, it.pm.cpc||0))}</span></td>
                <td class="number"><span class="value-wrapper">${formatCardValue('conversions', it.m.conversions)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.conversions, it.pm.conversions||0))}</span></td>
                <td class="number"><span class="value-wrapper">${formatCardValue('cvr', it.m.cvr)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.cvr, it.pm.cvr||0))}</span></td>
                <td class="number"><span class="value-wrapper">${formatCardValue('cpa', it.m.cpa)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.cpa, it.pm.cpa||0))}</span></td>
                <td class="number" style="color:#111;"><span class="value-wrapper">${formatCardValue('roas', it.m.roas)}</span> <span class="badge-mini">${badge(getChangeRate(it.m.roas, it.pm.roas||0))}</span></td>
            </tr>
            ${addDetailRow(14, `${bodyId}_${it.keyword}`, it.m, it.pm, prevLabel, it.m)}
        `).join('') || '<tr><td colspan="14" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>';
        document.getElementById(bodyId).innerHTML = html;
        bindRowToggle(bodyId);
    };
    render(good,'goodEfficiencyBody');
    render(bad,'badEfficiencyBody');
}

/* ============ CPC ============ */
function updateCPCAnalysis(){
    const brandEx=(document.getElementById('cpcBrandExclude').value||'').toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
    const typeF=document.getElementById('cpcCampaignTypeFilter').value;
    const campF=document.getElementById('cpcCampaignFilter').value;
    const agF=document.getElementById('cpcAdgroupFilter').value;
    const costMin=+document.getElementById('cpcCostMin').value;
    const convMin=+document.getElementById('cpcConvMin').value;
    const roasMin=+document.getElementById('cpcROASMin').value;
    const th=+document.getElementById('cpcChangeThreshold').value || 0;
    const totalCost=sum(raw2Rows.filter(d=>weeks.includes(d.week)),'cost');
    const curMap=aggregate(raw2Rows.filter(d=>{
        return weeks.includes(d.week) && (!typeF||d.campaignType===typeF) && (!campF||d.campaign===campF) && (!agF||d.adgroup===agF);
    }), d=>d.keyword||'ë¯¸ë¶„ë¥˜');
    const prevMap=aggregate(raw2Rows.filter(d=>d.week===weeks[1]), d=>d.keyword||'ë¯¸ë¶„ë¥˜');
    const up=[], down=[];
    Object.keys(curMap).forEach(k=>{
        if(brandEx.some(ex=>ex && k.toLowerCase().includes(ex))) return;
        const cur=calcMetrics([{...curMap[k]}]);
        const prev=prevMap[k]?calcMetrics([{...prevMap[k]}]):{cpc:0,cost:0,clicks:0,conversions:0,roas:0,impressions:0,ctr:0,revenue:0};
        if(cur.cost===0) return;
        if(!isNaN(costMin)&&cur.cost<costMin) return;
        if(!isNaN(convMin)&&cur.conversions<convMin) return;
        if(!isNaN(roasMin)&&cur.roas<roasMin) return;
         const change=prev.cpc===0?100:((cur.cpc-prev.cpc)/prev.cpc*100);
        const costShare= totalCost>0 ? (cur.cost/totalCost*100) : 0;
        const row={keyword:k, data:curMap[k].sample, m:cur, pm:prev, change, costShare};
        if(change>=th) up.push(row);
        else if(change<=-th) down.push(row);
    });
    const render=(arr, bodyId, isUp)=>{
        const prevLabel=weeks[1]?`${weeks[1]}`:'ì§€ë‚œì£¼';
        const sorted=isUp ? arr.sort((a,b)=>b.change-a.change) : arr.sort((a,b)=>a.change-b.change);
        const html=sorted.map((r,idx)=>`
            <tr class="collapsible" data-key="${bodyId}_${r.keyword}">
                <td><span class="rank-badge">${idx+1}</span></td>
                <td class="text-col" title="${r.data.campaignType}">${r.data.campaignType||'-'}</td>
                <td class="text-col" title="${r.keyword}"><strong>${r.keyword}</strong></td>
                <td class="text-col" title="${r.data.campaign}">${r.data.campaign}</td>
                <td class="text-col" title="${r.data.adgroup}">${r.data.adgroup}</td>
                <td class="number"><span class="value-wrapper">${formatCardValue('cpc', r.m.cpc)}</span> <span class="badge-mini">${badge(getChangeRate(r.m.cpc, r.pm.cpc||0))}</span></td>
                <td class="number"><span class="value-wrapper">${formatCardValue('cpc', r.pm.cpc||0)}</span></td>
                <td class="number"><span class="value-wrapper">${formatCardValue('cost', r.m.cost)}</span> <span class="badge-mini">${badge(getChangeRate(r.m.cost, r.pm.cost||0))}</span></td>
                <td class="number"><span class="value-wrapper">${r.costShare.toFixed(2)}%</span></td>
                <td class="number"><span class="value-wrapper">${formatCardValue('impressions', r.m.impressions)}</span> <span class="badge-mini">${badge(getChangeRate(r.m.impressions, r.pm.impressions||0))}</span></td>
                <td class="number"><span class="value-wrapper">${formatCardValue('clicks', r.m.clicks)}</span> <span class="badge-mini">${badge(getChangeRate(r.m.clicks, r.pm.clicks||0))}</span></td>
                <td class="number"><span class="value-wrapper">${formatCardValue('ctr', r.m.ctr)}</span> <span class="badge-mini">${badge(getChangeRate(r.m.ctr, r.pm.ctr||0))}</span></td>
                <td class="number"><span class="value-wrapper">${formatCardValue('conversions', r.m.conversions)}</span> <span class="badge-mini">${badge(getChangeRate(r.m.conversions, r.pm.conversions||0))}</span></td>
                <td class="number"><span class="value-wrapper">${formatCardValue('revenue', r.m.revenue)}</span> <span class="badge-mini">${badge(getChangeRate(r.m.revenue, r.pm.revenue||0))}</span></td>
                <td class="number" style="color:#111;"><span class="value-wrapper">${formatCardValue('roas', r.m.roas)}</span> <span class="badge-mini">${badge(getChangeRate(r.m.roas, r.pm.roas||0))}</span></td>
            </tr>
            ${addDetailRow(14, `${bodyId}_${r.keyword}`, r.m, r.pm, prevLabel, r.m)}
        `).join('') || '<tr><td colspan="15" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>';
        document.getElementById(bodyId).innerHTML = html;
        bindRowToggle(bodyId);
    };
    render(up,'cpcUpBody',true);
    render(down,'cpcDownBody',false);
}

/* ============ ë””ë°”ì´ìŠ¤ ============ */
function updateDeviceTables(){
    const std=+document.getElementById('standardROAS3').value;
    const typeF=document.getElementById('deviceCampaignTypeFilter').value;
    const prevLabel=weeks[1]?`${weeks[1]} ì§€ë‚œ ë°ì´í„°`:'ì§€ë‚œ ë°ì´í„°';
    updateDeviceSide('devicePCBody','PC',std,typeF,prevLabel);
    updateDeviceSide('deviceMOBody','MO',std,typeF,prevLabel);
    clearROASFilter('devicePCBody'); clearROASFilter('deviceMOBody');
}
function updateDeviceSide(bodyId, deviceLabel, std, typeF, prevLabel){
    const tbody=document.getElementById(bodyId);
    if(!currentWeekData.length){ tbody.innerHTML='<tr><td colspan="11" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>'; return; }
    const curMap={}, prevMap={}; let totalCost=0;
    currentWeekData.forEach(d=>{
        if(typeF && d.campaignType!==typeF) return;
        const dev=(d.device||'').includes('PC')?'PC':'MO'; if(dev!==deviceLabel) return;
        const camp=d.campaign||'ë¯¸ë¶„ë¥˜';
        if(!curMap[camp]) curMap[camp]={cost:0, impressions:0, clicks:0, conversions:0, revenue:0};
        curMap[camp].cost+=d.cost; curMap[camp].impressions+=d.impressions; curMap[camp].clicks+=d.clicks; curMap[camp].conversions+=d.conversions; curMap[camp].revenue+=d.revenue;
        totalCost+=d.cost;
    });
    previousWeekData.forEach(d=>{
        if(typeF && d.campaignType!==typeF) return;
        const dev=(d.device||'').includes('PC')?'PC':'MO'; if(dev!==deviceLabel) return;
        const camp=d.campaign||'ë¯¸ë¶„ë¥˜';
        if(!prevMap[camp]) prevMap[camp]={cost:0, impressions:0, clicks:0, conversions:0, revenue:0};
        prevMap[camp].cost+=d.cost; prevMap[camp].impressions+=d.impressions; prevMap[camp].clicks+=d.clicks; prevMap[camp].conversions+=d.conversions; prevMap[camp].revenue+=d.revenue;
    });
    const rows=Object.keys(curMap).map(camp=>{
        const m=calcMetrics([curMap[camp]]); const pm=prevMap[camp]?calcMetrics([prevMap[camp]]):calcMetrics([]);
        const costShare= totalCost>0 ? (curMap[camp].cost/totalCost*100):0;
        return {camp, costShare, m, pm};
    }).sort((a,b)=>b.m.cost-a.m.cost);
    let html='';
    rows.forEach((r,idx)=>{
        html+=`<tr class="collapsible" data-key="${bodyId}_${r.camp}" data-roas="${r.m.roas}">
            <td><span class="rank-badge">${idx+1}</span></td>
            <td class="text-col" title="${r.camp}">${r.camp}</td>
            <td class="number"><span class="value-wrapper">${formatCardValue('cost', r.m.cost)}</span></td>
            <td class="number"><span class="value-wrapper">${r.costShare.toFixed(1)}%</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('impressions', r.m.impressions)}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('clicks', r.m.clicks)}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('conversions', r.m.conversions)}</span> <span class="badge-mini">${badge(getChangeRate(r.m.conversions, r.pm.conversions||0))}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('revenue', r.m.revenue)}</span></td>
            <td class="number"><span class="value-wrapper">${formatCardValue('cpa', r.m.cpa)}</span></td>
            <td class="number" style="color:#111;"><span class="value-wrapper">${formatCardValue('roas', r.m.roas)}</span></td>
            <td class="number"><span class="badge-mini">${badge(getChangeRate(r.m.roas, r.pm.roas||0))}</span></td>
        </tr>`;
        html+=addDetailRow(11, `${bodyId}_${r.camp}`, r.m, r.pm, prevLabel, r.m);
    });
    tbody.innerHTML = html || '<tr><td colspan="11" class="no-data">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    bindRowToggle(bodyId);
}
function applyROASFilterDevice(direction){
    const std=+document.getElementById('standardROAS3').value;
    ['devicePCBody','deviceMOBody'].forEach(id=>{
        const tbody=document.getElementById(id);
        if(isNaN(std)) return;
        tbody.querySelectorAll('tr.collapsible').forEach(tr=>{
            const roas=parseFloat(tr.getAttribute('data-roas'));
            tr.classList.toggle('low-roas', direction==='low' ? roas<std : (direction==='up'? roas<std : roas>std));
        });
    });
}
function resetDevice(){ document.getElementById('deviceCampaignTypeFilter').value=''; document.getElementById('standardROAS3').value=''; updateDeviceTables(); }

/* ë¦¬ì…‹ë“¤ */
function resetCampaign(){ document.getElementById('campaignFilter').value=''; document.getElementById('campaignTypeFilter').value=''; document.getElementById('campaignDeviceFilter').value=''; document.getElementById('campaignCampaignFilter').value=''; document.getElementById('campaignAdgroupFilter').value=''; document.getElementById('standardROAS').value=''; clearROASFilter('campaignBody'); updateCampaignTable(); }
function resetAdgroup(){ document.getElementById('adgroupFilter').value=''; document.getElementById('adgroupCampaignFilter').value=''; document.getElementById('adgroupCampaignTypeFilter').value=''; document.getElementById('adgroupDeviceFilter').value=''; document.getElementById('standardROAS_AG').value=''; clearROASFilter('adgroupBody'); updateAdgroupTable(); }
function resetKeyword(){ document.getElementById('keywordSearch').value=''; document.getElementById('deviceFilter').value=''; document.getElementById('keywordCampaignFilter').value=''; document.getElementById('keywordCampaignTypeFilter').value=''; document.getElementById('keywordAdgroupFilter').value=''; document.getElementById('standardROAS2').value=''; clearROASFilter('keywordBody'); keywordPage = 1; updateKeywordTable(true); }
function resetMedia(){ document.getElementById('mediaFilter').value=''; document.getElementById('mediaCampaignFilter').value=''; document.getElementById('mediaCampaignTypeFilter').value=''; document.getElementById('mediaAdgroupFilter').value=''; document.getElementById('mediaDeviceFilter').value=''; document.getElementById('standardROAS_MEDIA').value=''; clearROASFilter('mediaBody'); updateMediaTable(); }
function resetEfficiency(){ document.getElementById('brandExclude').value=''; document.getElementById('efficiencyCampaignTypeFilter').value=''; document.getElementById('efficiencyCampaignFilter').value=''; document.getElementById('efficiencyAdgroupFilter').value=''; document.getElementById('filterCostMin').value=''; document.getElementById('filterConvMin').value=''; document.getElementById('filterROASMin').value=''; }
function resetCPC(){ document.getElementById('cpcBrandExclude').value=''; document.getElementById('cpcCampaignTypeFilter').value=''; document.getElementById('cpcCampaignFilter').value=''; document.getElementById('cpcAdgroupFilter').value=''; document.getElementById('cpcCostMin').value=''; document.getElementById('cpcConvMin').value=''; document.getElementById('cpcROASMin').value=''; document.getElementById('cpcChangeThreshold').value=''; updateCPCAnalysis(); }
function resetRankTrend(){ 
    document.getElementById('trendCT').value=''; 
    document.getElementById('trendCamp').value=''; 
    document.getElementById('trendAdg').value=''; 
    document.getElementById('trendMedia').value=''; 
    document.getElementById('trendKw').value=''; 
    if(window.trendChartObj) window.trendChartObj.destroy(); 
}

/* ============ Shopping Dashboard ============ */
let raw_shopping = [], pMap_shopping = {}, aggList_shopping = [];
let dChart_shopping = null, wChart_shopping = null;
let metric_shopping = 'amt';
let sKey_shopping = 'cv', sDir_shopping = 'desc', activeMat_shopping = null;
let filterCp_shopping = null, filterGr_shopping = null;

const metricNames_shopping = { 
    amt:'ë§¤ì¶œì•¡', 
    cost:'ê´‘ê³ ë¹„', 
    view:'ë…¸ì¶œìˆ˜', 
    click:'í´ë¦­ìˆ˜', 
    cv:'ì „í™˜ìˆ˜', 
    ctr:'í´ë¦­ìœ¨(%)', 
    cvr:'ì „í™˜ìœ¨(%)', 
    roas:'ROAS(%)',
    cpc:'CPC'
};

function handleShoppingFile(type) {
    const fileInput = document.getElementById(type === 'tsv' ? 'tsvFile' : 'csvFile');
    const fileName = fileInput.files[0]?.name;
    if (fileName) {
        document.getElementById(type === 'tsv' ? 'tsvFileName' : 'csvFileName').textContent = fileName;
    }
}

function startAnalysis() {
    const tsv = document.getElementById('tsvFile').files[0];
    const csv = document.getElementById('csvFile').files[0];
    if(!tsv || !csv) return alert("íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");

    // Show loading indicator
    document.getElementById('loadingShop').style.display = 'block';
    document.getElementById('analysisComplete').style.display = 'none';

    Papa.parse(tsv, { delimiter: "\t", complete: (t) => {
        t.data.forEach(r => { 
            if(r[2]) pMap_shopping[r[2].trim()] = { name: r[14], img: r[15] }; 
        });
        
        Papa.parse(csv, { encoding: "EUC-KR", skipEmptyLines: true, complete: (c) => {
            const headRow = c.data.findIndex(r => r.join(',').includes("ìº í˜ì¸ìœ í˜•"));
            raw_shopping = c.data.slice(headRow + 1)
                .filter(r => r[0] === "ì‡¼í•‘ê²€ìƒ‰")
                .map(r => ({
                    cp: r[1], 
                    gr: r[2], 
                    mat: r[3].trim(), 
                    date: r[6], 
                    week: r[7],
                    cost: Number(r[8]||0), 
                    view: Number(r[9]||0), 
                    click: Number(r[10]||0), 
                    cv: Number(r[11]||0), 
                    amt: Number(r[12]||0)
                }));
            
            // Hide loading, show completion
            document.getElementById('loadingShop').style.display = 'none';
            document.getElementById('analysisComplete').style.display = 'block';
            
            // â­ ê°€ì´ë“œ ìˆ¨ê¸°ê¸° ì¶”ê°€
            const shoppingGuide = document.getElementById('shoppingGuide');
            if (shoppingGuide) {
                shoppingGuide.style.display = 'none';
            }
            
            setTimeout(() => {
                document.getElementById('uploadSection_shopping').style.display = 'none';
                document.getElementById('resultArea_shopping').style.display = 'block';
                document.getElementById('analysisComplete').style.display = 'none';
            }, 1500);
            
            resetFilters_shopping();
        }});
    }});
}
function resetFilters_shopping() {
    filterCp_shopping = null;
    filterGr_shopping = null;
    renderFilters_shopping();
    refresh_shopping();
}

function setCP_shopping(c) { 
    filterCp_shopping = c; 
    filterGr_shopping = null; 
    renderFilters_shopping(); 
    refresh_shopping(); 
}

function setGR_shopping(g) { 
    filterGr_shopping = g; 
    renderFilters_shopping(); 
    refresh_shopping(); 
}

function renderFilters_shopping() {
    const cps = [...new Set(raw_shopping.map(d => d.cp))];
    let h = `<button style="padding: 8px 18px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; flex-shrink: 0;" onclick="resetFilters_shopping()">ğŸ”„ ì´ˆê¸°í™”</button>`;
    h += `<div style="min-width: 120px; padding: 10px 15px; background: ${!filterCp_shopping?'#f0fff4':'white'}; border: ${!filterCp_shopping?'2px':'1px'} solid ${!filterCp_shopping?'#00c73c':'#ddd'}; border-radius: 8px; cursor: pointer; text-align: center; transition: 0.2s; flex-shrink: 0; font-size: 13px; ${!filterCp_shopping?'font-weight: bold':''}" onclick="setCP_shopping(null)">ì „ì²´ ìº í˜ì¸</div>`;
    cps.forEach(c => h += `<div style="min-width: 120px; padding: 10px 15px; background: ${filterCp_shopping===c?'#f0fff4':'white'}; border: ${filterCp_shopping===c?'2px':'1px'} solid ${filterCp_shopping===c?'#00c73c':'#ddd'}; border-radius: 8px; cursor: pointer; text-align: center; transition: 0.2s; flex-shrink: 0; font-size: 13px; ${filterCp_shopping===c?'font-weight: bold':''}" onclick="setCP_shopping('${c}')">${c}</div>`);
    document.getElementById('cpCards_shopping').innerHTML = h;

    if(filterCp_shopping) {
        const grs = [...new Set(raw_shopping.filter(d => d.cp === filterCp_shopping).map(d => d.gr))];
        let gh = `<div style="min-width: 120px; padding: 10px 15px; background: ${!filterGr_shopping?'#f0fff4':'white'}; border: ${!filterGr_shopping?'2px':'1px'} solid ${!filterGr_shopping?'#00c73c':'#ddd'}; border-radius: 8px; cursor: pointer; text-align: center; transition: 0.2s; flex-shrink: 0; font-size: 13px; ${!filterGr_shopping?'font-weight: bold':''}" onclick="setGR_shopping(null)">ì „ì²´ ê´‘ê³ ê·¸ë£¹</div>`;
        grs.forEach(g => gh += `<div style="min-width: 120px; padding: 10px 15px; background: ${filterGr_shopping===g?'#f0fff4':'white'}; border: ${filterGr_shopping===g?'2px':'1px'} solid ${filterGr_shopping===g?'#00c73c':'#ddd'}; border-radius: 8px; cursor: pointer; text-align: center; transition: 0.2s; flex-shrink: 0; font-size: 13px; ${filterGr_shopping===g?'font-weight: bold':''}" onclick="setGR_shopping('${g}')">${g}</div>`);
        document.getElementById('grCards_shopping').innerHTML = gh;
    } else {
        document.getElementById('grCards_shopping').innerHTML = '';
    }
}

function refresh_shopping() {
    const allDates = [...new Set(raw_shopping.map(d=>d.date))].sort().reverse();
    const curDates = allDates.slice(0, 7);
    const preDates = allDates.slice(7, 14);

    let filtered = raw_shopping.filter(d => 
        (!filterCp_shopping || d.cp === filterCp_shopping) &&
        (!filterGr_shopping || d.gr === filterGr_shopping)
    );

    const agg = {};
    const gCheck = {};
    
    filtered.forEach(r => {
        const pName = pMap_shopping[r.mat]?.name || "ì•Œìˆ˜ì—†ìŒ";
        const gk = `${r.cp}_${r.gr}_${pName}`;
        if(!gCheck[gk]) gCheck[gk] = new Set(); 
        gCheck[gk].add(r.mat);
        
        if(!agg[r.mat]) {
            agg[r.mat] = { 
                cp: r.cp, gr: r.gr, mat: r.mat,
                cost:0, view:0, click:0, cv:0, amt:0, 
                pCost:0, pView:0, pClick:0, pCv:0, pAmt:0 
            };
        }
        
        if(curDates.includes(r.date)) { 
            agg[r.mat].cost += r.cost; 
            agg[r.mat].view += r.view; 
            agg[r.mat].click += r.click; 
            agg[r.mat].cv += r.cv; 
            agg[r.mat].amt += r.amt; 
        }
        if(preDates.includes(r.date)) { 
            agg[r.mat].pCost += r.cost; 
            agg[r.mat].pView += r.view; 
            agg[r.mat].pClick += r.click; 
            agg[r.mat].pCv += r.cv; 
            agg[r.mat].pAmt += r.amt; 
        }
    });

    aggList_shopping = Object.values(agg).map(r => {
        const pName = pMap_shopping[r.mat]?.name || "ë§¤ì¹­ì‹¤íŒ¨";
        return {
            ...r, 
            pName: pName,
            pImg: pMap_shopping[r.mat]?.img || "",
            isG: gCheck[`${r.cp}_${r.gr}_${pName}`]?.size > 1,
            ctr: r.view > 0 ? (r.click / r.view * 100) : 0, 
            cpc: r.click > 0 ? (r.cost / r.click) : 0, 
            roas: r.cost > 0 ? (r.amt / r.cost * 100) : 0,
            pCtr: r.pView > 0 ? (r.pClick / r.pView * 100) : 0,
            pCpc: r.pClick > 0 ? (r.pCost / r.pClick) : 0,
            pRoas: r.pCost > 0 ? (r.pAmt / r.pCost * 100) : 0
        };
    });

    aggList_shopping.sort((a,b) => {
        if(sDir_shopping === 'desc') {
            return b[sKey_shopping] > a[sKey_shopping] ? 1 : -1;
        } else {
            return a[sKey_shopping] > b[sKey_shopping] ? 1 : -1;
        }
    });
    
    const getDiff = (cur, pre) => {
        if(pre === 0 || pre === null || pre === undefined) return '';
        const d = ((cur - pre) / pre * 100).toFixed(0);
        if(Math.abs(d) < 0.5) return '';
        // Match other analysis pages: green for increase, red for decrease with +/- symbols
        if(d > 0) return `<span style="font-size: 10px; color: #28a745;">(+${d}%)</span>`;
        if(d < 0) return `<span style="font-size: 10px; color: #dc3545;">(${d}%)</span>`;
        return '';
    };

    document.getElementById('tableBody_shopping').innerHTML = aggList_shopping.map(r => `
        <tr onclick="viewDetail_shopping('${r.mat}')" style="cursor:pointer;">
            <td><img src="${r.pImg}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3C/svg%3E'"></td>
            <td style="max-width: 100px; color:#2b6cb0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${r.cp}">${r.cp}</td>
            <td style="max-width: 100px; color:#c05621; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${r.gr}">${r.gr}</td>
            <td style="max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left;" title="${r.pName}"><b>${r.pName}</b>${r.isG?'<span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px;">ê·¸ë£¹</span>':''}</td>
            <td>${r.cost.toLocaleString()}${getDiff(r.cost, r.pCost)}</td>
            <td>${r.view.toLocaleString()}${getDiff(r.view, r.pView)}</td>
            <td>${r.click.toLocaleString()}${getDiff(r.click, r.pClick)}</td>
            <td>${r.ctr.toFixed(2)}%${getDiff(r.ctr, r.pCtr)}</td>
            <td>${Math.round(r.cpc).toLocaleString()}${getDiff(r.cpc, r.pCpc)}</td>
            <td>${r.cv}${getDiff(r.cv, r.pCv)}</td>
            <td>${r.amt.toLocaleString()}${getDiff(r.amt, r.pAmt)}</td>
            <td>${r.roas.toFixed(0)}%${getDiff(r.roas, r.pRoas)}</td>
        </tr>`).join('');
}

function resort_shopping(k) { 
    sKey_shopping = k; 
    sDir_shopping = sDir_shopping === 'desc' ? 'asc' : 'desc'; 
    refresh_shopping(); 
}

function filterByProductName_shopping() {
    const searchTerm = document.getElementById('productSearchInput_shopping').value.toLowerCase();
    const tbody = document.getElementById('tableBody_shopping');
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const productNameCell = row.cells[3]; // ìƒí’ˆëª… is 4th column (index 3)
        if (productNameCell) {
            const productName = productNameCell.textContent.toLowerCase();
            if (productName.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
}

function viewDetail_shopping(mat) {
    activeMat_shopping = mat;
    document.getElementById('detailSection_shopping').style.display = 'block';
    document.getElementById('detailTitle_shopping').innerText = `[ì „ì²´ ê¸°ê°„] ${pMap_shopping[mat]?.name || mat}`;
    
    let th = '';
    for(let k in metricNames_shopping) {
        th += `<button style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: ${metric_shopping===k?'#00c73c':'#fff'}; color: ${metric_shopping===k?'white':'#333'}; cursor: pointer; font-size: 12px; transition: 0.2s;" onclick="setMetric_shopping('${k}')">${metricNames_shopping[k]}</button>`;
    }
    document.getElementById('tabArea_shopping').innerHTML = th;
    
    drawCharts_shopping();
    setTimeout(() => {
        document.getElementById('detailSection_shopping').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}

function setMetric_shopping(m) { 
    metric_shopping = m; 
    drawCharts_shopping();
}

function drawCharts_shopping() {
    const filteredData = raw_shopping.filter(d => d.mat === activeMat_shopping);
    
    const dayMap = {};
    filteredData.forEach(d => {
        if(!dayMap[d.date]) dayMap[d.date] = { date: d.date, cost:0, view:0, click:0, cv:0, amt:0 };
        dayMap[d.date].cost += d.cost; 
        dayMap[d.date].view += d.view; 
        dayMap[d.date].click += d.click; 
        dayMap[d.date].cv += d.cv; 
        dayMap[d.date].amt += d.amt;
    });
    
    const dData = Object.values(dayMap).sort((a,b) => a.date.localeCompare(b.date));
    
    const wMap = {};
    filteredData.forEach(d => {
        if(!wMap[d.week]) wMap[d.week] = { cost:0, view:0, click:0, cv:0, amt:0 };
        wMap[d.week].cost += d.cost; 
        wMap[d.week].view += d.view; 
        wMap[d.week].click += d.click; 
        wMap[d.week].cv += d.cv; 
        wMap[d.week].amt += d.amt;
    });

    const getValue = (o) => {
        if(metric_shopping === 'ctr') return o.view > 0 ? (o.click / o.view * 100) : 0;
        if(metric_shopping === 'cvr') return o.click > 0 ? (o.cv / o.click * 100) : 0;
        if(metric_shopping === 'roas') return o.cost > 0 ? (o.amt / o.cost * 100) : 0;
        if(metric_shopping === 'cpc') return o.click > 0 ? (o.cost / o.click) : 0;
        return o[metric_shopping] || 0;
    };

    const formatValue = (val) => {
        if(['ctr', 'cvr', 'roas'].includes(metric_shopping)) return val.toFixed(1) + '%';
        return Math.round(val).toLocaleString();
    };

    const renderStats = (id, values, prefix) => {
        if(values.length === 0) {
            document.getElementById(id).innerHTML = '';
            return;
        }
        const max = Math.max(...values);
        const min = Math.min(...values);
        const avg = values.reduce((a,b)=>a+b,0) / values.length;
        
        document.getElementById(id).innerHTML = `
            <div style="text-align: center; flex: 1; border-right: 1px solid #eee;"><div style="font-size: 11px; color: #666; margin-bottom: 4px;">${prefix} ìµœê³ </div><div style="font-size: 14px; font-weight: bold; color: #ff4d4d;">${formatValue(max)}</div></div>
            <div style="text-align: center; flex: 1; border-right: 1px solid #eee;"><div style="font-size: 11px; color: #666; margin-bottom: 4px;">${prefix} ìµœì €</div><div style="font-size: 14px; font-weight: bold; color: #3182ce;">${formatValue(min)}</div></div>
            <div style="text-align: center; flex: 1;"><div style="font-size: 11px; color: #666; margin-bottom: 4px;">${prefix} í‰ê· </div><div style="font-size: 14px; font-weight: bold; color: #2c3e50;">${formatValue(avg)}</div></div>
        `;
    };

    if(dChart_shopping) dChart_shopping.destroy();
    const dayLabels = dData.map(d => d.date);
    const dayValues = dData.map(d => getValue(d));
    
    renderStats('dayStats_shopping', dayValues, 'ì¼');

    dChart_shopping = new Chart(document.getElementById('dayChart_shopping'), {
        type: 'line',
        data: {
            labels: dayLabels,
            datasets: [{
                label: metricNames_shopping[metric_shopping],
                data: dayValues,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 8,
                pointBackgroundColor: '#3498db',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: { display: false },
                datalabels: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 12,
                    titleFont: { size: 13 },
                    bodyFont: { size: 14, weight: 'bold' },
                    callbacks: {
                        label: (context) => metricNames_shopping[metric_shopping] + ': ' + formatValue(context.parsed.y)
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: (value) => formatValue(value)
                    },
                    grid: { color: '#f0f0f0' }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });

    const weekKeys = Object.keys(wMap).sort().slice(-4);
    const weekValues = weekKeys.map(k => getValue(wMap[k]));
    
    renderStats('weekStats_shopping', weekValues, 'ì£¼');
    
    const weekColors = weekKeys.map((k, idx) => 
        idx === weekKeys.length - 1 ? '#5DADE2' : '#D6EAF8'
    );
    
    if(wChart_shopping) wChart_shopping.destroy();
    wChart_shopping = new Chart(document.getElementById('weekChart_shopping'), {
        type: 'bar',
        data: {
            labels: weekKeys,
            datasets: [{
                label: metricNames_shopping[metric_shopping],
                data: weekValues,
                backgroundColor: weekColors,
                borderColor: '#fff',
                borderWidth: 2,
                datalabels: {
                    anchor: 'center',
                    align: 'center',
                    color: '#2c3e50',
                    font: { weight: 'bold', size: 13 },
                    formatter: (value) => formatValue(value)
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 12,
                    titleFont: { size: 13 },
                    bodyFont: { size: 14, weight: 'bold' },
                    callbacks: {
                        label: (context) => metricNames_shopping[metric_shopping] + ': ' + formatValue(context.parsed.y)
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: (value) => formatValue(value)
                    },
                    grid: { color: '#f0f0f0' }
                },
                x: {
                    grid: { display: false }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

/* ============ Budget Simulator ============ */
function updateBudgetSimulation() {
    const budget = parseFloat(document.getElementById('budgetInput').value) || 0;
    if (!rawRows || rawRows.length === 0) {
        document.getElementById('budgetResults').innerHTML = '<p style="color:#999;">ë°ì´í„°ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>';
        return;
    }
    
    // Get filter values
    const typeF = document.getElementById('budgetSimCampaignTypeFilter').value;
    const campF = document.getElementById('budgetSimCampaignFilter').value;
    const agF = document.getElementById('budgetSimAdgroupFilter').value;
    const medF = document.getElementById('budgetSimMediaFilter').value;
    const devF = document.getElementById('budgetSimDeviceFilter').value;
    
    // Get last 4 weeks data with filters applied
    const fourWeeks = rawRows.filter(d => {
        if (!weeks.includes(d.week)) return false;
        if (typeF && d.campaignType !== typeF) return false;
        if (campF && d.campaign !== campF) return false;
        if (agF && d.adgroup !== agF) return false;
        if (medF && d.media !== medF) return false;
        if (devF && !d.device.includes(devF === 'PC' ? 'PC' : 'ëª¨ë°”ì¼')) return false;
        return true;
    });
    
    const totals = {
        cost: sum(fourWeeks, 'cost'),
        impressions: sum(fourWeeks, 'impressions'),
        clicks: sum(fourWeeks, 'clicks'),
        conversions: sum(fourWeeks, 'conversions'),
        revenue: sum(fourWeeks, 'revenue')
    };
    
    // Calculate average performance ratios
    const avgCost = totals.cost / (weeks.length || 1);
    baseAvgCost = avgCost; // Store for slider calculations
    const ratio = budget / avgCost;
    
    // Projected metrics based on budget
    const projected = {
        cost: budget,
        impressions: (totals.impressions / (weeks.length || 1)) * ratio,
        clicks: (totals.clicks / (weeks.length || 1)) * ratio,
        conversions: (totals.conversions / (weeks.length || 1)) * ratio,
        revenue: (totals.revenue / (weeks.length || 1)) * ratio
    };
    
    projected.ctr = projected.impressions > 0 ? (projected.clicks / projected.impressions) * 100 : 0;
    projected.cvr = projected.clicks > 0 ? (projected.conversions / projected.clicks) * 100 : 0;
    projected.cpc = projected.clicks > 0 ? budget / projected.clicks : 0;
    projected.cpa = projected.conversions > 0 ? budget / projected.conversions : 0;
    projected.roas = budget > 0 ? (projected.revenue / budget) * 100 : 0;
    projected.aov = projected.conversions > 0 ? projected.revenue / projected.conversions : 0;
    projected.cor = projected.revenue > 0 ? (projected.cost / projected.revenue) * 100 : 0;
    
    // Current 4-week average for comparison
    const current = {
        cost: avgCost,
        impressions: totals.impressions / (weeks.length || 1),
        clicks: totals.clicks / (weeks.length || 1),
        conversions: totals.conversions / (weeks.length || 1),
        revenue: totals.revenue / (weeks.length || 1),
        ctr: totals.impressions > 0 ? (totals.clicks / totals.impressions) * 100 : 0,
        cvr: totals.clicks > 0 ? (totals.conversions / totals.clicks) * 100 : 0,
        cpc: totals.clicks > 0 ? totals.cost / totals.clicks : 0,
        cpa: totals.conversions > 0 ? totals.cost / totals.conversions : 0,
        roas: totals.cost > 0 ? (totals.revenue / totals.cost) * 100 : 0,
        aov: totals.conversions > 0 ? totals.revenue / totals.conversions : 0,
        cor: totals.revenue > 0 ? (totals.cost / totals.revenue) * 100 : 0
    };
    
    // Only 5 metrics for scorecard
    const metrics = [
        {key: 'cost', label: 'ê´‘ê³ ë¹„ (ì„¤ì • ì˜ˆì‚°)'},
        {key: 'impressions', label: 'ì˜ˆìƒ ë…¸ì¶œìˆ˜'},
        {key: 'clicks', label: 'ì˜ˆìƒ í´ë¦­ìˆ˜'},
        {key: 'conversions', label: 'ì˜ˆìƒ ì „í™˜ìˆ˜'},
        {key: 'revenue', label: 'ì˜ˆìƒ ë§¤ì¶œì•¡'}
    ];
    
    let html = '';
    metrics.forEach(m => {
        const val = projected[m.key];
        const cur = current[m.key];
        const change = getChangeRate(val, cur);
        const changeClass = change >= 0 ? 'delta-up' : 'delta-down';
        const changeIcon = change >= 0 ? 'â–²' : 'â–¼';
        
        html += `<div class="sim-card">
            <div style="font-size:13px; color:#666; margin-bottom:10px; font-weight: 600;">${m.label}</div>
            <div style="display:flex; align-items:baseline; gap:8px; margin-bottom:10px;">
                <div style="font-size:28px; font-weight:bold; color:#111;">${formatCardValue(m.key, val)}</div>
                <div style="font-size:13px;" class="${changeClass}">${changeIcon} ${Math.abs(change).toFixed(1)}%</div>
            </div>
            <div style="font-size:11px; color:#999;">4ì£¼ í‰ê· : ${formatCardValue(m.key, cur)}</div>
        </div>`;
    });
    
    document.getElementById('budgetResults').innerHTML = html;
}

/* ============ Forecast ============ */
let forecastCharts = {};

function linearRegression(y) {
    const n = y.length;
    const x = Array.from({length: n}, (_, i) => i);
    const sumX = x.reduce((a, b) => a + b, 0);
    const sumY = y.reduce((a, b) => a + b, 0);
    const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
    const sumXX = x.reduce((sum, xi) => sum + xi * xi, 0);
    
    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    
    return {slope, intercept};
}

/* ============ Budget Slider Controls ============ */
let baseAvgCost = 0; // Store base average cost

function updateBudgetFromSlider() {
    const slider = document.getElementById('budgetSlider');
    const percent = parseInt(slider.value);
    document.getElementById('budgetPercentLabel').textContent = (percent >= 0 ? '+' : '') + percent + '%';
    
    if (baseAvgCost > 0) {
        const newBudget = Math.max(0, baseAvgCost * (1 + percent / 100));
        document.getElementById('budgetInput').value = Math.round(newBudget);
        updateBudgetSimulation();
    }
}

function updateBudgetFromInput() {
    const budget = parseFloat(document.getElementById('budgetInput').value) || 0;
    if (baseAvgCost > 0 && budget >= 0) {
        const percent = Math.round(((budget / baseAvgCost) - 1) * 100);
        const clampedPercent = Math.max(-100, Math.min(500, percent));
        document.getElementById('budgetSlider').value = clampedPercent;
        document.getElementById('budgetPercentLabel').textContent = (clampedPercent >= 0 ? '+' : '') + clampedPercent + '%';
    }
    updateBudgetSimulation();
}

function updateForecast() {
    if (!rawRows || rawRows.length === 0 || weeks.length < 4) return;
    
    // Get weekly aggregates
    const weeklyData = weeks.map(week => {
        const weekRows = rawRows.filter(r => r.week === week);
        return {
            week: week,
            cost: sum(weekRows, 'cost'),
            impressions: sum(weekRows, 'impressions'),
            clicks: sum(weekRows, 'clicks'),
            conversions: sum(weekRows, 'conversions'),
            revenue: sum(weekRows, 'revenue')
        };
    });
    
    // Calculate derived metrics
    weeklyData.forEach(w => {
        w.ctr = w.impressions > 0 ? (w.clicks / w.impressions) * 100 : 0;
        w.cvr = w.clicks > 0 ? (w.conversions / w.clicks) * 100 : 0;
        w.cpc = w.clicks > 0 ? w.cost / w.clicks : 0;
        w.cpa = w.conversions > 0 ? w.cost / w.conversions : 0;
        w.roas = w.cost > 0 ? (w.revenue / w.cost) * 100 : 0;
        w.aov = w.conversions > 0 ? w.revenue / w.conversions : 0;
        w.cor = w.revenue > 0 ? (w.cost / w.revenue) * 100 : 0;
    });
    
    const forecastMetrics = [
        {key: 'cost', label: 'ê´‘ê³ ë¹„', canvas: 'forecastCost'},
        {key: 'impressions', label: 'ë…¸ì¶œìˆ˜', canvas: 'forecastImpressions'},
        {key: 'clicks', label: 'í´ë¦­ìˆ˜', canvas: 'forecastClicks'},
        {key: 'conversions', label: 'ì „í™˜ìˆ˜', canvas: 'forecastConversions'},
        {key: 'revenue', label: 'ë§¤ì¶œì•¡', canvas: 'forecastRevenue'},
        {key: 'ctr', label: 'CTR', canvas: 'forecastCTR'},
        {key: 'cvr', label: 'CVR', canvas: 'forecastCVR'},
        {key: 'cpc', label: 'CPC', canvas: 'forecastCPC'},
        {key: 'cpa', label: 'CPA', canvas: 'forecastCPA'},
        {key: 'roas', label: 'ROAS', canvas: 'forecastROAS'},
        {key: 'aov', label: 'AOV', canvas: 'forecastAOV'},
        {key: 'cor', label: 'COR', canvas: 'forecastCOR'}
    ];
    
    forecastMetrics.forEach(metric => {
        const values = weeklyData.map(w => w[metric.key]);
        const regression = linearRegression(values);
        const nextWeekValue = regression.slope * values.length + regression.intercept;
        
        // Apply dampening factor to moderate extreme predictions
        // This prevents overly steep declines or growth predictions
        // Formula: forecast = current + (trend_change * dampening_factor)
        const current = values[values.length - 1];
        const trendChange = nextWeekValue - current;
        const dampenedForecast = current + (trendChange * 0.5); // 50% dampening
        
        // Ensure positive values
        const forecast = Math.max(0, dampenedForecast);
        const average = values.reduce((a, b) => a + b, 0) / values.length;
        const change = getChangeRate(forecast, current);
        
        // Create chart
        const ctx = document.getElementById(metric.canvas);
        if (forecastCharts[metric.key]) {
            forecastCharts[metric.key].destroy();
        }
        
        forecastCharts[metric.key] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [...weeks.map(w => w.substring(0, 10)), 'ë‹¤ìŒì£¼ ì˜ˆìƒ'],
                datasets: [{
                    label: metric.label,
                    data: [...values, forecast],
                    backgroundColor: [...weeks.map(() => '#5D9CEC'), '#FC6E51'],
                    borderColor: [...weeks.map(() => '#4A89DC'), '#E9573F'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {display: false},
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const val = context.parsed.y;
                                return metric.label + ': ' + formatCardValue(metric.key, val);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: (value) => {
                                if (['ctr', 'cvr', 'roas', 'cor'].includes(metric.key)) {
                                    return value.toFixed(1) + '%';
                                }
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
        
        // Update stats
        const statsHtml = `
            <div><strong>í˜„ì¬ í‰ê· :</strong> ${formatCardValue(metric.key, average)}</div>
            <div><strong>ë‹¤ìŒ ì£¼ ì˜ˆìƒ:</strong> ${formatCardValue(metric.key, forecast)}</div>
            <div class="${change >= 0 ? 'delta-up' : 'delta-down'}"><strong>ë³€í™”ìœ¨:</strong> ${change >= 0 ? '+' : ''}${change.toFixed(1)}%</div>
        `;
        document.getElementById(metric.canvas + 'Stats').innerHTML = statsHtml;
    });
}

/* ============ Day/Week Analysis ============ */
let dayweekMode = 'day'; // 'day' or 'week'
let dayweekCharts = {};

function setDayWeekMode(mode) {
    dayweekMode = mode;
    updateDayWeekAnalysis();
}

function updateDayWeekAnalysis() {
    if (!rawRows || rawRows.length === 0) return;
    
    let groupedData = {};
    
    if (dayweekMode === 'day') {
        // Group by day (date)
        rawRows.forEach(row => {
            const date = row.day; // Use day field for daily data
            if (!date) return; // Skip rows without a day field
            if (!groupedData[date]) {
                groupedData[date] = {cost: 0, impressions: 0, clicks: 0, conversions: 0, revenue: 0};
            }
            groupedData[date].cost += row.cost || 0;
            groupedData[date].impressions += row.impressions || 0;
            groupedData[date].clicks += row.clicks || 0;
            groupedData[date].conversions += row.conversions || 0;
            groupedData[date].revenue += row.revenue || 0;
        });
    } else {
        // Group by week
        weeks.forEach(week => {
            const weekRows = rawRows.filter(r => r.week === week);
            groupedData[week] = {
                cost: sum(weekRows, 'cost'),
                impressions: sum(weekRows, 'impressions'),
                clicks: sum(weekRows, 'clicks'),
                conversions: sum(weekRows, 'conversions'),
                revenue: sum(weekRows, 'revenue')
            };
        });
    }
    
    // Calculate derived metrics
    Object.keys(groupedData).forEach(key => {
        const d = groupedData[key];
        d.roas = d.cost > 0 ? (d.revenue / d.cost) * 100 : 0;
        d.ctr = d.impressions > 0 ? (d.clicks / d.impressions) * 100 : 0;
        d.cvr = d.clicks > 0 ? (d.conversions / d.clicks) * 100 : 0;
        d.cpc = d.clicks > 0 ? d.cost / d.clicks : 0;
        d.cpa = d.conversions > 0 ? d.cost / d.conversions : 0;
    });
    
    // Sort chronologically (oldest to newest)
    const labels = Object.keys(groupedData).sort();
    const data = labels.map(label => groupedData[label]);
    
    // Determine element ID prefix based on mode
    const idPrefix = dayweekMode === 'day' ? 'dayweek' : 'week';
    
    // Update summary cards
    updateDayWeekSummary(labels, data, idPrefix);
    
    // Update charts
    updateDayWeekCharts(labels, data, idPrefix);
    
    // Update table
    updateDayWeekTable(labels, data, idPrefix);
}

function updateDayWeekSummary(dateLabels, data, idPrefix = 'dayweek') {
    const metrics = ['cost', 'clicks', 'conversions', 'revenue', 'cpc', 'roas'];
    const labels = {
        cost: 'ê´‘ê³ ë¹„', 
        clicks: 'í´ë¦­ìˆ˜', 
        conversions: 'ì „í™˜ìˆ˜', 
        revenue: 'ë§¤ì¶œì•¡', 
        cpc: 'CPC', 
        roas: 'ROAS (%)'
    };
    
    let html = '';
    metrics.forEach(metric => {
        const values = data.map(d => d[metric]);
        const max = Math.max(...values);
        const min = Math.min(...values);
        const avg = values.reduce((a, b) => a + b, 0) / values.length;
        
        // Find the index (date) of the max, min values
        const maxIndex = values.indexOf(max);
        const maxDate = dateLabels[maxIndex] || '';
        const minIndex = values.indexOf(min);
        const minDate = dateLabels[minIndex] || '';
        
        // Calculate which date is closest to average
        let closestToAvgIndex = 0;
        let minDiff = Math.abs(values[0] - avg);
        values.forEach((v, i) => {
            const diff = Math.abs(v - avg);
            if (diff < minDiff) {
                minDiff = diff;
                closestToAvgIndex = i;
            }
        });
        const avgDate = dateLabels[closestToAvgIndex] || '';
        
        // Create bar chart data for visualization (show all values as bars) - NO WHITE BACKGROUND
        const barHtml = values.map((v, i) => {
            const height = max > 0 ? (v / max * 50) : 0; // Max height 50px
            const isMax = v === max;
            const isMin = v === min;
            let color = '#bbb';
            if (isMax) color = '#2e8b57';
            else if (isMin) color = '#c0392b';
            return `<div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div style="width: 100%; height: ${height}px; background: ${color}; border-radius: 2px 2px 0 0;"></div>
            </div>`;
        }).join('');
        
        html += `
            <div style="background: #f9fafb; border: 1px solid #e3e6ea; border-radius: 8px; padding: 20px;">
                <div style="font-size: 15px; font-weight: bold; color: #333; margin-bottom: 15px;">${labels[metric]}</div>
                <div style="font-size: 13px; color: #555; margin-bottom: 8px;">ìµœê³ : <strong style="color: #2e8b57; font-size: 16px;">${formatCardValue(metric, max)} (${maxDate})</strong></div>
                <div style="font-size: 13px; color: #555; margin-bottom: 8px;">ìµœì €: <strong style="color: #c0392b; font-size: 16px;">${formatCardValue(metric, min)} (${minDate})</strong></div>
                <div style="font-size: 13px; color: #555; margin-bottom: 12px;">í‰ê· : <strong style="color: #333; font-size: 16px;">${formatCardValue(metric, avg)} (${avgDate})</strong></div>
                <div style="display: flex; gap: 2px; align-items: flex-end; height: 55px; padding: 5px;">
                    ${barHtml}
                </div>
            </div>
        `;
    });
    
    const summaryElement = document.getElementById(idPrefix + 'Summary');
    if (summaryElement) {
        summaryElement.innerHTML = html;
    }
}

function updateDayWeekCharts(labels, data, idPrefix = 'dayweek') {
    const chartConfigs = [
        {id: 'CostChart', metric: 'cost', label: 'ê´‘ê³ ë¹„', color: '#5D9CEC'},
        {id: 'ClicksChart', metric: 'clicks', label: 'í´ë¦­ìˆ˜', color: '#A0D468'},
        {id: 'ConvChart', metric: 'conversions', label: 'ì „í™˜ìˆ˜', color: '#FFCE54'},
        {id: 'RevenueChart', metric: 'revenue', label: 'ë§¤ì¶œì•¡', color: '#48CFAD'},
        {id: 'CPCChart', metric: 'cpc', label: 'CPC', color: '#AC92EC'},
        {id: 'ROASChart', metric: 'roas', label: 'ROAS', color: '#FC6E51'}
    ];
    
    chartConfigs.forEach(config => {
        const chartId = idPrefix + config.id;
        const ctx = document.getElementById(chartId);
        if (!ctx) return;
        
        if (dayweekCharts[chartId]) {
            dayweekCharts[chartId].destroy();
        }
        
        dayweekCharts[chartId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: config.label,
                    data: data.map(d => d[config.metric]),
                    borderColor: config.color,
                    backgroundColor: config.color + '33',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {display: false},
                    tooltip: {
                        callbacks: {
                            label: (context) => config.label + ': ' + formatCardValue(config.metric, context.parsed.y)
                        }
                    },
                    datalabels: {
                        display: true,
                        align: 'top',
                        color: '#333',
                        font: {
                            size: 10,
                            weight: 'bold'
                        },
                        formatter: (value) => formatCardValue(config.metric, value)
                    }
                },
                scales: {
                    y: {
                        display: false, // Hide Y-axis
                        beginAtZero: true
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    });
}

function updateDayWeekTable(labels, data, idPrefix = 'dayweek') {
    // Calculate totals
    const totals = {
        cost: data.reduce((sum, d) => sum + d.cost, 0),
        impressions: data.reduce((sum, d) => sum + d.impressions, 0),
        clicks: data.reduce((sum, d) => sum + d.clicks, 0),
        conversions: data.reduce((sum, d) => sum + d.conversions, 0),
        revenue: data.reduce((sum, d) => sum + d.revenue, 0)
    };
    totals.ctr = totals.impressions > 0 ? (totals.clicks / totals.impressions) * 100 : 0;
    totals.cvr = totals.clicks > 0 ? (totals.conversions / totals.clicks) * 100 : 0;
    totals.cpc = totals.clicks > 0 ? totals.cost / totals.clicks : 0;
    totals.cpa = totals.conversions > 0 ? totals.cost / totals.conversions : 0;
    totals.roas = totals.cost > 0 ? (totals.revenue / totals.cost) * 100 : 0;
    
    // Calculate averages (4-week average)
    const count = data.length;
    const averages = {
        cost: count > 0 ? totals.cost / count : 0,
        impressions: count > 0 ? totals.impressions / count : 0,
        clicks: count > 0 ? totals.clicks / count : 0,
        conversions: count > 0 ? totals.conversions / count : 0,
        revenue: count > 0 ? totals.revenue / count : 0,
        ctr: count > 0 ? totals.ctr : 0,
        cvr: count > 0 ? totals.cvr : 0,
        cpc: count > 0 ? totals.cpc : 0,
        cpa: count > 0 ? totals.cpa : 0,
        roas: count > 0 ? totals.roas : 0
    };
    
    const tableId = idPrefix + 'DataTable';
    let html = `
        <table class="data-table" id="${tableId}">
            <thead>
                <tr>
                    <th>${dayweekMode === 'day' ? 'ë‚ ì§œ' : 'ì£¼'}</th>
                    <th>ê´‘ê³ ë¹„</th>
                    <th class="growth-rate-col">ì¦ê°ìœ¨</th>
                    <th>ë…¸ì¶œìˆ˜</th>
                    <th class="growth-rate-col">ì¦ê°ìœ¨</th>
                    <th>í´ë¦­ìˆ˜</th>
                    <th class="growth-rate-col">ì¦ê°ìœ¨</th>
                    <th>ì „í™˜ìˆ˜</th>
                    <th class="growth-rate-col">ì¦ê°ìœ¨</th>
                    <th>ë§¤ì¶œì•¡</th>
                    <th class="growth-rate-col">ì¦ê°ìœ¨</th>
                    <th>CTR (%)</th>
                    <th class="growth-rate-col">ì¦ê°ìœ¨</th>
                    <th>CVR (%)</th>
                    <th class="growth-rate-col">ì¦ê°ìœ¨</th>
                    <th>CPC</th>
                    <th class="growth-rate-col">ì¦ê°ìœ¨</th>
                    <th>CPA</th>
                    <th class="growth-rate-col">ì¦ê°ìœ¨</th>
                    <th>ROAS (%)</th>
                    <th class="growth-rate-col">ì¦ê°ìœ¨</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    // Helper function to calculate growth rate
    const calcGrowth = (current, previous) => {
        if (!previous || previous === 0) return '-';
        const change = ((current - previous) / previous) * 100;
        const color = change >= 0 ? '#2e8b57' : '#c0392b';
        const symbol = change >= 0 ? '+' : '';
        return `<span style="color: ${color}; font-weight: bold; font-size: 11px;">${symbol}${change.toFixed(1)}%</span>`;
    };
    
    // Add average row at the top
    const avgLabel = dayweekMode === 'day' ? 'ì¼ í‰ê· ' : 'í‰ê·  (4ì£¼)';
    html += `
            <tr style="background: #fff3cd; font-weight: bold; border-bottom: 2px solid #ffc107;">
                <td><strong>${avgLabel}</strong></td>
                <td>${formatCardValue('cost', averages.cost)}</td>
                <td class="growth-rate-col">-</td>
                <td>${formatCardValue('impressions', averages.impressions)}</td>
                <td class="growth-rate-col">-</td>
                <td>${formatCardValue('clicks', averages.clicks)}</td>
                <td class="growth-rate-col">-</td>
                <td>${formatCardValue('conversions', averages.conversions)}</td>
                <td class="growth-rate-col">-</td>
                <td>${formatCardValue('revenue', averages.revenue)}</td>
                <td class="growth-rate-col">-</td>
                <td>${averages.ctr.toFixed(2)}%</td>
                <td class="growth-rate-col">-</td>
                <td>${averages.cvr.toFixed(2)}%</td>
                <td class="growth-rate-col">-</td>
                <td>${formatCardValue('cpc', averages.cpc)}</td>
                <td class="growth-rate-col">-</td>
                <td>${formatCardValue('cpa', averages.cpa)}</td>
                <td class="growth-rate-col">-</td>
                <td style="color: ${averages.roas >= 100 ? '#2e8b57' : '#c0392b'}; font-weight: bold;">${averages.roas.toFixed(1)}%</td>
                <td class="growth-rate-col">-</td>
            </tr>
    `;
    
    labels.forEach((label, idx) => {
        const d = data[idx];
        const prev = idx > 0 ? data[idx - 1] : null;
        
        html += `
            <tr>
                <td><strong>${label}</strong></td>
                <td>${formatCardValue('cost', d.cost)}</td>
                <td class="growth-rate-col">${prev ? calcGrowth(d.cost, prev.cost) : '-'}</td>
                <td>${formatCardValue('impressions', d.impressions)}</td>
                <td class="growth-rate-col">${prev ? calcGrowth(d.impressions, prev.impressions) : '-'}</td>
                <td>${formatCardValue('clicks', d.clicks)}</td>
                <td class="growth-rate-col">${prev ? calcGrowth(d.clicks, prev.clicks) : '-'}</td>
                <td>${formatCardValue('conversions', d.conversions)}</td>
                <td class="growth-rate-col">${prev ? calcGrowth(d.conversions, prev.conversions) : '-'}</td>
                <td>${formatCardValue('revenue', d.revenue)}</td>
                <td class="growth-rate-col">${prev ? calcGrowth(d.revenue, prev.revenue) : '-'}</td>
                <td>${d.ctr.toFixed(2)}%</td>
                <td class="growth-rate-col">${prev ? calcGrowth(d.ctr, prev.ctr) : '-'}</td>
                <td>${d.cvr.toFixed(2)}%</td>
                <td class="growth-rate-col">${prev ? calcGrowth(d.cvr, prev.cvr) : '-'}</td>
                <td>${formatCardValue('cpc', d.cpc)}</td>
                <td class="growth-rate-col">${prev ? calcGrowth(d.cpc, prev.cpc) : '-'}</td>
                <td>${formatCardValue('cpa', d.cpa)}</td>
                <td class="growth-rate-col">${prev ? calcGrowth(d.cpa, prev.cpa) : '-'}</td>
                <td style="color: ${d.roas >= 100 ? '#2e8b57' : '#c0392b'}; font-weight: bold;">${d.roas.toFixed(1)}%</td>
                <td class="growth-rate-col">${prev ? calcGrowth(d.roas, prev.roas) : '-'}</td>
            </tr>
        `;
    });
    
    // Add total row
    html += `
            <tr style="background: #f0f7ff; font-weight: bold; border-top: 2px solid #007bff;">
                <td><strong>Total</strong></td>
                <td>${formatCardValue('cost', totals.cost)}</td>
                <td class="growth-rate-col">-</td>
                <td>${formatCardValue('impressions', totals.impressions)}</td>
                <td class="growth-rate-col">-</td>
                <td>${formatCardValue('clicks', totals.clicks)}</td>
                <td class="growth-rate-col">-</td>
                <td>${formatCardValue('conversions', totals.conversions)}</td>
                <td class="growth-rate-col">-</td>
                <td>${formatCardValue('revenue', totals.revenue)}</td>
                <td class="growth-rate-col">-</td>
                <td>${totals.ctr.toFixed(2)}%</td>
                <td class="growth-rate-col">-</td>
                <td>${totals.cvr.toFixed(2)}%</td>
                <td class="growth-rate-col">-</td>
                <td>${formatCardValue('cpc', totals.cpc)}</td>
                <td class="growth-rate-col">-</td>
                <td>${formatCardValue('cpa', totals.cpa)}</td>
                <td class="growth-rate-col">-</td>
                <td style="color: ${totals.roas >= 100 ? '#2e8b57' : '#c0392b'}; font-weight: bold;">${totals.roas.toFixed(1)}%</td>
                <td class="growth-rate-col">-</td>
            </tr>
    `;
    
    html += '</tbody></table>';
    const tableElement = document.getElementById(idPrefix + 'Table');
    if (tableElement) {
        tableElement.innerHTML = html;
    }
}

function toggleDayWeekGrowthRate() {
    const cols = document.querySelectorAll('#dayweekDataTable .growth-rate-col');
    const isHidden = cols[0].style.display === 'none';
    cols.forEach(col => {
        col.style.display = isHidden ? '' : 'none';
    });
}

function toggleWeekGrowthRate() {
    const cols = document.querySelectorAll('#weekDataTable .growth-rate-col');
    const isHidden = cols[0].style.display === 'none';
    cols.forEach(col => {
        col.style.display = isHidden ? '' : 'none';
    });
}


</script>
</body>
</html>
